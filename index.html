<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø±Ø¨ Ø­Ø¸Ùƒ - Ø´Ø­Ù† Ø±Ø³Ù…ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙˆØªØ£Ø«ÙŠØ± Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù„Ù…Ø­ÙŠØ·Ø© - ÙŠØ³ØªØ®Ø¯Ù… Ø®Ø·ÙˆØ· iOS Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
        :root {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background: linear-gradient(135deg, #1f2937, #000000, #1f2937);
        }
        /* ØªØµÙ…ÙŠÙ… Ø¨ÙƒØ±Ø© Ø§Ù„Ø³Ù„ÙˆØª (Reel) Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ */
        .slot-container { 
            perspective: 500px; 
            height: 120px; 
            width: 100%; 
            overflow: hidden; 
            border-radius: 12px; 
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1), inset 0 0 10px rgba(0, 0, 0, 0.9); 
        }
        .slot-reel { 
            transform-style: preserve-3d; 
            /* ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ù…Ø¯Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø­Ø±ÙƒØ© Ø¨Ø§Ù„Ø¨Ø¯Ø¡ */
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            position: relative; 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .slot-item { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 120px; 
            font-size: 3.5rem; 
            color: #fcd34d; 
            width: 100%; 
            background-color: #0d1117; 
            border-bottom: 1px solid #374151; 
            box-sizing: border-box; 
        }
        /* Ø­Ø±ÙƒØ© Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (Spinning Animation) */
        @keyframes fast-spin { 
            0% { transform: translateY(0); }
            100% { transform: translateY(-80%); } 
        }
        .spinning { 
            animation: fast-spin 0.1s linear infinite; 
        }
        /* Ù†Ù…Ø· Ø²Ø± Ø§Ù„ÙØ± (Spin) */
        .btn-spin { 
            background: linear-gradient(145deg, #ef4444, #b91c1c); 
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6); 
            transition: all 0.2s ease; 
        }
        .btn-spin:hover { 
            transform: translateY(-3px) scale(1.02); 
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.8); 
        }
        .btn-spin:disabled { 
            background: #4b5563; 
            box-shadow: none; 
            cursor: not-allowed; 
            transform: none; 
        }
        /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Toast) */
        #toast-notification { 
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; 
            opacity: 0; 
            transform: translateY(100%); 
            z-index: 1000; 
        }
        .toast-visible { 
            opacity: 1 !important; 
            transform: translateY(0) !important; 
        }
        .game-area-glow { 
            box-shadow: 0 0 50px rgba(253, 224, 71, 0.2), 0 0 100px rgba(253, 224, 71, 0.1); 
        }
        #charge-modal { 
            opacity: 0; 
            transition: opacity 0.3s ease; 
        }
        #modal-content { 
            transform: scale(0.9); 
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-md bg-gray-900 p-8 rounded-3xl shadow-2xl border-4 border-yellow-500 game-area-glow">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-black text-white">Ø¬Ø±Ø¨ Ø­Ø¸Ùƒ! ğŸ€</h1>
             <button id="star-balance-button" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-extrabold py-2 px-4 rounded-full shadow-lg transition" onclick="toggleChargeModal(true)">
                Ø§Ù„Ø±ØµÙŠØ¯: <span id="star-balance">0</span> â­
            </button>
        </div>
       
        <p class="text-gray-400 text-center mb-6">ğŸ° ÙÙØ± Ø¨Ù€ 1 Ù†Ø¬Ù…Ø© ÙˆØ§ÙÙˆØ² Ø¨Ù€ 25 Ù†Ø¬Ù…Ø©</p>

        <div class="flex justify-between items-center bg-gray-800 p-4 rounded-xl mb-6 shadow-inner border border-gray-700">
            <div>
                <span class="text-sm font-light text-gray-400 block">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø§Ù„Ø¨ÙˆØª):</span>
                <span id="user-id-display" class="text-xs font-mono text-blue-400 block mt-1 break-all">...</span>
            </div>
            <div>
                <span class="text-sm font-light text-gray-400 block">Ø£ÙØ¶Ù„ ÙÙˆØ²:</span>
                <span id="high-score" class="text-xl font-bold text-red-400 block mt-1">0 â­</span>
            </div>
        </div>
        
        <div class="flex justify-around space-x-3 mb-8">
            <div class="slot-container w-1/3"><div id="reel-1" class="slot-reel"></div></div>
            <div class="slot-container w-1/3"><div id="reel-2" class="slot-reel"></div></div>
            <div class="slot-container w-1/3"><div id="reel-3" class="slot-reel"></div></div>
        </div>

        <div id="message-area" class="text-center text-xl font-bold h-8 flex items-center justify-center mb-6">
            <span class="text-gray-300">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
        </div>

        <button id="spin-button" class="w-full py-4 text-white text-2xl font-extrabold rounded-2xl uppercase btn-spin" onclick="spinSlot()" disabled>
            Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©...
        </button>
        
        <div class="mt-6">
            <h3 class="text-lg font-semibold text-gray-300 mb-2 border-b border-gray-700 pb-1">Ø³Ø¬Ù„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø£Ø®ÙŠØ±</h3>
            <ul id="log-list" class="text-sm text-gray-400 space-y-1 h-20 overflow-y-auto">
                <li class="text-center italic">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¨Ø¹Ø¯...</li>
            </ul>
        </div>

    </div>

    <div id="charge-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 backdrop-blur-sm hidden items-center justify-center z-50 p-4" style="opacity: 0;">
        <div class="bg-gray-800 p-8 rounded-3xl w-full max-w-lg shadow-2xl border-4 border-green-500 transition-transform duration-300" id="modal-content">
            <h2 class="text-3xl font-bold text-green-400 text-center mb-5">ğŸ’¸ Ø®ÙŠØ§Ø±Ø§Øª Ø´Ø­Ù† Ø§Ù„Ù†Ø¬ÙˆÙ… ğŸ’¸</h2>
            <p class="text-gray-300 text-center mb-6">
                Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…ÙŠØ©ØŒ Ø³ÙŠØªÙ… Ù†Ù‚Ù„Ùƒ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹. Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹ØŒ **ÙŠØ¬Ø¨** Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø¨ÙˆØª Ø¨Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ: 
                <span id="modal-user-id" class="text-blue-300 font-mono break-all text-sm block mt-2">...</span>
            </p>
            
            <div id="charge-options-container" class="grid grid-cols-3 gap-4">
                </div>
            
            <button class="w-full mt-6 py-3 bg-gray-700 text-gray-300 rounded-xl hover:bg-gray-600 transition" onclick="toggleChargeModal(false)">
                Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
            </button>
        </div>
    </div>

    <div id="toast-notification" class="fixed bottom-4 right-4 sm:bottom-8 sm:right-8 z-50 p-4 bg-gray-900 text-white text-base font-medium rounded-xl shadow-2xl transition duration-500 opacity-0 transform translate-y-full">
        </div>

    <script type="module">
        // ------------------------------------------
        // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        // ------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Ù…ØªØºÙŠØ±Ø§Øª Firebase Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© ÙÙŠ Ø¨ÙŠØ¦Ø© Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Ù…Ø³Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
        let DB_PATH = '';
        const DB_COLLECTION = 'game_data';
        const DB_DOCUMENT = 'slot_machine';

        let db = null;
        let auth = null;
        let currentUserId = null;
        let isAuthReady = false;
        
        // ------------------------------------------
        // 2. Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø±Ø³Ù…ÙŠØ©
        // ------------------------------------------
        let starBalance = 0;
        let highScore = 0;
        let playCount = 0; // *** Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª ***
        const spinCost = 1;
        const winAmount = 25;
        // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…ÙˆØ² Ø¥Ù„Ù‰ Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ø¢ÙŠÙÙˆÙ† (Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹)
        const symbols = ['ğŸ', 'ğŸ’°', 'ğŸ’', 'ğŸ””', 'ğŸ€', 'ğŸ’', '7ï¸âƒ£'];
        const winSymbol = '7ï¸âƒ£';

        const starLinks = [
            { amount: 5, link: 'https://t.me/$RxpsOzzsKEggFAAAroXTcLJE0us' },
            { amount: 10, link: 'https://t.me/$xhKz4jzsKEgiFAAA7-bW0jENam0' },
            { amount: 15, link: 'https://t.me/$8MLAUjzsKEgkFAAAmvIl7afDebE' },
            { amount: 25, link: 'https://t.me/$OGkpxTzsKEgmFAAAJjI6la2LS0w' },
            { amount: 50, link: 'https://t.me/$4vbK7DzsKEgoFAAA1nL9QpnQ3gM' },
            { amount: 75, link: 'https://t.me/$P1qaxTzsKEgqFAAAUhLMFkIZBkc' },
            { amount: 100, link: 'https://t.me/$HSElFDzsKEgsFAAAgCp11iTuimg' },
            { amount: 115, link: 'https://t.me/$0rQkXDzsKEguFAAA3tsBKRFKGEI' },
            { amount: 130, link: 'https://t.me/$_U1fezzsKEgwFAAAzmp7Z0tlFAw' },
            { amount: 150, link: 'https://t.me/$6dYohjzsKEgyFAAAWyc5eGWn3zM' },
        ];


        // ------------------------------------------
        // 3. Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ DOM
        // ------------------------------------------
        const balanceElement = document.getElementById('star-balance');
        const spinButton = document.getElementById('spin-button');
        const messageArea = document.getElementById('message-area');
        const reels = [
            document.getElementById('reel-1'),
            document.getElementById('reel-2'),
            document.getElementById('reel-3')
        ];
        const chargeModal = document.getElementById('charge-modal');
        const modalContent = document.getElementById('modal-content');
        const toastElement = document.getElementById('toast-notification');
        const logList = document.getElementById('log-list');
        const highScoreElement = document.getElementById('high-score');
        const userIdDisplay = document.getElementById('user-id-display');
        const modalUserId = document.getElementById('modal-user-id');
        const chargeOptionsContainer = document.getElementById('charge-options-container');

        
        // ------------------------------------------
        // 4. ÙˆØ¸Ø§Ø¦Ù Firestore
        // ------------------------------------------

        function setupDbPath(userId) {
            // Ø§Ù„Ù…Ø³Ø§Ø±: /artifacts/{appId}/users/{userId}/game_data/slot_machine
            DB_PATH = `artifacts/${appId}/users/${userId}/${DB_COLLECTION}/${DB_DOCUMENT}`;
            return DB_PATH;
        }

        async function fetchInitialData() {
            if (!isAuthReady || !currentUserId) return;

            const userDocRef = doc(db, setupDbPath(currentUserId));
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                starBalance = data.balance || 0;
                highScore = data.highScore || 0;
                playCount = data.playCount || 0; // *** Ù‚Ø±Ø§Ø¡Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª ***
            } else {
                await setDoc(userDocRef, { balance: 0, highScore: 0, playCount: 0, created: new Date().toISOString() });
                starBalance = 0;
                highScore = 0;
                playCount = 0; // *** ØªÙ‡ÙŠØ¦Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª ***
            }

            updateUI('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
            setupRealtimeListener(); 
            spinButton.disabled = starBalance < spinCost;
            spinButton.textContent = starBalance < spinCost ? 'Ø§Ù„Ø±ØµÙŠØ¯ 0! Ø¥Ø¶ØºØ· Ù„Ù„Ø´Ø­Ù†' : 'Ø¥Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† Ø¨Ù€ 1 â­';
            messageArea.innerHTML = '<span class="text-gray-300">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø¨!</span>';
        }

        function setupRealtimeListener() {
            if (!isAuthReady || !currentUserId) return;

            const userDocRef = doc(db, setupDbPath(currentUserId));
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const oldBalance = starBalance;
                    const data = docSnap.data();
                    starBalance = data.balance || 0;
                    highScore = data.highScore || 0;
                    playCount = data.playCount || 0; // *** ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ***
                    
                    if (starBalance > oldBalance && oldBalance !== 0) {
                         const increase = starBalance - oldBalance;
                         if (increase > 0) {
                            showToast(`ğŸ’° ØªÙ… Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­! +${increase} â­`, 'success');
                            messageArea.innerHTML = `<span class="text-green-400 font-bold">Ø´Ø­Ù† Ù…ÙƒØªÙ…Ù„! +${increase} â­</span>`;
                         }
                    }

                    updateUI();
                }
            });
        }

        async function updateBalanceInDb(newBalance, newHighScore, newPlayCount) { // *** ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù‚Ø¨ÙˆÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª ***
            if (!isAuthReady || !currentUserId) return;
            const userDocRef = doc(db, setupDbPath(currentUserId));
            try {
                await setDoc(userDocRef, { 
                    balance: newBalance,
                    highScore: newHighScore,
                    playCount: newPlayCount, // *** Ø­ÙØ¸ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ***
                }, { merge: true });
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Firestore:", error);
                showToast("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.", 'error');
            }
        }
        
        // ------------------------------------------
        // 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù„Ø¹Ø¨Ø©
        // ------------------------------------------

        function updateUI(logMessage = null) {
            balanceElement.textContent = `${starBalance.toLocaleString()}`;
            highScoreElement.textContent = `${highScore.toLocaleString()} â­`;
            userIdDisplay.textContent = currentUserId || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            modalUserId.textContent = currentUserId || '...';
            
            // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯
            if (isAuthReady) {
                 spinButton.disabled = starBalance < spinCost;
                 if (starBalance < spinCost) {
                    spinButton.textContent = 'Ø§Ù„Ø±ØµÙŠØ¯ 0! Ø¥Ø¶ØºØ· Ù„Ù„Ø´Ø­Ù†';
                 } else if (spinButton.textContent.includes('Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø­Ø¸Ùƒ') === false) {
                     spinButton.textContent = 'Ø¥Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† Ø¨Ù€ 1 â­';
                 }
            }

            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­
            if (logMessage) {
                const li = document.createElement('li');
                li.innerHTML = `<span class="text-sm text-gray-500">${new Date().toLocaleTimeString()}</span>: ${logMessage}`;
                logList.prepend(li);
                if (logList.lastElementChild && logList.lastElementChild.classList.contains('italic')) {
                    logList.removeChild(logList.lastElementChild);
                }
                while (logList.children.length > 5) {
                    logList.removeChild(logList.lastElementChild);
                }
            }
        }

        function showToast(message, type = 'info') {
            toastElement.innerHTML = `<span class="text-sm">${message}</span>`;
            toastElement.classList.remove('bg-gray-900', 'bg-red-500', 'bg-green-500');

            let bgColor = 'bg-gray-900';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';

            toastElement.classList.add(bgColor, 'toast-visible', 'opacity-100', 'translate-y-0');
            
            setTimeout(() => {
                toastElement.classList.remove('opacity-100', 'translate-y-0');
            }, 3000); 
        }

        function toggleChargeModal(show) {
            if (show) {
                chargeModal.classList.remove('hidden');
                setTimeout(() => {
                    chargeModal.style.opacity = '1';
                    modalContent.style.transform = 'scale(1)';
                }, 10);
            } else {
                chargeModal.style.opacity = '0';
                modalContent.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    chargeModal.classList.add('hidden');
                }, 300);
            }
        }

        function setupReels() {
            reels.forEach(reel => {
                reel.innerHTML = '';
                for(let i = 0; i < 30; i++) {
                    const item = document.createElement('div');
                    item.className = 'slot-item';
                    item.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                    reel.appendChild(item);
                }
            });
        }

        function populateChargeOptions() {
            chargeOptionsContainer.innerHTML = '';
            starLinks.forEach(item => {
                const button = document.createElement('a');
                const amountFormatted = item.amount.toLocaleString();
                button.className = 'charge-option bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-extrabold text-xl transition shadow-lg text-center block';
                button.href = item.link;
                button.target = '_blank'; // ÙŠÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø¹Ù„Ø§Ù…Ø© ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯Ø©
                button.textContent = `${amountFormatted} â­`;
                
                button.addEventListener('click', () => {
                    showToast(`âœ… ØªÙ… ÙØªØ­ Ø±Ø§Ø¨Ø· ${amountFormatted} â­. Ø§Ù†ØªØ¸Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙˆØª.`);
                    toggleChargeModal(false);
                });

                chargeOptionsContainer.appendChild(button);
            });
        }

        // *** Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙØ§Ø¦Ø² Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª ***
        function getWinSymbol(winProbability, guarantee777) {
            const random = Math.random();
            // Ù†Ø³Ø¨Ø© ÙÙˆØ² Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø«Ù„Ø§Ø«ÙŠØ© (10 Ù„Ù€ 777, 30 Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø±Ù…ÙˆØ²)
            const tripleWinChance = 0.1; 
            
            if (guarantee777) {
                 // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø³Ø¨Ø© 80%ØŒ Ù†Ø¶Ù…Ù† Ø§Ù„Ù€ 777
                return [winSymbol, winSymbol, winSymbol];
            } else if (random < winProbability) {
                // Ø­Ø¯Ø« Ø§Ù„ÙÙˆØ²!
                if (Math.random() < tripleWinChance) {
                     // ÙÙˆØ² Ø¨Ø¬Ø§Ø¦Ø²Ø© ÙƒØ¨Ø±Ù‰ (777) Ø¨Ù†Ø³Ø¨Ø© 10% Ù…Ù† Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ² Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
                    return [winSymbol, winSymbol, winSymbol];
                } else {
                    // ÙÙˆØ² Ø¨Ø«Ù„Ø§Ø«Ø© Ø±Ù…ÙˆØ² Ù…ØªØ·Ø§Ø¨Ù‚Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø£Ø®Ø±Ù‰
                    const randomWinSymbol = symbols[Math.floor(Math.random() * (symbols.length - 1))]; // Ù†Ø³ØªØ«Ù†ÙŠ 777
                    return [randomWinSymbol, randomWinSymbol, randomWinSymbol];
                }
            } else {
                // Ø­Ø¯Ø« Ø§Ù„Ø®Ø³Ø§Ø±Ø©: Ø±Ù…ÙˆØ² Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ø®ØªÙ„ÙØ©
                let results = [];
                for (let i = 0; i < 3; i++) {
                     // Ù†Ø¶Ù…Ù† Ø£Ù† Ù„Ø§ ØªÙƒÙˆÙ† Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ù…ØªØ·Ø§Ø¨Ù‚Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø³Ø§Ø±Ø©
                     let symbol = symbols[Math.floor(Math.random() * symbols.length)];
                     // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø³Ø§Ø±Ø©
                     if (i === 2 && results[0] === results[1] && results[0] === symbol) {
                         symbol = symbols[(symbols.indexOf(symbol) + 1) % symbols.length];
                     }
                     results.push(symbol);
                }
                return results;
            }
        }
        
        async function spinSlot() {
            if (starBalance < spinCost) {
                toggleChargeModal(true);
                return;
            }

            // 1. Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²
            let winProbability = 0;
            let guarantee777 = false;

            if (playCount <= 1) { // Ø£ÙˆÙ„ Ù…Ø±Ø©
                winProbability = 0.8; // 80%
                guarantee777 = true; // Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± 777 Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
            } else if (playCount >= 2 && playCount <= 4) { // 3 Ù…Ø´Ø§Ø±ÙƒØ§Øª (Ø¨Ø§Ù„Ø¶Ø¨Ø· 2 Ùˆ 3 Ùˆ 4)
                winProbability = 0.5; // 50%
            } else if (playCount >= 5) { // ÙÙˆÙ‚ 5 Ù…Ø´Ø§Ø±ÙƒØ§Øª
                // ØªØ®Ù…ÙŠÙ† Ø¨ÙŠÙ† 90% Ùˆ 35%
                winProbability = Math.random() < 0.5 ? 0.9 : 0.35; 
            }
            
            // 2. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            const finalSymbols = getWinSymbol(winProbability, guarantee777);
            
            // 3. Ø®ØµÙ… Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª
            starBalance -= spinCost;
            playCount += 1; // *** Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª ***
            // Ù„Ø§ Ù†Ù†ØªØ¸Ø± Ù‡Ù†Ø§ØŒ Ù†Ø±Ø³Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø«Ù… Ù†ÙˆØ§ØµÙ„ Ø§Ù„Ø­Ø±ÙƒØ© Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
            updateBalanceInDb(starBalance, highScore, playCount); 
            updateUI(`Ø®ØµÙ…: ${spinCost} â­ Ù„Ù„Ù‘Ø¹Ø¨`);

            spinButton.disabled = true;
            spinButton.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø­Ø¸Ùƒ...';
            messageArea.innerHTML = '<span class="text-yellow-400 font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙÙØ±... ğŸ°</span>';

            const finalStopTimes = [];

            reels.forEach((reel, index) => {
                const resultSymbol = finalSymbols[index];
                // ØªØ£Ø®ÙŠØ± Ø§Ù„ØªÙˆÙ‚Ù Ù…ØªØ²Ø§ÙŠØ¯ Ù‚Ù„ÙŠÙ„Ø§
                const stopTime = 2500 + (index * 700) + Math.random() * 300; 
                finalStopTimes.push(stopTime);

                // *** Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‡Ù†Ø§: Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Transition ÙˆØªØ·Ø¨ÙŠÙ‚ Ø­Ø±ÙƒØ© Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø³Ø±ÙŠØ¹ ***
                reel.style.transition = 'none'; 
                reel.style.transform = `translateY(0)`; 
                reel.classList.add('spinning');
                
                // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªÙˆÙ‚Ù
                setTimeout(() => {
                    reel.classList.remove('spinning');
                    
                    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø³Ù„Ø³ Ù„Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (2 Ø«Ø§Ù†ÙŠØ©)
                    reel.style.transition = 'transform 2s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø²Ø§Ø­Ø© (Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ­Ø±ÙŠÙƒÙ‡ Ù…Ø³Ø§ÙØ© ÙƒØ¨ÙŠØ±Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© + Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙØ§Ø¦Ø²)
                    const symbolsCountForDisplay = 30;
                    const finalIndex = symbolsCountForDisplay - 2; 
                    
                    // Ù†Ø¶Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ
                    reel.children[finalIndex].textContent = resultSymbol;
                    
                    // ØªØ­Ø±ÙŠÙƒ Reel Ø¥Ù„Ù‰ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
                    const finalPosition = finalIndex * 120 + 3 * 120; // Ø¥Ø¶Ø§ÙØ© 3 Ù…Ø±Ø§Øª Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¨ÙƒØ±Ø© Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¯ÙˆØ±Ø§Ù†
                    reel.style.transform = `translateY(-${finalPosition}px)`;
                }, stopTime);
            });

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø¹Ø¯ ØªÙˆÙ‚Ù Ø§Ù„Ø¨ÙƒØ±Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©
            const longestStop = Math.max(...finalStopTimes);
            setTimeout(() => {
                checkWin(finalSymbols);
            }, longestStop + 500); 
        }

        async function checkWin(results) {
            spinButton.disabled = false;
            spinButton.textContent = 'Ø¥Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† Ø¨Ù€ 1 â­';
            
            let win = 0;
            const isTriple = results[0] === results[1] && results[1] === results[2];
            const isTriple7 = isTriple && results[0] === winSymbol;

            if (isTriple7) {
                win = winAmount;
                starBalance += win;
                messageArea.innerHTML = `<span class="text-3xl font-black text-yellow-300 animate-pulse">ğŸ’° ÙÙˆØ² MEGA! +${win} â­</span>`;
                showToast(`ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ÙØ²Øª Ø¨Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰: ${win} Ù†Ø¬Ù…Ø©!`, 'success');
                updateUI(`ÙÙˆØ² ÙƒØ¨ÙŠØ±: +${win} â­`);
            } else if (isTriple) {
                win = 10; 
                starBalance += win;
                messageArea.innerHTML = `<span class="text-2xl font-bold text-lime-400">âœ¨ ÙÙˆØ² Ø«Ù„Ø§Ø«ÙŠ! +${win} â­</span>`;
                showToast(`ğŸ† ÙÙˆØ² ØµØºÙŠØ±! ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${win} Ù†Ø¬Ù…Ø©.`, 'success');
                updateUI(`ÙÙˆØ² ØµØºÙŠØ±: +${win} â­`);
            } else {
                messageArea.innerHTML = '<span class="text-red-500 font-bold">ğŸ˜” Ù„Ù… ÙŠØ­Ø§Ù„ÙÙƒ Ø§Ù„Ø­Ø¸. Ø¬Ø±Ø¨ Ø«Ø§Ù†ÙŠØ©!</span>';
                showToast('Ù„Ù… ØªÙØ² Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©. Ø­Ø¸ Ø£ÙˆÙØ±!');
                updateUI(`Ø®Ø³Ø§Ø±Ø©: -${spinCost} â­`);
            }
            
            if (starBalance > highScore) {
                highScore = starBalance;
            }
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© ÙÙŠ Firestore Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©
            await updateBalanceInDb(starBalance, highScore, playCount);
        }

        // ------------------------------------------
        // 6. ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¯Ø®ÙˆÙ„
        // ------------------------------------------
        async function initFirebase() {
            try {
                setLogLevel('debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        fetchInitialData();
                    } else {
                        console.error("Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.");
                        messageArea.innerHTML = '<span class="text-red-400">ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….</span>';
                    }
                });

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:", error);
                messageArea.innerHTML = '<span class="text-red-400">ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….</span>';
            }
        }


        // 7. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.onload = () => {
            initFirebase();
            setupReels();
            populateChargeOptions();
        };
        
        // Ø¥ØªØ§Ø­Ø© Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ (Ù…Ù‡Ù…Ø© Ù„Ø²Ø± Spin ÙÙŠ HTML)
        window.spinSlot = spinSlot;
        window.toggleChargeModal = toggleChargeModal;
    </script>
</body>
</html>
