<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لعبة X/O — Virus Play</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#06070b;
      --panel:#071722;
      --card:#071428;
      --muted:#9fb0c6;
      --accent-x: #1ea0ff; /* X = أزرق */
      --accent-o: #ff4d4d; /* O = أحمر */
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family: "Segoe UI", Roboto, system-ui, "Noto Naskh Arabic", sans-serif;direction:rtl}
    body{
      background: radial-gradient(1200px 600px at 10% 10%, rgba(30,160,255,0.06), transparent),
                  radial-gradient(1000px 500px at 90% 90%, rgba(255,77,77,0.04), transparent),
                  var(--bg);
      display:flex;align-items:center;justify-content:center;padding:20px;color:#e6f3ff;
    }

    /* container */
    .app{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:360px 1fr;
      gap:20px;
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.03);
      box-shadow: 0 10px 30px rgba(2,6,23,0.7);
      height:640px;
      display:flex;flex-direction:column;
    }

    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,var(--accent-x),#6c4bff);
      display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;color:white;
    }
    .brand h1{margin:0;font-size:18px}
    .brand p{margin:4px 0 0 0;color:var(--muted);font-size:13px}

    .stars{
      margin-top:18px;display:flex;align-items:center;gap:12px;
    }
    .star-badge{
      background:linear-gradient(90deg,#ffd85a,#ffb14a);
      color:#0b0b0b;padding:10px 14px;border-radius:12px;font-weight:800;display:flex;align-items:center;gap:8px;
    }

    .controls{margin-top:18px;display:flex;flex-direction:column;gap:10px}
    .btn{
      background:transparent;border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:12px;color:inherit;cursor:pointer;font-weight:700;
      transition:all .18s;
    }
    .btn.primary{background:linear-gradient(90deg,var(--accent-x),#6c4bff);border:none;color:#001728}
    .btn:active{transform:translateY(2px)}

    .muted{color:var(--muted);font-size:13px;margin-top:auto}

    /* game card */
    .game{
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.03);
      box-shadow:0 10px 30px rgba(1,6,20,0.6);
      height:640px;display:flex;flex-direction:column;
      position:relative;
    }
    .top{display:flex;align-items:center;justify-content:space-between}
    .playerTitle{display:flex;align-items:center;gap:12px}
    .avatarX{width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,var(--accent-x),#6c4bff);display:flex;align-items:center;justify-content:center;font-weight:900}
    .desc{color:var(--muted);font-size:13px}
    .status{font-weight:700}

    .boardWrap{flex:1;display:flex;align-items:center;justify-content:center;padding:14px}
    .board{
      width:min(540px,90vw);
      height:min(540px,90vw);
      display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:14px;padding:16px;border-radius:16px;
      background:linear-gradient(180deg,#071a26,#0b2330);box-shadow:inset 0 4px 20px rgba(0,0,0,0.6);
      position:relative;
    }

    .cell{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;
      transition:transform .12s ease, box-shadow .12s;
      border:1px solid rgba(255,255,255,0.02);
    }
    .cell:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(2,10,30,0.6)}
    .cell.disabled{cursor:not-allowed;opacity:0.85;transform:none;box-shadow:none}

    /* mark styles */
    .mark{width:78%;height:78%;transform:scale(0.01);opacity:0;transition:transform .28s cubic-bezier(.2,.9,.2,1),opacity .12s}
    .cell.played .mark{transform:scale(1);opacity:1}

    .mark.x svg path{stroke:var(--accent-x);stroke-width:12;stroke-linecap:round;stroke-linejoin:round;fill:none}
    .mark.o svg circle{stroke:var(--accent-o);stroke-width:12;fill:none}

    /* winning line */
    .winLine{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:5}
    .winLine svg{width:100%;height:100%;opacity:0;transition:opacity .14s}
    .winLine.show svg{opacity:1}

    /* result badge */
    .resultRow{display:flex;align-items:center;justify-content:space-between;gap:12px;padding-top:12px}
    .resultBadge{padding:10px 14px;border-radius:10px;font-weight:800}
    .resultBadge.win{background:linear-gradient(90deg,#00d681,#00b4ff);color:#002218}
    .resultBadge.lose{background:linear-gradient(90deg,#ff7b7b,#ffb3a3);color:#2b0b07}
    .resultBadge.draw{background:linear-gradient(90deg,#bfbfbf,#e2eefb);color:#07121a}

    /* overlay modal */
    .overlay{
      position:absolute;inset:0;background:linear-gradient(180deg,rgba(2,6,23,0.6),rgba(2,6,23,0.6));display:flex;align-items:center;justify-content:center;
      z-index:40;border-radius:14px;backdrop-filter: blur(6px);
    }
    .modal{
      background:linear-gradient(180deg,#061822,#082434);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);
      width:90%;max-width:420px;text-align:center;color:#eaf6ff;
      box-shadow:0 12px 36px rgba(3,8,30,0.6);
    }
    .modal h2{margin:6px 0 10px 0}
    .modal p{color:var(--muted);margin:0 0 14px 0}

    .modal .okBtn{display:inline-block;padding:10px 18px;border-radius:10px;background:linear-gradient(90deg,var(--accent-x),#6c4bff);color:#001528;font-weight:800;border:none;cursor:pointer}
    .centerBig{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:45;
      display:none;align-items:center;justify-content:center;
    }
    .centerBig.show{display:flex}
    .bigReset{
      background:linear-gradient(90deg,#ff5c6c,#ffb07a);border:none;color:#1b0610;padding:16px 28px;border-radius:14px;font-weight:900;font-size:18px;cursor:pointer;
      box-shadow:0 12px 40px rgba(0,0,0,0.6);
    }

    /* start screen */
    .startScreen{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(2,6,23,0.7),rgba(2,6,23,0.7));z-index:90;
    }
    .startBox{
      background:linear-gradient(180deg,#07182a,#0b2634);padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);width:90%;max-width:480px;text-align:center;
      box-shadow:0 20px 60px rgba(2,8,30,0.7);
    }
    .startBox h1{margin:0 0 12px 0}
    .startBtns{display:flex;gap:12px;justify-content:center;margin-top:12px}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 14px;border-radius:12px;color:var(--muted);cursor:pointer}

    /* responsive */
    @media (max-width:920px){.app{grid-template-columns:1fr} .panel{height:auto} .game{height:auto}}
  </style>
</head>
<body>

<div class="app">
  <div class="panel">
    <div class="brand">
      <div class="logo">VP</div>
      <div>
        <h1>@virus_play_bot</h1>
        <p class="desc">العب ضد روبوت ذكي — أنت O (أحمر)، الروبوت X (أزرق).</p>
      </div>
    </div>

    <div class="stars" style="margin-top:16px">
      <div class="star-badge">⭐ <span id="starsCount">0</span></div>
      <div style="flex:1">
        <div style="font-size:13px;color:var(--muted)">رصيد النجوم</div>
        <div style="font-weight:800">تتغير حسب نتائجك</div>
      </div>
    </div>

    <div class="controls">
      <button class="btn primary" id="startBtnPanel">بدء لعبة جديدة</button>
      <button class="btn" id="accountBtn">حسابي</button>
      <button class="btn" id="resetStars">إعادة الرصيد</button>
      <button class="btn" id="switchStarter">تبديل البدء (حالياً: الروبوت يبدأ)</button>
    </div>

    <div class="muted">فوز = +1 ⭐ ، خسارة = -1 ⭐ ، التعادل لا يؤثر.</div>
  </div>

  <div class="game" id="gameCard">
    <div class="top">
      <div class="playerTitle">
        <div class="avatarX">X</div>
        <div>
          <div id="playerTitleText">أنت — O</div>
          <div class="desc" id="statusText">التحضير...</div>
        </div>
      </div>
      <div class="desc status" id="gameState">جاهز</div>
    </div>

    <div class="boardWrap">
      <div class="board" id="board">
        <!-- 9 خلايا -->
        <div class="cell" data-i="0"><div class="mark x"><svg viewBox="0 0 100 100"><path d="M22 22 L78 78 M78 22 L22 78" /></svg></div></div>
        <div class="cell" data-i="1"><div class="mark o"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" /></svg></div></div>
        <div class="cell" data-i="2"><div class="mark x"><svg viewBox="0 0 100 100"><path d="M22 22 L78 78 M78 22 L22 78" /></svg></div></div>

        <div class="cell" data-i="3"><div class="mark o"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" /></svg></div></div>
        <div class="cell" data-i="4"><div class="mark x"><svg viewBox="0 0 100 100"><path d="M22 22 L78 78 M78 22 L22 78" /></svg></div></div>
        <div class="cell" data-i="5"><div class="mark o"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" /></svg></div></div>

        <div class="cell" data-i="6"><div class="mark x"><svg viewBox="0 0 100 100"><path d="M22 22 L78 78 M78 22 L22 78" /></svg></div></div>
        <div class="cell" data-i="7"><div class="mark o"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" /></svg></div></div>
        <div class="cell" data-i="8"><div class="mark x"><svg viewBox="0 0 100 100"><path d="M22 22 L78 78 M78 22 L22 78" /></svg></div></div>

        <div class="winLine" id="winLine"></div>
      </div>
    </div>

    <div class="resultRow">
      <div id="resultBadge" class="resultBadge draw">النتيجة: -</div>
      <div class="desc">الحركات: <span id="moveCount">0</span></div>
    </div>

    <!-- center overlay for "إعادة اللعبة" بعد OK -->
    <div class="centerBig" id="centerReset">
      <button class="bigReset" id="bigResetBtn">إعادة اللعبة</button>
    </div>

    <!-- popup modal -->
    <div class="overlay" id="popup" style="display:none;align-items:center;justify-content:center;">
      <div class="modal" id="popupContent">
        <h2 id="popupTitle">مبروك 🎉</h2>
        <p id="popupMsg">فزت الجولة</p>
        <button class="okBtn" id="popupOk">موافق</button>
      </div>
    </div>
  </div>
</div>

<!-- start screen -->
<div class="startScreen" id="startScreen">
  <div class="startBox">
    <h1>أهلًا بك — لعبة X / O</h1>
    <p class="desc">أنت تلعب O (أحمر). الروبوت X ذكي وسيبدأ عادة.</p>
    <div class="startBtns" style="margin-top:14px">
      <button class="btn primary" id="startNowBtn">بدء لعبة جديدة</button>
      <button class="ghost" id="myAccountBtn">حسابي</button>
    </div>
  </div>
</div>

<script>
/* ---------- init ---------- */
const tg = window.Telegram?.WebApp || null;
if (tg){ try { tg.expand(); } catch(e){} }

/* DOM */
const startScreen = document.getElementById('startScreen');
const startNowBtn = document.getElementById('startNowBtn');
const myAccountBtn = document.getElementById('myAccountBtn');
const startBtnPanel = document.getElementById('startBtnPanel');
const accountBtn = document.getElementById('accountBtn');
const resetStars = document.getElementById('resetStars');
const switchStarter = document.getElementById('switchStarter');

const boardEl = document.getElementById('board');
const cells = Array.from(document.querySelectorAll('.cell'));
const statusText = document.getElementById('statusText');
const resultBadge = document.getElementById('resultBadge');
const moveCountEl = document.getElementById('moveCount');
const starsCountEl = document.getElementById('starsCount');
const popup = document.getElementById('popup');
const popupTitle = document.getElementById('popupTitle');
const popupMsg = document.getElementById('popupMsg');
const popupOk = document.getElementById('popupOk');
const centerReset = document.getElementById('centerReset');
const bigResetBtn = document.getElementById('bigResetBtn');
const gameState = document.getElementById('gameState');
const playerTitleText = document.getElementById('playerTitleText');

/* game state */
let board = Array(9).fill(null);
const wins = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];

let playerMark = 'O'; // user is O (أحمر)
let aiMark = 'X';
let isPlayerTurn = false; // X starts by default
let gameOver = false;
let moveCount = 0;
let starsKey = 'vp_stars_v2';
let stars = Number(localStorage.getItem(starsKey) || 0);
let allowAiStart = true; // whether AI starts (switchStarter toggles)
updateStarsUI();
updateHeader();

/* ---------- Minimax (optimal) ---------- */
function checkWinner(b){
  for (const line of wins){
    const [a,b1,c] = line;
    if (b[a] && b[a] === b[b1] && b[a] === b[c]){
      return {winner: b[a], line};
    }
  }
  if (b.every(Boolean)) return {winner: 'draw'};
  return null;
}

function minimax(bd, depth, isMaximizing){
  const res = checkWinner(bd);
  if (res){
    if (res.winner === 'draw') return 0;
    if (res.winner === aiMark) return 10 - depth;
    if (res.winner === playerMark) return depth - 10;
  }
  if (isMaximizing){
    let best = -Infinity;
    for (let i=0;i<9;i++){
      if (!bd[i]){
        bd[i] = aiMark;
        const val = minimax(bd, depth+1, false);
        bd[i] = null;
        best = Math.max(best, val);
      }
    }
    return best === -Infinity ? 0 : best;
  } else {
    let best = Infinity;
    for (let i=0;i<9;i++){
      if (!bd[i]){
        bd[i] = playerMark;
        const val = minimax(bd, depth+1, true);
        bd[i] = null;
        best = Math.min(best, val);
      }
    }
    return best === Infinity ? 0 : best;
  }
}

function bestMove(){
  // choose best move for aiMark
  let bestVal = -Infinity;
  let bestIdx = -1;
  for (let i=0;i<9;i++){
    if (!board[i]){
      board[i] = aiMark;
      const val = minimax(board.slice(), 0, false);
      board[i] = null;
      if (val > bestVal){ bestVal = val; bestIdx = i; }
    }
  }
  // fallback
  if (bestIdx === -1){
    if (!board[4]) return 4;
    const empties = board.map((v,i)=> v?null:i).filter(Number.isFinite);
    return empties[Math.floor(Math.random()*empties.length)];
  }
  return bestIdx;
}

/* ---------- rendering ---------- */
function render(){
  for (let i=0;i<9;i++){
    const el = cells[i];
    el.classList.remove('played','disabled');
    const mark = board[i];
    const markEl = el.querySelector('.mark');
    if (mark){
      el.classList.add('played','disabled');
      if (mark === 'X'){
        markEl.classList.add('x'); markEl.classList.remove('o');
      } else {
        markEl.classList.add('o'); markEl.classList.remove('x');
      }
    } else {
      markEl.classList.remove('x','o');
    }
  }
  moveCountEl.textContent = moveCount;
}

function highlightLine(line){
  const winLine = document.getElementById('winLine');
  const rect = boardEl.getBoundingClientRect();
  const positions = cells.map(c => {
    const r = c.getBoundingClientRect();
    return { x: r.left + r.width/2 - rect.left, y: r.top + r.height/2 - rect.top };
  });
  const [a,,c] = line;
  const p1 = positions[a], p2 = positions[c];
  winLine.innerHTML = `
    <svg viewBox="0 0 ${rect.width} ${rect.height}" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="g" x1="0" x2="1">
          <stop offset="0" stop-color="#ffd54a" />
          <stop offset="1" stop-color="#ff5c6c" />
        </linearGradient>
      </defs>
      <line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}" stroke="url(#g)" stroke-width="${Math.max(8, rect.width*0.03)}" stroke-linecap="round" />
    </svg>
  `;
  winLine.classList.add('show');
  setTimeout(()=> winLine.classList.remove('show'), 2500);
}

/* ---------- game logic ---------- */
function startGame(fromStartScreen=false){
  board = Array(9).fill(null);
  gameOver = false;
  moveCount = 0;
  centerReset.classList.remove('show');
  resultBadge.className = 'resultBadge draw';
  resultBadge.textContent = 'النتيجة: -';
  statusText.textContent = allowAiStart ? 'دور الروبوت' : 'دورك';
  isPlayerTurn = !allowAiStart; // if allowAiStart true -> AI starts (X), else player starts (but player is O)
  render();
  if (fromStartScreen) startScreen.style.display = 'none';
  // if AI starts, make the first move (with a small delay)
  if (!isPlayerTurn){
    setTimeout(()=> {
      const idx = openingMove();
      makeMove(idx, aiMark);
    }, 450);
  }
}

function openingMove(){
  // smart first move: prefer center, then corners
  if (!board[4]) return 4;
  const corners = [0,2,6,8].filter(i => !board[i]);
  if (corners.length) return corners[Math.floor(Math.random()*corners.length)];
  const empties = board.map((v,i)=> v?null:i).filter(Number.isFinite);
  return empties[Math.floor(Math.random()*empties.length)];
}

function makeMove(idx, mark){
  if (gameOver || board[idx]) return false;
  board[idx] = mark;
  moveCount++;
  render();
  const end = checkWinner(board);
  if (end){
    gameOver = true;
    endGame(end);
    return true;
  }
  // switch turn
  isPlayerTurn = (mark !== playerMark);
  statusText.textContent = isPlayerTurn ? 'دورك الآن' : 'دور الروبوت';
  // if it is now AI turn -> make AI move after small delay
  if (!isPlayerTurn && !gameOver){
    setTimeout(()=> {
      const aiIdx = bestMove();
      makeMove(aiIdx, aiMark);
    }, 420);
  }
  return true;
}

function endGame(result){
  const winner = result.winner;
  if (winner === 'draw'){
    resultBadge.className = 'resultBadge draw';
    resultBadge.textContent = 'النتيجة: تعادل';
    statusText.textContent = 'انتهت اللعبة — تعادل';
    showPopup('تعادل', 'التعادل — لا تغيير في رصيدك', 'ok', 'draw');
    notifyBot('draw');
  } else if (winner === playerMark){
    resultBadge.className = 'resultBadge win';
    resultBadge.textContent = 'النتيجة: فزت! +1 ⭐';
    statusText.textContent = 'أنت الفائز!';
    highlightLine(result.line);
    stars += 1;
    updateStarsUI();
    showPopup('مبروك 🎉', 'فزت الجولة — +1 ⭐', 'ok', 'win');
    notifyBot('win');
  } else {
    resultBadge.className = 'resultBadge lose';
    resultBadge.textContent = 'النتيجة: خسرت! -1';
    statusText.textContent = 'خسر الدور — فاز الروبوت';
    highlightLine(result.line);
    stars -= 1;
    updateStarsUI();
    showPopup('خسرت 😔', 'الخسارة — -1 ⭐', 'ok', 'lose');
    notifyBot('lose');
  }
}

/* ---------- UI helpers ---------- */
function updateStarsUI(){
  starsCountEl.textContent = stars;
  localStorage.setItem(starsKey, String(stars));
}

function showPopup(title, msg, btnText, resultType){
  popupTitle.textContent = title;
  popupMsg.textContent = msg;
  popup.style.display = 'flex';
  // block board while popup is visible
  disableBoard(true);
  // on OK -> close popup and show big reset overlay
  popupOk.onclick = () => {
    popup.style.display = 'none';
    centerReset.classList.add('show');
    // disable board but leave overlay active
    disableBoard(true);
  };
}

/* disable/enable board clicks */
function disableBoard(v){
  cells.forEach(c => {
    if (v) c.classList.add('disabled'); else c.classList.remove('disabled');
  });
}

/* notify Telegram bot if inside WebApp */
function notifyBot(result){
  const payload = { event: 't3_result', result, stars, ts: Date.now() };
  if (tg && tg.sendData){
    try { tg.sendData(JSON.stringify(payload)); } catch(e){ console.warn(e); }
  }
}

/* ---------- events ---------- */
cells.forEach(c => c.addEventListener('click', () => {
  if (gameOver) return;
  const idx = Number(c.dataset.i);
  if (!isPlayerTurn) return;
  if (board[idx]) return;
  makeMove(idx, playerMark);
}));

startNowBtn.addEventListener('click', ()=> startGame(true));
startBtnPanel.addEventListener('click', ()=> startGame(false));
myAccountBtn.addEventListener('click', ()=> alert('الحساب: سيتم ربطه بالخادم لاحقاً (محلياً لايوجد تخزين مركزي).'));
accountBtn.addEventListener('click', ()=> alert('الحساب: محلي — النجوم محفوظة في جهازك.'));

resetStars.addEventListener('click', ()=> {
  if (!confirm('هل تريد إعادة رصيد النجوم إلى 0؟')) return;
  stars = 0; updateStarsUI();
});

bigResetBtn.addEventListener('click', ()=> {
  centerReset.classList.remove('show');
  startGame(false);
});

switchStarter.addEventListener('click', ()=> {
  allowAiStart = !allowAiStart;
  switchStarter.textContent = allowAiStart ? 'تبديل البدء (حالياً: الروبوت يبدأ)' : 'تبديل البدء (حالياً: أنت تبدأ)';
  startGame(false);
});

popupOk.addEventListener('click', ()=> {
  // handled in showPopup
});

/* init on load: show start screen and do not auto-start */
window.addEventListener('load', ()=> {
  // show start screen already by default (it's visible)
  // if you want to auto-hide when opened within Telegram, keep visible.
  statusText.textContent = 'اضغط "بدء لعبة جديدة" لبدء';
  resultBadge.textContent = 'النتيجة: -';
  resultBadge.className = 'resultBadge draw';
  render();
  // ensure if AI should start automatically when pressing start -> it will.
});

/* responsiveness: recompute win line positions on resize */
window.addEventListener('resize', ()=> {
  // nothing heavy now
});

/* keyboard support: Enter to start (optional) */
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && startScreen.style.display !== 'none') startGame(true);
});
</script>
</body>
  </html>
