<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„Ø¹Ø¨Ø© Ø¥ÙƒØ³ Ø£Ùˆ Ù…Ø¹ Ø¹Ù„ÙŠ Ø¨Ø´Ø§Ø±</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- Load Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Set global variables for use in the main script
    window.initializeApp = initializeApp;
    window.getAuth = getAuth;
    window.signInAnonymously = signInAnonymously;
    window.onAuthStateChanged = onAuthStateChanged;
    window.getFirestore = getFirestore;
    window.doc = doc;
    window.onSnapshot = onSnapshot;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.setPersistence = setPersistence;
    window.browserLocalPersistence = browserLocalPersistence;
  </script>

  <style>
    /* Global Styles for Aesthetics and Responsiveness */
    body {
      background-color: #121212; /* Deep Dark Background */
      color: #e0e0e0;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    /* Main App Card */
    #app {
        background-color: #1e1e1e;
        border: 1px solid #333;
    }

    /* Game Button Styling (High Aesthetics) */
    .game-button {
      transition: all 0.2s ease;
      background-color: #2a2a2a; 
      border: 2px solid #00ff73;
      color: #00ff73; 
      box-shadow: 0 6px #00a04d; /* Increased shadow for depth */
      font-weight: bold;
    }

    .game-button:hover {
      background-color: #333;
      box-shadow: 0 3px #00a04d;
      transform: translateY(3px);
    }
    
    /* Board Cell Styling (High Contrast) */
    .cell {
      background-color: #292929; 
      border: 3px solid #121212; /* Darker border for separation */
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 4.5rem; /* Slightly larger marker */
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .cell:hover {
        background-color: #383838;
    }

    /* Custom X and O styles (Vivid Colors, High Dikka) */
    .marker-X {
      color: #00ff73; /* Neon Green */
      font-weight: 900;
      text-shadow: 0 0 15px rgba(0, 255, 115, 0.7);
      /* Use a stylized font if possible, but sticking to Noto/Inter for stability */
    }
    
    .marker-O {
      color: #ff4500; /* Orange Red */
      font-weight: 900;
      text-shadow: 0 0 15px rgba(255, 69, 0, 0.7);
    }
    
    /* Result Toast Styling (Floating Notification) */
    #result-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 1.5rem 3rem;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.9);
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
      z-index: 9999;
      pointer-events: none;
      border: 2px solid;
    }

    /* Game Board Blur */
    .blur-game {
      filter: blur(5px);
      pointer-events: none;
      transition: filter 0.5s ease-out;
    }

    /* Fix for button layout on mobile */
    .menu-buttons > * {
        flex-grow: 1; /* Make both buttons grow equally */
    }

  </style>
</head>
<body class="p-4">

  <!-- Main App Container -->
  <div id="app" class="w-full max-w-sm mx-auto p-6 rounded-2xl shadow-2xl">
    
    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="flex flex-col items-center justify-center h-80 text-center">
      <i class="ph ph-circle-notch animate-spin text-4xl text-gray-400"></i>
      <p class="mt-4 text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
    </div>

    <!-- MAIN MENU SCREEN -->
    <div id="menu-screen" class="hidden text-center">
      <!-- Requirement 3: Updated Title -->
      <h1 class="text-3xl font-extrabold mb-10 text-white leading-tight">Ø§Ù„Ø¹Ø¨ X O Ù…Ø¹ <span class="marker-X">Ali Bashar</span></h1>
      
      <!-- Requirement 1: Fixed Button Layout -->
      <div class="flex flex-col space-y-4 menu-buttons">
        <button id="start-game-btn" class="game-button w-full px-6 py-4 rounded-xl text-lg font-bold">
          Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø© <i class="ph ph-sword ml-2"></i>
        </button>
        <button id="account-btn" class="game-button w-full px-6 py-4 rounded-xl text-lg font-bold">
          <span class="text-white">Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span> <i class="ph ph-star-fill marker-X mr-2"></i>
        </button>
      </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="hidden">
      <div id="game-status-bar" class="text-center mb-4 p-2 rounded-lg bg-[#2a2a2a] border border-[#333]">
        <!-- Requirement 3: Updated name 'Ali' -->
        <p class="text-lg font-semibold text-[#e0e0e0]">
          <span id="turn-display">Ø¯ÙˆØ±Ùƒ (X)</span>
        </p>
      </div>
      
      <div id="game-board-container" class="relative transition-all duration-500">
        <!-- Game Board -->
        <div id="game-board" class="grid grid-cols-3 aspect-square max-w-sm mx-auto p-2 bg-[#121212] rounded-lg shadow-inner shadow-black/50">
          <!-- Cells will be generated by JS -->
        </div>

        <!-- Restart Overlay: Hidden by default, appears after game ends -->
        <div id="restart-overlay" class="hidden absolute inset-0 flex flex-col justify-center items-center rounded-lg">
          <button id="restart-game-btn" class="game-button px-8 py-4 rounded-xl text-xl font-bold">
            Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
          </button>
        </div>
      </div>
    </div>

    <!-- ACCOUNT SCREEN -->
    <div id="account-screen" class="hidden">
      <h2 class="text-2xl font-bold mb-6 text-center text-white">Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ…</h2>
      
      <div class="bg-[#2a2a2a] p-4 rounded-xl space-y-4 border border-[#333]">
        <!-- Stars Balance -->
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg shadow-inner shadow-black/30">
          <span class="text-lg font-semibold">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</span>
          <span id="account-stars" class="text-2xl font-bold marker-X flex items-center">
            0 <i class="ph ph-star-fill text-2xl mr-1"></i>
          </span>
        </div>

        <!-- Stats -->
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
          <span class="text-lg font-semibold">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ² (Ø¶Ø¯ Ali):</span>
          <span id="account-wins" class="text-xl font-bold text-[#00ff73]">0</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
          <span class="text-lg font-semibold">Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø³Ø§Ø±Ø©:</span>
          <span id="account-losses" class="text-xl font-bold text-[#ff4500]">0</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
          <span class="text-lg font-semibold">Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ø§Ø¯Ù„:</span>
          <span id="account-draws" class="text-xl font-bold text-gray-400">0</span>
        </div>

        <!-- Dates -->
        <div class="text-sm text-gray-400 pt-4 border-t border-gray-700 space-y-2">
          <p>ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ù„Ø¹Ø¨Ø©: <span id="account-first-game" class="font-mono">N/A</span></p>
          <p>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù„Ø¹Ø¨Ø©: <span id="account-last-game" class="font-mono">N/A</span></p>
        </div>
      </div>
      
      <button id="back-to-menu-btn" class="game-button w-full mt-6 px-6 py-3 rounded-xl text-lg font-bold">
        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      </button>
    </div>

  </div>

  <!-- RESULT TOAST (Floating Notification - Fixed Issue of 'below board') -->
  <div id="result-toast" class="text-center" style="display: none;">
    <h3 id="toast-title" class="text-2xl font-extrabold mb-1"></h3>
    <p id="toast-message" class="text-lg text-gray-200"></p>
  </div>


  <script type="module">
    // Firebase Setup Variables (MANDATORY) - DO NOT CHANGE THESE NAMES
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // Global Firebase and Firestore references
    let db, auth, userId;
    let statsRef;

    // Game State
    let board = ['', '', '', '', '', '', '', '', ''];
    let currentPlayer = 'X'; // User starts first
    let isGameActive = false;
    let isGameOver = false;

    // User Data State
    let userStats = {
      stars: 0,
      wins: 0,
      losses: 0,
      draws: 0,
      firstGameDate: 'N/A',
      lastGameDate: 'N/A'
    };

    // DOM Elements
    const screens = {
      loading: document.getElementById('loading-screen'),
      menu: document.getElementById('menu-screen'),
      game: document.getElementById('game-screen'),
      account: document.getElementById('account-screen')
    };
    const boardEl = document.getElementById('game-board');
    const turnDisplay = document.getElementById('turn-display');
    const restartOverlay = document.getElementById('restart-overlay');
    const gameBoardContainer = document.getElementById('game-board-container');
    const resultToast = document.getElementById('result-toast');
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');

    // Utility to format date
    const formatDate = (timestamp) => {
      if (timestamp === 'N/A' || !timestamp) return 'N/A';
      try {
        const date = new Date(timestamp);
        return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      } catch (e) {
        return timestamp;
      }
    };

    // --- FIREBASE AND STATE MANAGEMENT ---

    async function initializeFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        await setPersistence(auth, browserLocalPersistence);

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            statsRef = doc(db, `/artifacts/${appId}/users/${userId}/tictactoe/stats`);
            loadStats();
          } else {
            // Sign in anonymously if no token or user exists
            await signInAnonymously(auth);
          }
        });

      } catch (error) {
        console.error("Firebase Initialization Error:", error);
        // Fallback: show menu without persistent stats
        showScreen('menu'); 
      }
    }

    function loadStats() {
      onSnapshot(statsRef, (docSnap) => {
        if (docSnap.exists()) {
          userStats = docSnap.data();
        } else {
          // Initialize if no document exists
          userStats = {
            stars: 0, wins: 0, losses: 0, draws: 0, firstGameDate: 'N/A', lastGameDate: 'N/A'
          };
        }
        updateAccountScreen();
        showScreen('menu'); // Show menu after loading stats
      }, (error) => {
        console.error("Firestore Snapshot Error:", error);
        showScreen('menu'); 
      });
    }

    async function updateStats(result) {
      const now = new Date().toISOString();
      const isNewUser = userStats.firstGameDate === 'N/A';
      
      let starsChange = 0;
      if (result === 'X') { // User Win: +1 Star
        starsChange = 1;
        userStats.wins++;
      } else if (result === 'O') { // Ali Win: -1 Star
        starsChange = -1;
        userStats.losses++;
      } else { // Draw: 0 Change
        userStats.draws++;
      }

      userStats.stars = (userStats.stars || 0) + starsChange;
      userStats.lastGameDate = now;
      if (isNewUser) {
        userStats.firstGameDate = now;
      }

      try {
        if (isNewUser) {
          await setDoc(statsRef, userStats);
        } else {
          await updateDoc(statsRef, userStats);
        }
        updateAccountScreen();
      } catch (e) {
        console.error("Error updating stats:", e);
      }
    }

    function updateAccountScreen() {
      const starsEl = document.getElementById('account-stars');
      starsEl.innerHTML = `${userStats.stars} <i class="ph ph-star-fill text-2xl mr-1"></i>`;
      
      // Update color based on balance
      starsEl.classList.remove('marker-X', 'marker-O', 'text-gray-400');
      if (userStats.stars > 0) {
        starsEl.classList.add('marker-X');
      } else if (userStats.stars < 0) {
        starsEl.classList.add('marker-O');
      } else {
        starsEl.classList.add('text-gray-400');
      }
      
      document.getElementById('account-wins').textContent = userStats.wins;
      document.getElementById('account-losses').textContent = userStats.losses;
      document.getElementById('account-draws').textContent = userStats.draws;
      document.getElementById('account-first-game').textContent = formatDate(userStats.firstGameDate);
      document.getElementById('account-last-game').textContent = formatDate(userStats.lastGameDate);
    }

    function showScreen(screenName) {
      Object.values(screens).forEach(el => el.classList.add('hidden'));
      if (screens[screenName]) {
        screens[screenName].classList.remove('hidden');
      }
      if (screenName !== 'game') {
        isGameActive = false;
        gameBoardContainer.classList.remove('blur-game');
        restartOverlay.classList.add('hidden');
      }
    }

    // --- GAME LOGIC ---

    const winningConditions = [
      [0, 1, 2], [3, 4, 5], [6, 7, 8], 
      [0, 3, 6], [1, 4, 7], [2, 5, 8], 
      [0, 4, 8], [2, 4, 6]            
    ];

    function checkWin(currentBoard) {
      for (let i = 0; i < winningConditions.length; i++) {
        const [a, b, c] = winningConditions[i];
        if (currentBoard[a] && currentBoard[a] === currentBoard[b] && currentBoard[a] === currentBoard[c]) {
          return currentBoard[a]; 
        }
      }
      if (!currentBoard.includes('')) {
        return 'Draw';
      }
      return null;
    }

    function handleMove(clickedCellIndex) {
      if (!isGameActive || board[clickedCellIndex] !== '' || isGameOver) return;

      // User Move (X)
      board[clickedCellIndex] = 'X';
      document.getElementById(`cell-${clickedCellIndex}`).innerHTML = `<span class="marker-X">X</span>`;
      
      let result = checkWin(board);
      if (result) return gameEnd(result); // Game end immediately after user's winning move
      
      currentPlayer = 'O';
      turnDisplay.textContent = 'Ø¯ÙˆØ± Ali (O)';
      isGameActive = false; // Pause for AI
      
      // Ali's move after a short delay
      setTimeout(robotMove, 700);
    }

    // --- SMART AI (Minimax Algorithm) ---
    
    // Evaluate the board state
    const scores = {
      X: -10, // User win is bad for Ali
      O: 10,  // Ali win is good
      Draw: 0
    };

    function minimax(newBoard, player) {
      const result = checkWin(newBoard);
      if (result) {
        return { score: scores[result] };
      }

      const availSpots = newBoard.map((val, i) => val === '' ? i : -1).filter(i => i !== -1);
      const moves = [];

      for (let i = 0; i < availSpots.length; i++) {
        const move = {};
        const index = availSpots[i];
        move.index = index;
        newBoard[index] = player;

        if (player === 'O') { // Ali (Maximizer)
          const score = minimax(newBoard, 'X').score;
          move.score = score;
        } else { // User (Minimizer)
          const score = minimax(newBoard, 'O').score;
          move.score = score;
        }

        newBoard[index] = ''; // Reset the spot
        moves.push(move);
      }

      // Find the best move
      let bestMove = 0;
      if (player === 'O') {
        let bestScore = -Infinity;
        for (let i = 0; i < moves.length; i++) {
          if (moves[i].score > bestScore) {
            bestScore = moves[i].score;
            bestMove = i;
          }
        }
      } else {
        let bestScore = Infinity;
        for (let i = 0; i < moves.length; i++) {
          if (moves[i].score < bestScore) {
            bestScore = moves[i].score;
            bestMove = i;
          }
        }
      }

      return moves[bestMove];
    }

    function robotMove() {
      const availSpots = board.map((val, i) => val === '' ? i : -1).filter(i => i !== -1);
      
      if (availSpots.length === 0) return gameEnd('Draw');

      // Use Minimax to find the best spot
      const bestSpot = minimax(board, 'O').index;

      // Ali Move (O)
      board[bestSpot] = 'O';
      // Apply the visual mark immediately
      document.getElementById(`cell-${bestSpot}`).innerHTML = `<span class="marker-O">O</span>`;

      let result = checkWin(board);
      if (result) return gameEnd(result); // Game end immediately after Ali's winning move

      currentPlayer = 'X';
      turnDisplay.textContent = 'Ø¯ÙˆØ±Ùƒ (X)';
      isGameActive = true;
    }
    
    // --- GAME END FLOW (Fixed Timing and Appearance) ---

    function gameEnd(winner) {
      isGameActive = false;
      isGameOver = true;
      let title, message, bgColor, borderColor;
      
      if (winner === 'X') {
        title = "ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ğŸ‰";
        message = "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© 1 Ù†Ø¬Ù…Ø© Ù„Ø±ØµÙŠØ¯Ùƒ.";
        bgColor = '#006400'; 
        borderColor = '#00ff73';
        updateStats('X');
      } else if (winner === 'O') {
        title = "Ø®Ø³Ø±Øª! ğŸ˜";
        message = "ØªÙ… Ø®ØµÙ… 1 Ù†Ø¬Ù…Ø© Ù…Ù† Ø±ØµÙŠØ¯Ùƒ.";
        bgColor = '#8b0000'; 
        borderColor = '#ff4500';
        updateStats('O');
      } else {
        title = "ØªØ¹Ø§Ø¯Ù„ ğŸ¤";
        message = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ØªØ¹Ø§Ø¯Ù„.";
        bgColor = '#333333'; 
        borderColor = '#e0e0e0';
        updateStats('Draw');
      }
      
      // 1. Prepare and Show the result Toast
      toastTitle.textContent = title;
      toastMessage.textContent = message;
      resultToast.style.backgroundColor = bgColor;
      resultToast.style.borderColor = borderColor;
      resultToast.style.display = 'block'; 
      
      // Delay before starting the smooth fade and blur
      setTimeout(() => {
        // Fade in (0.4s)
        resultToast.style.opacity = 1;
        // Start smooth blur (0.5s)
        gameBoardContainer.classList.add('blur-game');
      }, 50); // Small initial delay

      // 2. Fade out after 1.2 seconds of full visibility
      setTimeout(() => {
        resultToast.style.opacity = 0;
      }, 50 + 1200);

      // 3. Hide toast and show restart button after fade transition (1.2s + 0.4s transition)
      setTimeout(() => {
        resultToast.style.display = 'none';
        // Show the restart button
        restartOverlay.classList.remove('hidden');
      }, 50 + 1200 + 400); 
    }
    
    // --- INITIALIZATION ---

    function startGame() {
      board = ['', '', '', '', '', '', '', '', ''];
      currentPlayer = 'X';
      isGameActive = true;
      isGameOver = false;
      showScreen('game');
      turnDisplay.textContent = 'Ø¯ÙˆØ±Ùƒ (X)';
      gameBoardContainer.classList.remove('blur-game');
      restartOverlay.classList.add('hidden');
      
      // Clear board visually
      for (let i = 0; i < 9; i++) {
        document.getElementById(`cell-${i}`).innerHTML = '';
      }
    }

    function generateBoard() {
      boardEl.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        cell.id = `cell-${i}`;
        cell.classList.add('cell', 'rounded-lg');
        cell.addEventListener('click', () => handleMove(i));
        boardEl.appendChild(cell);
      }
    }

    // --- EVENT LISTENERS ---
    
    document.getElementById('start-game-btn').addEventListener('click', startGame);
    document.getElementById('account-btn').addEventListener('click', () => showScreen('account'));
    document.getElementById('back-to-menu-btn').addEventListener('click', () => showScreen('menu'));
    document.getElementById('restart-game-btn').addEventListener('click', startGame);

    // 1. Generate the visual board structure
    generateBoard();

    // 2. Initialize Firebase and load user stats
    initializeFirebase();
    
    // Fallback if Telegram Web App environment is not detected 
    if (typeof window.Telegram === 'undefined') {
        console.warn("Telegram Web App environment not detected.");
    } else {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
    }

  </script>
</body>
</html>

