<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ŸÑÿπÿ®ÿ© ÿ•ŸÉÿ≥ ÿ£Ÿà ŸÖÿπ ÿπŸÑŸä ÿ®ÿ¥ÿßÿ± - ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑŸÅÿßÿÆÿ±ÿ©</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  
  <!-- Tailwind Configuration for Blur Utility -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'neon-green': '#00ff73',
            'neon-red': '#ff4500',
            'dark-bg': '#0f0f0f',
            'dark-card': 'rgba(15, 15, 15, 0.95)',
          }
        }
      }
    }
  </script>
  
  <!-- Load Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Export Firebase functions to the global window object for use in the main script block
    window.initializeApp = initializeApp;
    window.getAuth = getAuth;
    window.signInAnonymously = signInAnonymously;
    window.onAuthStateChanged = onAuthStateChanged;
    window.getFirestore = getFirestore;
    window.doc = doc;
    window.onSnapshot = onSnapshot;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.setPersistence = setPersistence;
    window.browserLocalPersistence = browserLocalPersistence;
    window.signInWithCustomToken = signInWithCustomToken;
  </script>

  <style>
    /* ---------------------------------------------------------------------- */
    /* --- 1. BASE STYLES & BACKGROUND --- */
    /* ---------------------------------------------------------------------- */
    body {
      color: #e0e0e0;
      font-family: 'Tahoma', 'Inter', sans-serif; 
      min-height: 100vh; /* Full viewport height for centering */
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      background-color: #000;
      position: relative;
      overflow-y: auto; /* Allow scrolling if content overflows */
    }

    #video-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -2; 
    }
    
    #video-background source {
        content: url("https://assets.mixkit.co/videos/preview/mixkit-nebula-and-planet-in-outer-space-40615-large.mp4");
    }

    #video-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.6); 
      z-index: -1; 
    }

    /* Main App Card - Responsive and Aesthetic */
    #app {
        background-color: var(--dark-card); 
        border: 2px solid #333;
        position: relative;
        z-index: 10;
        min-height: 80vh; 
        max-width: 420px; /* Slightly wider for better look */
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    /* ---------------------------------------------------------------------- */
    /* --- 2. GAME ELEMENTS STYLES --- */
    /* ---------------------------------------------------------------------- */

    /* Game Button Styling (High Aesthetics) */
    .game-button {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background-color: #2a2a2a; 
      border: 2px solid var(--neon-green);
      color: var(--neon-green); 
      box-shadow: 0 5px #008040; /* Deeper shadow */
      font-weight: bold;
    }

    .game-button:hover {
      background-color: #333;
      box-shadow: 0 2px #008040;
      transform: translateY(3px); /* Stronger press effect */
    }
    
    /* Board Cell Styling - 3D/Neumorphism-like */
    .cell {
      background-color: #1c1c1c; 
      border: none;
      box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.8), /* Darker inner shadow */
                  inset -3px -3px 5px rgba(60, 60, 60, 0.3); /* Lighter inner highlight */
      display: flex;
      justify-content: center;
      align-items: center;
      aspect-ratio: 1 / 1; 
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease, transform 0.1s ease;
      border-radius: 15px; 
      overflow: hidden; 
      position: relative; 
    }

    .cell:hover {
        background-color: #252525;
        transform: scale(0.98); /* Subtle hover press */
    }
    
    /* Custom X and O styles (Vivid Colors) */
    .marker-X, .marker-O {
      font-size: 3.5rem; /* Slightly larger */
      line-height: 1; 
      font-weight: 900;
      user-select: none;
      display: inline-block; 
      transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* Bounce animation */
    }
    
    .marker-X {
      color: var(--neon-green); 
      text-shadow: 0 0 15px rgba(0, 255, 115, 0.8);
    }
    
    .marker-O {
      color: var(--neon-red); 
      text-shadow: 0 0 15px rgba(255, 69, 0, 0.8);
    }
    
    .cell:not(:empty) .marker-X,
    .cell:not(:empty) .marker-O {
        transform: scale(1.0); /* Animation end state */
    }
    
    /* ---------------------------------------------------------------------- */
    /* --- 3. OVERLAYS, TOAST & WINNING LINE --- */
    /* ---------------------------------------------------------------------- */
    
    /* Result Toast Styling */
    #result-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 2rem 4rem; /* Larger padding */
      border-radius: 16px;
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.9);
      opacity: 0;
      transition: opacity 0.2s ease-in-out; 
      z-index: 9999;
      pointer-events: none;
      border: 3px solid;
    }

    /* Restart Overlay Styling (Covers the board) */
    #restart-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.8); /* Darker backdrop */
        border-radius: 12px;
        z-index: 20; 
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        /* CRITICAL FIX: Ensure clicks pass through when hidden */
        pointer-events: none; 
    }
    #restart-overlay.visible {
        opacity: 1;
        pointer-events: all;
    }

    /* Blur Effect Utility Class */
    .blur-target {
        filter: blur(5px);
        opacity: 0.5;
        pointer-events: none;
        transition: filter 0.5s ease, opacity 0.5s ease;
    }
    
    /* Winning Line */
    .win-line-active {
        animation: neon-pulse 1s ease-in-out infinite alternate;
    }
    @keyframes neon-pulse {
        from { opacity: 0.7; transform: scale(1.0); }
        to { opacity: 1.0; transform: scale(1.05); }
    }
    
    /* ---------------------------------------------------------------------- */
    /* --- 4. UTILITY & RESPONSIVENESS --- */
    /* ---------------------------------------------------------------------- */
    
    /* Audio Controls Position */
    #audio-controls {
        position: absolute;
        top: 4rem; /* Adjusted for better spacing below lang button */
        right: 1rem;
        z-index: 20;
    }
    /* Language Button Position */
    #lang-switch-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 20;
    }

    /* Menu Title Fix for Arabic Wrapping */
    .menu-title-fix {
        font-size: 2.5rem; 
        line-height: 1.2;
    }
    @media (max-width: 400px) { 
        .menu-title-fix {
            font-size: 1.8rem; 
        }
    }
  </style>
</head>
<body class="p-4">

  <!-- --- VIDEO BACKGROUND --- -->
  <video autoplay muted loop id="video-background">
      <source src="https://assets.mixkit.co/videos/preview/mixkit-nebula-and-planet-in-outer-space-40615-large.mp4" type="video/mp4">
  </video>
  <div id="video-overlay"></div>
  <!-- ------------------------ -->

  <!-- --- AUDIO ELEMENT (For Music) --- -->
  <!-- 
    NOTE: Updated music file path to: –ì–∏–æ –ü–∏–∫–∞ - –ë—É–π–Ω–æ –≥–æ–ª–æ–≤–∞.m4a 
    User needs to ensure this path is correct in their repository. 
  -->
  <audio id="background-music" loop preload="auto">
      <source src="–ì–∏–æ –ü–∏–∫–∞ - –ë—É–π–Ω–æ –≥–æ–ª–æ–≤–∞.m4a" type="audio/m4a">
      <span data-ar="ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿµŸàÿ™." data-en="Your browser does not support this audio."></span>
  </audio>

  <!-- --- AUDIO CONTROLS (Top Right) --- -->
  <button id="audio-controls" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full text-sm shadow-md transition-colors duration-200 z-20">
    <i id="audio-icon" class="ph ph-speaker-simple-high text-xl"></i>
  </button>

  <!-- --- LANGUAGE SWITCHER (Top Left) --- -->
  <button id="lang-switch-btn" data-lang="ar" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full text-sm shadow-md transition-colors duration-200 z-20">
    <span id="lang-flag">üáÆüá∂</span> <span id="lang-text">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</span>
  </button>

  <!-- Main App Container -->
  <div id="app" class="mx-auto p-8 rounded-2xl shadow-2xl relative">
    
    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="flex flex-col items-center justify-center h-80 text-center">
      <i class="ph ph-circle-notch animate-spin text-4xl text-gray-400"></i>
      <p class="mt-4 text-gray-400" data-ar="ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑŸÜÿ∏ÿßŸÖ..." data-en="Connecting to the system..."></p>
    </div>

    <!-- MAIN MENU SCREEN -->
    <div id="menu-screen" class="hidden text-center">
      <h1 class="font-extrabold mb-10 text-white leading-tight menu-title-fix">
        <span data-ar="ÿßŸÑÿπÿ® X O ŸÖÿπ ÿπŸÑŸä ÿ®ÿ¥ÿßÿ±" data-en="Play X O, With Ali Bashar" class="inline-block whitespace-nowrap">
          <span data-ar="ÿßŸÑÿπÿ® X O ŸÖÿπ" data-en="Play X O, With">ÿßŸÑÿπÿ® X O ŸÖÿπ</span> <span class="marker-X inline-block">ÿπŸÑŸä ÿ®ÿ¥ÿßÿ±</span>
        </span>
      </h1>
      
      <div class="flex flex-col space-y-5 menu-buttons">
        <button id="start-game-btn" class="game-button w-full px-6 py-4 rounded-xl text-lg font-bold">
          <span data-ar="ÿ®ÿØÿ° ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©" data-en="Start New Game">ÿ®ÿØÿ° ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©</span> <i class="ph ph-sword ml-2"></i>
        </button>
        <button id="account-btn" class="game-button w-full px-6 py-4 rounded-xl text-lg font-bold bg-gray-600 border-gray-500 text-white" style="box-shadow: 0 4px #444; border-color: #555;">
          <span class="text-white" data-ar="ÿ±ÿµŸäÿØ ÿßŸÑŸÜÿ¨ŸàŸÖ ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™" data-en="Star Balance & Stats">ÿ±ÿµŸäÿØ ÿßŸÑŸÜÿ¨ŸàŸÖ ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</span> <i class="ph ph-star-fill marker-X mr-2"></i>
        </button>
      </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="hidden relative">
      <div id="game-status-bar" class="text-center mb-6 p-3 rounded-xl bg-[#2a2a2a] border border-[#333] transition-all duration-500">
        <p class="text-xl font-bold text-[#e0e0e0]">
          <span id="turn-display"></span>
        </p>
      </div>
      
      <div id="game-board-container" class="relative transition-all duration-500">
        <!-- Game Board -->
        <div id="game-board" class="grid grid-cols-3 gap-3 aspect-square max-w-sm mx-auto transition-all duration-500">
          <!-- Winning Line Container (Generated by JS) -->
          <div id="winning-line" class="absolute inset-0 pointer-events-none"></div>
          <!-- Cells will be generated by JS -->
        </div>
        
        <!-- RESTART OVERLAY - Initially hidden, becomes visible after game end -->
        <div id="restart-overlay" class="hidden">
             <!-- The buttons will appear here -->
        </div>
      </div>
      
      <!-- GAME CONTROL BUTTONS - now only holds the End Game button when game is active -->
      <div id="game-control-buttons" class="mt-8 space-y-3 transition-all duration-500">
          <!-- 1. ÿ≤ÿ± ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ© (End Game) -->
          <button id="end-game-btn" class="game-button w-full px-6 py-3 rounded-xl text-lg font-bold bg-gray-600 border-gray-500 text-white" style="box-shadow: 0 4px #444; border-color: #555;">
              <span data-ar="ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ© ŸàÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ©" data-en="End Game and Return to Menu">ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ© ŸàÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ©</span>
          </button>
      </div>
      
    </div>

    <!-- ACCOUNT SCREEN -->
    <div id="account-screen" class="hidden">
      <h2 class="text-3xl font-bold mb-8 text-center text-white" data-ar="ÿ±ÿµŸäÿØ ÿßŸÑŸÜÿ¨ŸàŸÖ" data-en="Star Balance">ÿ±ÿµŸäÿØ ÿßŸÑŸÜÿ¨ŸàŸÖ</h2>
      
      <div class="bg-[#2a2a2a] p-5 rounded-2xl space-y-5 border border-[#444] shadow-xl">
        <!-- User ID Display - Mandatory for collaborative apps -->
        <div class="p-3 bg-gray-700/50 rounded-lg text-sm font-mono break-all" data-ar="ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ŸÑŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©):" data-en="User ID (for sharing):">
            <span id="user-id-display">Loading...</span>
        </div>
        
        <!-- Stars Balance -->
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg shadow-inner shadow-black/30">
          <span class="text-xl font-semibold" data-ar="ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä:" data-en="Current Balance:">ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä:</span>
          <span id="account-stars" class="text-3xl font-bold marker-X flex items-center">0 <i class="ph ph-star-fill text-3xl mr-1"></i></span>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-3 gap-4 text-center pt-4 border-t border-gray-700">
            <div>
                <span id="account-wins" class="text-2xl font-bold text-neon-green">0</span>
                <p class="text-sm text-gray-400" data-ar="ŸÅŸàÿ≤" data-en="Wins">ŸÅŸàÿ≤</p>
            </div>
            <div>
                <span id="account-losses" class="text-2xl font-bold text-neon-red">0</span>
                <p class="text-sm text-gray-400" data-ar="ÿÆÿ≥ÿßÿ±ÿ©" data-en="Losses">ÿÆÿ≥ÿßÿ±ÿ©</p>
            </div>
            <div>
                <span id="account-draws" class="text-2xl font-bold text-gray-400">0</span>
                <p class="text-sm text-gray-400" data-ar="ÿ™ÿπÿßÿØŸÑ" data-en="Draws">ÿ™ÿπÿßÿØŸÑ</p>
            </div>
        </div>

        <!-- Dates -->
        <div class="text-sm text-gray-400 pt-4 border-t border-gray-700 space-y-2">
          <p><span data-ar="ÿ™ÿßÿ±ŸäÿÆ ÿ£ŸàŸÑ ŸÑÿπÿ®ÿ©:" data-en="First Game:">ÿ™ÿßÿ±ŸäÿÆ ÿ£ŸàŸÑ ŸÑÿπÿ®ÿ©:</span> <span id="account-first-game" class="font-mono">N/A</span></p>
          <p><span data-ar="ÿ™ÿßÿ±ŸäÿÆ ÿ¢ÿÆÿ± ŸÑÿπÿ®ÿ©:" data-en="Last Game:">ÿ™ÿßÿ±ŸäÿÆ ÿ¢ÿÆÿ± ŸÑÿπÿ®ÿ©:</span> <span id="account-last-game" class="font-mono">N/A</span></p>
        </div>
      </div>
      
      <button id="back-to-menu-btn" class="game-button w-full mt-8 px-6 py-4 rounded-xl text-lg font-bold">
        <span data-ar="ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©" data-en="Back to Main Menu">ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span> <i class="ph ph-arrow-counter-clockwise ml-2"></i>
      </button>
    </div>

  </div>

  <!-- RESULT TOAST (Floating Notification) -->
  <div id="result-toast" class="text-center" style="display: none;">
    <h3 id="toast-title" class="text-3xl font-bold mb-2"></h3>
    <p id="toast-message" class="text-xl text-gray-200"></p>
  </div>


  <script type="module">
    /**
     * @file tictactoe_v7.html
     * @author Ali Bashar - Gemini
     * @description Tic-Tac-Toe Game (X vs O AI) with luxurious structure,
     * Firebase persistence, language switching, and background music control.
     * Features included: Minimax AI, responsive design, and robust state management.
     */

    // ----------------------------------------------------------------------
    // --- 1. GLOBAL CONSTANTS & CONFIGURATION ---
    // ----------------------------------------------------------------------

    const WIN_COLOR = '#00ff73'; // Neon Green for User (X)
    const LOSE_COLOR = '#ff4500'; // Orange Red for Ali (O)
    const TOAST_VISIBLE_DURATION_MS = 1500; 

    // Localization Data
    const i18n = {
        ar: {
            loading: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑŸÜÿ∏ÿßŸÖ...",
            title: "ÿßŸÑÿπÿ® X O ŸÖÿπ ÿπŸÑŸä ÿ®ÿ¥ÿßÿ±", 
            start: "ÿ®ÿØÿ° ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©",
            stats: "ÿ±ÿµŸäÿØ ÿßŸÑŸÜÿ¨ŸàŸÖ ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™",
            user_id: "ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ŸÑŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©):",
            current_balance: "ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä:",
            wins: "ŸÅŸàÿ≤", losses: "ÿÆÿ≥ÿßÿ±ÿ©", draws: "ÿ™ÿπÿßÿØŸÑ",
            first_game: "ÿ™ÿßÿ±ŸäÿÆ ÿ£ŸàŸÑ ŸÑÿπÿ®ÿ©:",
            last_game: "ÿ™ÿßÿ±ŸäÿÆ ÿ¢ÿÆÿ± ŸÑÿπÿ®ÿ©:",
            back_to_menu: "ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
            end_game_menu: "ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ©",
            end_game: "ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ© ŸàÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ©",
            restart_game: "ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÑÿπÿ®ÿ©", 
            turn_you: "ÿØŸàÿ±ŸÉ (X)",
            turn_ali: "ÿØŸàÿ± ÿπŸÑŸä ÿ®ÿ¥ÿßÿ± (O)",
            win_title: "ÿ™ŸáÿßŸÜŸäŸÜÿß! ŸÅÿ≤ÿ™!",
            win_message: "ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© 1 ŸÜÿ¨ŸÖÿ© ŸÑÿ±ÿµŸäÿØŸÉ.",
            lose_title: "ÿÆÿ≥ÿ±ÿ™!",
            lose_message: "ÿ™ŸÖ ÿÆÿµŸÖ 1 ŸÜÿ¨ŸÖÿ© ŸÖŸÜ ÿ±ÿµŸäÿØŸÉ.",
            draw_title: "ÿ™ÿπÿßÿØŸÑ",
            draw_message: "ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ© ÿ®ÿßŸÑÿ™ÿπÿßÿØŸÑ.",
            star_balance: "ÿ±ÿµŸäÿØ ÿßŸÑŸÜÿ¨ŸàŸÖ"
        },
        en: {
            loading: "Connecting to the system...",
            title: "Play X O, With Ali Bashar", 
            start: "Start New Game",
            stats: "Star Balance & Stats",
            user_id: "User ID (for sharing):",
            current_balance: "Current Balance:",
            wins: "Wins", losses: "Losses", draws: "Draws",
            first_game: "First Game:",
            last_game: "Last Game:",
            back_to_menu: "Back to Main Menu",
            end_game_menu: "Back to Menu",
            end_game: "End Game and Return to Menu",
            restart_game: "Restart Game", 
            turn_you: "Your turn (X)",
            turn_ali: "Ali Bashar's turn (O)",
            win_title: "Congratulations! You Win!",
            win_message: "1 star added to your balance.",
            lose_title: "You Lost!",
            lose_message: "1 star deducted from your balance.",
            draw_title: "Draw",
            draw_message: "The game ended in a draw.",
            star_balance: "Star Balance"
        }
    };
    
    // --- Global App State Management ---
    const AppState = {
        // Firebase Config
        appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
        firebaseConfig: JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'),
        db: null,
        auth: null,
        userId: null,
        statsRef: null,
        isAuthReady: false,
        
        // Game State
        board: Array(9).fill(''),
        currentPlayer: 'X', // User always starts as 'X'
        isGameActive: false,
        isGameOver: false,
        
        // UI State
        currentLang: localStorage.getItem('appLang') || 'ar', 
        isMusicPlaying: false,
        isMusicMuted: false,

        // User Data State
        userStats: {
            stars: 0, wins: 0, losses: 0, draws: 0, 
            firstGameDate: 'N/A', lastGameDate: 'N/A'
        }
    };

    // ----------------------------------------------------------------------
    // --- 2. DOM ELEMENT CACHE ---
    // ----------------------------------------------------------------------
    const DOM = {
        screens: {
            loading: document.getElementById('loading-screen'),
            menu: document.getElementById('menu-screen'),
            game: document.getElementById('game-screen'),
            account: document.getElementById('account-screen')
        },
        game: {
            board: document.getElementById('game-board'),
            boardContainer: document.getElementById('game-board-container'),
            turnDisplay: document.getElementById('turn-display'),
            restartOverlay: document.getElementById('restart-overlay'),
            controlButtons: document.getElementById('game-control-buttons'),
            statusBar: document.getElementById('game-status-bar'),
            winningLine: document.getElementById('winning-line')
        },
        account: {
            stars: document.getElementById('account-stars'),
            wins: document.getElementById('account-wins'),
            losses: document.getElementById('account-losses'),
            draws: document.getElementById('account-draws'),
            firstGame: document.getElementById('account-first-game'),
            lastGame: document.getElementById('account-last-game'),
            userIdDisplay: document.getElementById('user-id-display')
        },
        toast: {
            resultToast: document.getElementById('result-toast'),
            title: document.getElementById('toast-title'),
            message: document.getElementById('toast-message')
        },
        controls: {
            langSwitchBtn: document.getElementById('lang-switch-btn'),
            langFlag: document.getElementById('lang-flag'),
            langText: document.getElementById('lang-text'),
            audioElement: document.getElementById('background-music'),
            audioControls: document.getElementById('audio-controls'),
            audioIcon: document.getElementById('audio-icon')
        }
    };
    
    // ----------------------------------------------------------------------
    // --- 3. CORE UTILITIES ---
    // ----------------------------------------------------------------------

    /**
     * @module UILogic
     * Handles all Screen transitions, Localization, and basic UI manipulations.
     */
    const UILogic = {
        /**
         * Switches the active screen.
         * @param {string} screenName - The name of the screen to show ('menu', 'game', 'account').
         */
        showScreen(screenName) {
            Object.values(DOM.screens).forEach(el => el.classList.add('hidden'));
            if (DOM.screens[screenName]) {
                DOM.screens[screenName].classList.remove('hidden');
            }
            
            // Reset game state UI when leaving game screen
            if (screenName !== 'game') {
                AppState.isGameActive = false;
                AppState.isGameOver = false;
                
                UILogic.removeBlurEffects();
                GameLogic.clearWinningLine();
                UILogic.hideRestartOverlay();
            }
            
            // Update document direction
            document.documentElement.dir = AppState.currentLang === 'ar' ? 'rtl' : 'ltr';
        },

        /**
         * Updates all text content based on the current language setting.
         */
        setLanguage(lang) {
            AppState.currentLang = lang;
            localStorage.setItem('appLang', lang);
            
            const currentI18n = i18n[lang];

            // Update flags and text in the button
            if (lang === 'ar') {
                DOM.controls.langFlag.textContent = 'üáÆüá∂';
                DOM.controls.langText.textContent = 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©';
            } else {
                DOM.controls.langFlag.textContent = 'üá∫üá∏';
                DOM.controls.langText.textContent = 'USA';
            }

            // Update all data-lang elements
            document.querySelectorAll('[data-ar]').forEach(el => {
                const arText = el.getAttribute('data-ar');
                const enText = el.getAttribute('data-en');
                if (arText && enText) {
                    el.textContent = (lang === 'ar' ? arText : enText);
                }
            });
            
            // Update dynamic content
            UILogic.updateTurnDisplay();
            UILogic.updateAccountScreen();
            
            // Regenerate overlay content if visible
            if (AppState.isGameOver && !DOM.screens.game.classList.contains('hidden')) {
                 UILogic.showRestartOverlay();
            }
            
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        },

        /**
         * Toggles between Arabic and English.
         */
        toggleLanguage() {
            UILogic.setLanguage(AppState.currentLang === 'ar' ? 'en' : 'ar');
        },

        /**
         * Updates the display indicating whose turn it is.
         */
        updateTurnDisplay() {
            const text = AppState.currentPlayer === 'X' 
                ? i18n[AppState.currentLang].turn_you 
                : i18n[AppState.currentLang].turn_ali;
            DOM.game.turnDisplay.textContent = text;
        },

        /**
         * Shows the floating result notification (Toast).
         * @param {string} title - The title of the result.
         * @param {string} message - The accompanying message.
         * @param {string} bgColor - Background color.
         * @param {string} borderColor - Border color.
         */
        showResultToast(title, message, bgColor, borderColor) {
            DOM.toast.title.textContent = title;
            DOM.toast.message.textContent = message;
            DOM.toast.resultToast.style.backgroundColor = bgColor;
            DOM.toast.resultToast.style.borderColor = borderColor;
            DOM.toast.resultToast.style.display = 'block'; 
            
            // Fade in and apply blur effects
            setTimeout(() => {
                DOM.toast.resultToast.style.opacity = 1;
                UILogic.applyBlurEffects();
            }, 50); 
            
            // Hide toast and show restart overlay after duration
            setTimeout(() => {
                DOM.toast.resultToast.style.opacity = 0;
                
                setTimeout(() => {
                    DOM.toast.resultToast.style.display = 'none';
                    UILogic.showRestartOverlay();
                }, 200); // Wait for fade out
                
            }, 50 + TOAST_VISIBLE_DURATION_MS);
        },
        
        /**
         * Applies the visual blur effect to game elements.
         */
        applyBlurEffects() {
            DOM.game.boardContainer.classList.add('blur-target');
            DOM.game.controlButtons.classList.add('blur-target');
            DOM.game.statusBar.classList.add('blur-target');
        },

        /**
         * Removes the visual blur effect from game elements.
         */
        removeBlurEffects() {
            DOM.game.boardContainer.classList.remove('blur-target');
            DOM.game.controlButtons.classList.remove('blur-target');
            DOM.game.statusBar.classList.remove('blur-target');
        },
        
        /**
         * Shows the restart/menu buttons overlay after game end.
         */
        showRestartOverlay() {
            const lang = AppState.currentLang;
            
            DOM.game.restartOverlay.innerHTML = `
                <div class="flex flex-col space-y-4 p-8 w-full max-w-xs">
                    <button id="restart-game-btn" class="game-button w-full px-6 py-3 rounded-xl text-lg font-bold">
                        <span data-ar="${i18n[lang].restart_game}" data-en="${i18n.en.restart_game}">${i18n[lang].restart_game}</span>
                    </button>
                    <button id="return-to-menu-btn-overlay" class="game-button w-full px-6 py-3 rounded-xl text-lg font-bold bg-gray-600 border-gray-500 text-white" style="box-shadow: 0 4px #444; border-color: #555;">
                        <span data-ar="${i18n[lang].end_game_menu}" data-en="${i18n.en.end_game_menu}">${i18n[lang].end_game_menu}</span>
                    </button>
                </div>
            `;
            
            // Attach listeners to the newly created buttons
            document.getElementById('restart-game-btn').addEventListener('click', GameLogic.startGame);
            document.getElementById('return-to-menu-btn-overlay').addEventListener('click', () => UILogic.showScreen('menu'));
            
            DOM.game.restartOverlay.classList.remove('hidden');
            // CRITICAL FIX: Add 'visible' class to enable pointer-events
            setTimeout(() => {
                DOM.game.restartOverlay.classList.add('visible'); 
            }, 50); 
        },
        
        /**
         * Hides the restart overlay.
         */
        hideRestartOverlay() {
            DOM.game.restartOverlay.classList.remove('visible');
            setTimeout(() => {
                DOM.game.restartOverlay.classList.add('hidden');
                DOM.game.restartOverlay.innerHTML = '';
            }, 300); // Matches opacity transition duration
        },

        /**
         * Updates the account and stats display.
         */
        updateAccountScreen() {
            const stats = AppState.userStats;
            const lang = AppState.currentLang;
            
            // Format star balance with color
            let starClass = 'text-gray-400';
            if (stats.stars > 0) {
                starClass = 'marker-X';
            } else if (stats.stars < 0) {
                starClass = 'marker-O';
            }
            
            DOM.account.stars.innerHTML = `${stats.stars} <i class="ph ph-star-fill text-3xl ${lang === 'ar' ? 'mr-1' : 'ml-1'}"></i>`;
            DOM.account.stars.className = `text-3xl font-bold flex items-center ${starClass}`;

            DOM.account.wins.textContent = stats.wins;
            DOM.account.losses.textContent = stats.losses;
            DOM.account.draws.textContent = stats.draws;
            DOM.account.firstGame.textContent = UILogic.formatDate(stats.firstGameDate);
            DOM.account.lastGame.textContent = UILogic.formatDate(stats.lastGameDate);
            
            if (AppState.userId) {
                 DOM.account.userIdDisplay.textContent = AppState.userId;
            } else {
                 DOM.account.userIdDisplay.textContent = i18n[lang].loading;
            }
        },
        
        /**
         * Utility to format ISO date string.
         * @param {string} timestamp - ISO date string.
         * @returns {string} Formatted date string.
         */
        formatDate(timestamp) {
            if (timestamp === 'N/A' || !timestamp) return 'N/A';
            try {
                const date = new Date(timestamp);
                // Use English locale for consistent date format regardless of app language
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                console.error("Date formatting error:", e);
                return 'N/A';
            }
        }
    };
    
    // ----------------------------------------------------------------------
    // --- 4. FIREBASE DATA MANAGEMENT ---
    // ----------------------------------------------------------------------

    /**
     * @module FirebaseManager
     * Handles all Firebase initialization, authentication, and data persistence.
     */
    const FirebaseManager = {
        /**
         * Initializes Firebase services and handles authentication.
         */
        async init() {
            try {
                const app = initializeApp(AppState.firebaseConfig);
                AppState.db = getFirestore(app);
                AppState.auth = getAuth(app);
                
                await setPersistence(AppState.auth, browserLocalPersistence);

                onAuthStateChanged(AppState.auth, async (user) => {
                    if (user) {
                        AppState.userId = user.uid;
                        AppState.statsRef = doc(AppState.db, `/artifacts/${AppState.appId}/users/${AppState.userId}/tictactoe/stats`);
                        FirebaseManager.loadStats();
                        AppState.isAuthReady = true;
                    } else {
                        // Sign in anonymously if no token or user exists
                        const customToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (customToken) {
                            await signInWithCustomToken(AppState.auth, customToken);
                        } else {
                            await signInAnonymously(AppState.auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // If initialization fails, proceed to menu without persistence
                UILogic.showScreen('menu'); 
            }
        },

        /**
         * Listens to user stats document for real-time updates.
         */
        loadStats() {
            if (!AppState.statsRef) return;
            
            onSnapshot(AppState.statsRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Merge data to prevent overwriting missing fields
                    AppState.userStats = { ...AppState.userStats, ...docSnap.data() }; 
                } else {
                    // Initialize if document does not exist
                    AppState.userStats = {
                        stars: 0, wins: 0, losses: 0, draws: 0, firstGameDate: 'N/A', lastGameDate: 'N/A'
                    };
                }
                UILogic.updateAccountScreen();
                UILogic.showScreen('menu'); // Show menu after auth and data load
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                // Show menu even if snapshot fails
                UILogic.showScreen('menu'); 
            });
        },

        /**
         * Updates user stats in Firestore after a game finishes.
         * @param {'X'|'O'|'Draw'} result - The result of the game.
         */
        async updateStats(result) {
            if (!AppState.statsRef || !AppState.isAuthReady) {
                console.warn("Stats update skipped: Firebase not ready or user not authenticated.");
                return;
            }
            
            const now = new Date().toISOString();
            const isNewUser = AppState.userStats.firstGameDate === 'N/A';
            
            let starsChange = 0;
            if (result === 'X') { 
                starsChange = 1;
                AppState.userStats.wins++;
            } else if (result === 'O') { 
                starsChange = -1;
                AppState.userStats.losses++;
            } else {
                AppState.userStats.draws++;
            }

            AppState.userStats.stars = (AppState.userStats.stars || 0) + starsChange;
            AppState.userStats.lastGameDate = now;
            if (isNewUser) {
                AppState.userStats.firstGameDate = now;
            }

            try {
                if (isNewUser) {
                    await setDoc(AppState.statsRef, AppState.userStats);
                } else {
                    await updateDoc(AppState.statsRef, AppState.userStats);
                }
                UILogic.updateAccountScreen();
            } catch (e) {
                console.error("Error updating stats in Firestore:", e);
            }
        }
    };
    
    // ----------------------------------------------------------------------
    // --- 5. AUDIO MANAGER ---
    // ----------------------------------------------------------------------
    
    /**
     * @module AudioManager
     * Controls background music playback and UI controls.
     */
    const AudioManager = {
        /**
         * Sets initial state and adds listeners.
         */
        init() {
            DOM.controls.audioElement.muted = AppState.isMusicMuted;
            this.updateIcon();
            DOM.controls.audioControls.addEventListener('click', this.toggleMute);
        },
        
        /**
         * Toggles the mute state and updates the icon.
         */
        toggleMute() {
            AppState.isMusicMuted = !AppState.isMusicMuted;
            DOM.controls.audioElement.muted = AppState.isMusicMuted;
            AudioManager.updateIcon();
        },
        
        /**
         * Updates the visual icon based on mute state.
         */
        updateIcon() {
            if (AppState.isMusicMuted) {
                DOM.controls.audioIcon.classList.replace('ph-speaker-simple-high', 'ph-speaker-simple-slash');
            } else {
                DOM.controls.audioIcon.classList.replace('ph-speaker-simple-slash', 'ph-speaker-simple-high');
            }
        },

        /**
         * Attempts to start playback. Should be called by a user gesture.
         */
        playMusic() {
            if (!AppState.isMusicPlaying) {
                DOM.controls.audioElement.play().then(() => {
                    AppState.isMusicPlaying = true;
                    console.log("Music started playing.");
                }).catch(error => {
                    console.warn("Music auto-play failed, usually blocked by browser.", error);
                    AppState.isMusicPlaying = false;
                });
            }
        },
        
        /**
         * Pauses the music.
         */
        pauseMusic() {
            if (AppState.isMusicPlaying) {
                DOM.controls.audioElement.pause();
                AppState.isMusicPlaying = false;
            }
        }
    };
    
    // ----------------------------------------------------------------------
    // --- 6. GAME LOGIC ---
    // ----------------------------------------------------------------------

    /**
     * @module GameLogic
     * Contains all game-specific logic: board state, AI, win checks, and game flow.
     */
    const GameLogic = {
        winningConditions: [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], 
            [0, 3, 6], [1, 4, 7], [2, 5, 8], 
            [0, 4, 8], [2, 4, 6]            
        ],

        /**
         * Generates the board HTML structure and attaches listeners.
         */
        generateBoard() {
            DOM.game.board.innerHTML = ''; 
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.id = `cell-${i}`;
                cell.classList.add('cell');
                cell.addEventListener('click', () => GameLogic.handleMove(i));
                DOM.game.board.appendChild(cell);
            }
            // Re-add winning line container
            const lineContainer = document.createElement('div');
            lineContainer.id = 'winning-line';
            lineContainer.classList.add('absolute', 'inset-0', 'pointer-events-none');
            DOM.game.board.appendChild(lineContainer);
            DOM.game.winningLine = document.getElementById('winning-line');
        },

        /**
         * Starts or restarts a new game.
         */
        startGame() {
            // CRITICAL: Play music on user gesture
            AudioManager.playMusic(); 
            
            AppState.board = Array(9).fill('');
            AppState.currentPlayer = 'X';
            AppState.isGameActive = true; // User can click now
            AppState.isGameOver = false;
            
            UILogic.showScreen('game');
            UILogic.updateTurnDisplay();
            UILogic.removeBlurEffects();
            UILogic.hideRestartOverlay();
            GameLogic.clearWinningLine(); 
            
            // Clear board visuals
            for (let i = 0; i < 9; i++) {
                const cellEl = document.getElementById(`cell-${i}`);
                if (cellEl) cellEl.innerHTML = '';
            }
        },

        /**
         * Handles user (X) move.
         * @param {number} clickedCellIndex - Index of the clicked cell (0-8).
         */
        handleMove(clickedCellIndex) {
            // CRITICAL BUG FIX: Check if game is active or cell is taken
            if (!AppState.isGameActive || AppState.board[clickedCellIndex] !== '' || AppState.isGameOver) return;

            // 1. User Move (X)
            AppState.board[clickedCellIndex] = 'X';
            document.getElementById(`cell-${clickedCellIndex}`).innerHTML = `<span class="marker-X">X</span>`;
            
            // 2. Check Win immediately after user move
            let { winner, combo } = GameLogic.checkWin(AppState.board);
            if (winner) return GameLogic.gameEnd(winner, combo); 
            
            // 3. Switch to AI turn
            AppState.currentPlayer = 'O';
            UILogic.updateTurnDisplay();
            AppState.isGameActive = false; // Disable clicks during AI turn
            
            // 4. Ali's move after a short delay
            setTimeout(GameLogic.robotMove, 700);
        },

        /**
         * The AI (O) move logic using Minimax.
         */
        robotMove() {
            const availSpots = AppState.board.map((val, i) => val === '' ? i : -1).filter(i => i !== -1);
            
            if (availSpots.length === 0) return GameLogic.gameEnd('Draw', null);

            let bestSpot = -1;
            
            // Heuristic for first move (if user took center, take a corner)
            if (availSpots.length === 8 && AppState.board[4] === 'X') {
                const corners = [0, 2, 6, 8].filter(i => AppState.board[i] === '');
                bestSpot = corners[Math.floor(Math.random() * corners.length)];
            }
            
            // Use Minimax for all other moves for optimal play
            if (bestSpot === -1) {
                bestSpot = GameLogic.minimax(AppState.board, 'O').index;
            }

            // 1. Ali Move (O)
            AppState.board[bestSpot] = 'O';
            const cellEl = document.getElementById(`cell-${bestSpot}`);
            if (cellEl) cellEl.innerHTML = `<span class="marker-O">O</span>`;

            // 2. Check Win after AI move
            let { winner, combo } = GameLogic.checkWin(AppState.board);
            if (winner) return GameLogic.gameEnd(winner, combo); 

            // 3. Switch back to User turn
            AppState.currentPlayer = 'X';
            UILogic.updateTurnDisplay();
            AppState.isGameActive = true; // Re-enable clicks
        },

        /**
         * Minimax algorithm for optimal AI moves.
         * @param {Array<string>} newBoard - The current board state.
         * @param {('X'|'O')} player - The current player for this evaluation step.
         * @returns {{score: number, index: number}} The best move index and its score.
         */
        minimax(newBoard, player) {
            const scores = { X: -10, O: 10, Draw: 0 };
            const { winner } = GameLogic.checkWin(newBoard);
            if (winner) {
                return { score: scores[winner] };
            }

            const availSpots = newBoard.map((val, i) => val === '' ? i : -1).filter(i => i !== -1);
            const moves = [];

            for (let i = 0; i < availSpots.length; i++) {
                const move = {};
                const index = availSpots[i];
                move.index = index;
                newBoard[index] = player;

                if (player === 'O') { 
                    move.score = GameLogic.minimax(newBoard, 'X').score;
                } else { 
                    move.score = GameLogic.minimax(newBoard, 'O').score;
                }

                newBoard[index] = ''; 
                moves.push(move);
            }

            let bestMove = 0;
            if (player === 'O') {
                let bestScore = -Infinity;
                for (let i = 0; i < moves.length; i++) {
                    if (moves[i].score > bestScore) {
                        bestScore = moves[i].score;
                        bestMove = i;
                    }
                }
            } else {
                let bestScore = Infinity;
                for (let i = 0; i < moves.length; i++) {
                    if (moves[i].score < bestScore) {
                        bestScore = moves[i].score;
                        bestMove = i;
                    }
                }
            }

            return moves[bestMove];
        },
        
        /**
         * Checks the board for a win or draw condition.
         * @param {Array<string>} currentBoard - The board state.
         * @returns {{winner: ('X'|'O'|'Draw'|null), combo: (Array<number>|null)}}
         */
        checkWin(currentBoard) {
            for (let i = 0; i < GameLogic.winningConditions.length; i++) {
                const [a, b, c] = GameLogic.winningConditions[i];
                if (currentBoard[a] && currentBoard[a] === currentBoard[b] && currentBoard[a] === currentBoard[c]) {
                    return { winner: currentBoard[a], combo: GameLogic.winningConditions[i] }; 
                }
            }
            if (!currentBoard.includes('')) {
                return { winner: 'Draw', combo: null };
            }
            return { winner: null, combo: null };
        },

        /**
         * Ends the game, displays results, updates stats, and shows the restart overlay.
         * @param {('X'|'O'|'Draw')} winner - The winner or 'Draw'.
         * @param {Array<number>|null} combo - The winning cell indices.
         */
        gameEnd(winner, combo) {
            AppState.isGameActive = false;
            AppState.isGameOver = true;
            
            let title, message, bgColor, borderColor;
            
            if (combo) {
                GameLogic.drawWinningLine(combo, winner);
            }
            
            if (winner === 'X') {
                title = i18n[AppState.currentLang].win_title;
                message = i18n[AppState.currentLang].win_message;
                bgColor = 'rgba(0, 100, 0, 0.9)'; 
                borderColor = WIN_COLOR; 
                FirebaseManager.updateStats('X');
            } else if (winner === 'O') {
                title = i18n[AppState.currentLang].lose_title;
                message = i18n[AppState.currentLang].lose_message;
                bgColor = 'rgba(139, 0, 0, 0.9)'; 
                borderColor = LOSE_COLOR; 
                FirebaseManager.updateStats('O');
            } else { // Draw
                title = i18n[AppState.currentLang].draw_title;
                message = i18n[AppState.currentLang].draw_message;
                bgColor = 'rgba(51, 51, 51, 0.9)'; 
                borderColor = '#e0e0e0';
                FirebaseManager.updateStats('Draw');
            }
            
            // Show toast which manages the rest of the game-end flow (blur, overlay)
            UILogic.showResultToast(title, message, bgColor, borderColor);
        },
        
        /**
         * Draws the winning line using CSS transformations.
         */
        drawWinningLine(combo, winner) {
            const color = winner === 'X' ? WIN_COLOR : LOSE_COLOR;
            const boardEl = DOM.game.board;
            const boardRect = boardEl.getBoundingClientRect();

            const centers = combo.map(i => {
                const cell = document.getElementById(`cell-${i}`);
                const rect = cell.getBoundingClientRect();
                return {
                    x: rect.left + rect.width / 2 - boardRect.left,
                    y: rect.top + rect.height / 2 - boardRect.top
                };
            });

            const start = centers[0];
            const end = centers[2];

            const dx = end.x - start.x;
            const dy = end.y - start.y;
            const length = Math.sqrt(dx * dx + dy * dy) + 30; // Extend line slightly
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;

            const line = document.createElement('div');
            line.classList.add('win-line', 'win-line-active');
            line.style.cssText = `
                background-color: ${color};
                transform: rotate(${angle}deg);
                width: ${length}px;
                height: 15px; /* Thicker line */
                left: ${start.x}px;
                top: ${start.y}px;
                transform-origin: 0% 0%;
                box-shadow: 0 0 20px ${color};
            `;
            DOM.game.winningLine.appendChild(line);
            DOM.game.winningLine.style.color = color;
        },
        
        /**
         * Clears the winning line visualization.
         */
        clearWinningLine() {
            if (DOM.game.winningLine) {
                DOM.game.winningLine.innerHTML = '';
                DOM.game.winningLine.style.color = '';
            }
        }
    };
    
    // ----------------------------------------------------------------------
    // --- 7. APPLICATION INITIALIZATION ---
    // ----------------------------------------------------------------------

    /**
     * Sets up event listeners for all control buttons.
     */
    function setupEventListeners() {
        document.getElementById('start-game-btn').addEventListener('click', GameLogic.startGame);
        document.getElementById('account-btn').addEventListener('click', () => UILogic.showScreen('account'));
        document.getElementById('back-to-menu-btn').addEventListener('click', () => UILogic.showScreen('menu'));
        document.getElementById('end-game-btn').addEventListener('click', (event) => {
            event.preventDefault(); 
            UILogic.showScreen('menu');
        });
        
        DOM.controls.langSwitchBtn.addEventListener('click', UILogic.toggleLanguage);
    }

    /**
     * Main function to initialize the entire application.
     */
    async function AppInit() {
        console.log("AppInit: Starting luxurious Tic-Tac-Toe initialization...");
        
        // 1. Setup UI and Visuals
        GameLogic.generateBoard();
        setupEventListeners();
        UILogic.setLanguage(AppState.currentLang);
        
        // 2. Setup Audio
        AudioManager.init();

        // 3. Initialize Firebase and Authentication
        await FirebaseManager.init();

        // 4. Check for Telegram environment
        if (typeof window.Telegram === 'undefined') {
            console.warn("Telegram Web App environment not detected. Running as standalone web app.");
        } else {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }
        
        console.log("AppInit: Initialization complete. Displaying Menu.");
    }

    // Start the application after all modules are defined
    window.onload = AppInit;

  </script>
</body>
</html>

