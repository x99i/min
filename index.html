<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„Ø¹Ø¨Ø© Ø¥ÙƒØ³ â€” Ø£Ùˆ (X/O) â€” Virus Play</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* --- ØªØµÙ…ÙŠÙ… Ø¹Ø§Ù… ÙˆØ¬Ù…Ø§Ù„ÙŠØ© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¯Ù‚Ø© --- */
    :root{
      --bg-1: linear-gradient(180deg,#05040a,#071224);
      --card: #071428;
      --glass: rgba(255,255,255,0.04);
      --accent: #00b4ff;
      --accent-2: #8a4bff;
      --win: linear-gradient(90deg,#00d681,#00b4ff);
      --lose: linear-gradient(90deg,#ff5c6c,#ff9a6c);
      --muted: #9aa9bf;
      --glass-2: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial,":apple-system";}
    body{
      min-height:100vh;
      background: var(--bg-1);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      color:#e6f0fb;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:420px 1fr;
      gap:24px;
      align-items:start;
    }

    /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:16px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.7);
      border:1px solid rgba(255,255,255,0.03);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{
      width:64px;height:64px;border-radius:14px;
      background:linear-gradient(45deg,var(--accent),var(--accent-2));
      display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px;color:white;
      box-shadow:0 10px 30px rgba(10,14,30,0.6);
    }
    .brand h1{margin:0;font-size:18px}
    .brand p{margin:4px 0 0 0;color:var(--muted);font-size:13px}

    .stars{
      margin-top:18px;
      display:flex;align-items:center;gap:12px;
    }
    .star-badge{
      background:linear-gradient(90deg,#ffd54a,#ffb300);
      color:#1a1a1a;
      padding:10px 14px;border-radius:12px;font-weight:700;display:flex;align-items:center;gap:8px;
      box-shadow:0 8px 18px rgba(255,180,50,0.12);
    }
    .star-badge svg{width:20px;height:20px}

    .controls{margin-top:18px;display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px 14px;border-radius:10px;color:inherit;cursor:pointer;
      transition:all .18s;backdrop-filter: blur(4px);
    }
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#001028;font-weight:700}
    .btn:hover{transform:translateY(-4px);box-shadow:0 8px 18px rgba(0,0,0,0.45)}
    .muted{color:var(--muted);font-size:13px;margin-top:12px}

    /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø¹Ø¨Ø© */
    .game-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border-radius:16px;padding:18px;border:1px solid rgba(255,255,255,0.03);
      box-shadow:0 10px 30px rgba(1,6,20,0.6);
      display:flex;flex-direction:column;height:720px;
    }

    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .top-left{display:flex;gap:12px;align-items:center}
    .you{display:flex;flex-direction:column}
    .you strong{font-size:15px}
    .desc{color:var(--muted);font-size:13px}

    /* Ø§Ù„Ù„ÙˆØ­Ø© 3x3 */
    .board-wrap{
      margin-top:18px;display:flex;align-items:center;justify-content:center;flex:1;
    }

    .board{
      width:min(520px,90vw);
      height:min(520px,90vw);
      max-width:520px;max-height:520px;
      display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);
      gap:14px;padding:18px;border-radius:18px;background:linear-gradient(180deg,#071828,#0b2130);
      box-shadow: inset 0 2px 12px rgba(0,0,0,0.6);
      transition:transform .12s ease;
    }

    .cell{
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;
      position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.03);
      transition:all .16s ease;
    }
    .cell:hover{transform:translateY(-6px) scale(1.02)}
    .cell.disabled{cursor:not-allowed;opacity:0.8;transform:none}

    /* X and O graphics (SVG animated) */
    .mark{
      width:72%;height:72%;display:flex;align-items:center;justify-content:center;
      transform:scale(0.01);opacity:0;transition:transform .32s cubic-bezier(.2,.9,.2,1),opacity .18s;
    }
    .cell.played .mark{transform:scale(1);opacity:1}
    .mark.x svg{filter:drop-shadow(0 8px 20px rgba(17,119,255,0.12))}
    .mark.o svg{filter:drop-shadow(0 8px 20px rgba(0,220,130,0.09))}

    /* highlight winning line */
    .line{
      position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;
    }
    .line svg{width:100%;height:100%;opacity:0;transition:opacity .22s}
    .line.show svg{opacity:1}

    /* bottom area */
    .info-bar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:14px}
    .result-badge{padding:10px 14px;border-radius:10px;font-weight:700}
    .result-badge.win{background:var(--win);color:#00221a}
    .result-badge.lose{background:var(--lose);color:#2d0010}
    .result-badge.draw{background:linear-gradient(90deg,#b6b6b6,#dfe6ee);color:#0b1722}

    /* confetti canvas */
    canvas.confetti{position:absolute;pointer-events:none;left:0;top:0;width:100%;height:100%;z-index:80}

    /* responsive */
    @media (max-width:920px){
      .wrap{grid-template-columns:1fr;max-width:920px}
      .game-card{height:auto}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Ø¬Ø§Ù†Ø¨ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ… + ØªØ­ÙƒÙ…Ø§Øª) -->
    <div class="panel">
      <div class="brand">
        <div class="logo">VP</div>
        <div>
          <h1>@virus_play_bot</h1>
          <p class="desc">Ù„Ø¹Ø¨Ø© X/O â€” Ø§Ù„Ø¹Ø¨ Ù…Ø¹ Ø±ÙˆØ¨ÙˆØª Ø°ÙƒÙŠ. Ø§Ù„Ù†Ø¬ÙˆÙ… ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
        </div>
      </div>

      <div class="stars">
        <div class="star-badge" id="starBadge">
          <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
            <path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.787 1.4 8.168L12 18.896l-7.334 3.869 1.4-8.168L.132 9.21l8.2-1.192z"/>
          </svg>
          <span id="starsCount">0</span>
        </div>

        <div style="flex:1">
          <div style="font-size:13px;color:var(--muted)">Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ…</div>
          <div style="font-weight:700;font-size:16px">Ø§Ù„Ù†Ø¬ÙˆÙ… ØªØ¹ÙƒØ³ Ù†ØªØ§Ø¦Ø¬ ÙÙˆØ²Ùƒ/Ø®Ø³Ø§Ø±ØªÙƒ</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn primary" id="newGameBtn">ğŸ” Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <button class="btn" id="undoBtn">â†¶ ØªØ±Ø§Ø¬Ø¹</button>
        <button class="btn" id="switchBtn">ğŸ¤– Ø£Ù†Øª Ø£ÙˆÙ„</button>
        <button class="btn" id="resetStars">â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø±ØµÙŠØ¯</button>
        <button class="btn" id="sendToBotBtn">ğŸ“¡ Ø£Ø±Ø³Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¨ÙˆØª</button>
      </div>

      <div class="muted">
        â€¢ Ø§Ù„Ø¨ÙˆØª Ø°ÙƒÙŠ (Minimax) â€” Ø¹Ø§Ø¯Ø© Ù„Ø§ ÙŠØ®Ø³Ø±.<br>
        â€¢ Ø§Ù„ÙÙˆØ² = +1ØŒ Ø§Ù„Ø®Ø³Ø§Ø±Ø© = -1ØŒ Ø§Ù„ØªØ¹Ø§Ø¯Ù„ = Ù„Ø§ ØªØºÙŠÙŠØ±.<br>
        â€¢ Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ (localStorage) ÙˆØ¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¨ÙˆØª.
      </div>
    </div>

    <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="game-card" id="gameCard">
      <div class="topbar">
        <div class="top-left">
          <div style="display:flex;gap:12px;align-items:center">
            <div style="width:64px;height:64px;border-radius:12px;background:linear-gradient(90deg,#0f8fe0,#6c2cff);display:flex;align-items:center;justify-content:center;font-weight:700">X</div>
            <div class="you">
              <strong id="playerTitle">Ø£Ù†Øª â€” X</strong>
              <div class="desc">Ø§Ù„Ø¹Ø¨ Ø¶Ø¯ Ø§Ù„Ø±ÙˆØ¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ</div>
            </div>
          </div>
        </div>

        <div>
          <div id="statusText" class="desc">Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©: Ø¬Ø§Ù‡Ø²</div>
        </div>
      </div>

      <div class="board-wrap">
        <div class="board" id="board">
          <!-- 9 Ø®Ù„Ø§ÙŠØ§ -->
          <div class="cell" data-i="0"><div class="mark x"><svg viewBox="0 0 100 100"><path d="M20 20 L80 80" stroke="#0ea5ff" stroke-width="12" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
          <div class="cell" data-i="1"><div class="mark o"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" stroke="#00d681" stroke-width="10" fill="none" stroke-linecap="round"/></svg></div></div>
          <div class="cell" data-i="2"><div class="mark x"><svg viewBox="0 0 100 100"><path d="M20 20 L80 80" stroke="#0ea5ff" stroke-width="12" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
          <div class="cell" data-i="3"><div class="mark o"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" stroke="#00d681" stroke-width="10" fill="none" /></svg></div></div>
          <div class="cell" data-i="4"><div class="mark x"><svg viewBox="0 0 100 100"><path d="M20 20 L80 80" stroke="#0ea5ff" stroke-width="12" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
          <div class="cell" data-i="5"><div class="mark o"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" stroke="#00d681" stroke-width="10" fill="none" /></svg></div></div>
          <div class="cell" data-i="6"><div class="mark x"><svg viewBox="0 0 100 100"><path d="M20 20 L80 80" stroke="#0ea5ff" stroke-width="12" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>
          <div class="cell" data-i="7"><div class="mark o"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" stroke="#00d681" stroke-width="10" fill="none" /></svg></div></div>
          <div class="cell" data-i="8"><div class="mark x"><svg viewBox="0 0 100 100"><path d="M20 20 L80 80" stroke="#0ea5ff" stroke-width="12" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div>

          <!-- winning line overlay -->
          <div class="line" id="winLine" aria-hidden="true"></div>
        </div>
      </div>

      <div class="info-bar">
        <div>
          <div id="resultBadge" class="result-badge draw">Ø§Ù„Ù†ØªÙŠØ¬Ø©: -</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="desc">Ø§Ù„Ø­Ø±ÙƒØ§Øª: <span id="moveCount">0</span></div>
          <div class="desc">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <strong id="difficulty">Ø°ÙƒÙŠ</strong></div>
        </div>
      </div>
    </div>
  </div>

  <!-- confetti canvas -->
  <canvas class="confetti" id="confettiCanvas"></canvas>

<script>
/* -------------------------
   Ù„Ø¹Ø¨Ø© X/O Ù…Ø¹ Minimax (Ø°ÙƒÙŠ)
   Ø­ÙØ¸ Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ… ÙÙŠ localStorage
   Ø¯Ø¹Ù… Telegram WebApp (Ø¥Ø°Ø§ Ù…ØªÙˆÙØ±)
   ------------------------- */

const tg = window.Telegram?.WebApp || null;
if (tg){
  try { tg.expand(); } catch(e){}
}

/* ---------- Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù€ DOM ---------- */
const boardEl = document.getElementById('board');
const cells = Array.from(document.querySelectorAll('.cell'));
const newGameBtn = document.getElementById('newGameBtn');
const undoBtn = document.getElementById('undoBtn');
const switchBtn = document.getElementById('switchBtn');
const resetStarsBtn = document.getElementById('resetStars');
const sendToBotBtn = document.getElementById('sendToBotBtn');
const starsCountEl = document.getElementById('starsCount');
const starBadge = document.getElementById('starBadge');
const statusText = document.getElementById('statusText');
const resultBadge = document.getElementById('resultBadge');
const moveCountEl = document.getElementById('moveCount');

let board = Array(9).fill(null); // null, 'X', 'O'
let playerMark = 'X'; // player is X by default
let aiMark = 'O';
let isPlayerTurn = true;
let gameOver = false;
let moveHistory = [];
let moveCount = 0;

/* stars in localStorage */
const STORAGE_KEY = 't3_stars_vp';
let stars = Number(localStorage.getItem(STORAGE_KEY) || 0);
updateStarsUI();

/* ---------- Minimax algorithm (optimal AI) ---------- */
/* Returns best move index for aiMark on current board */
function bestMoveMinimax(currentBoard, aiPlayer) {
  // possible winners
  const wins = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];

  function checkWinner(b) {
    for (const [a,b1,c] of wins){
      if (b[a] && b[a] === b[b1] && b[a] === b[c]) return b[a];
    }
    if (b.every(Boolean)) return 'draw';
    return null;
  }

  function scores(winner, depth) {
    if (winner === aiPlayer) return 10 - depth;
    if (winner === null) return null;
    if (winner === 'draw') return 0;
    return depth - 10; // opponent wins => negative
  }

  function minimax(bd, depth, isMaximizing) {
    const winner = checkWinner(bd);
    if (winner) return scores(winner, depth);

    let best = isMaximizing ? -Infinity : +Infinity;

    const player = isMaximizing ? aiPlayer : (aiPlayer === 'X' ? 'O' : 'X');

    for (let i=0;i<9;i++){
      if (!bd[i]){
        bd[i] = isMaximizing ? aiPlayer : (aiPlayer === 'X' ? 'O' : 'X');
        const val = minimax(bd, depth+1, !isMaximizing);
        bd[i] = null;
        if (isMaximizing) best = Math.max(best, val);
        else best = Math.min(best, val);
      }
    }
    return best;
  }

  let bestVal = -Infinity;
  let bestIdx = -1;
  for (let i=0;i<9;i++){
    if (!currentBoard[i]){
      currentBoard[i] = aiPlayer;
      const val = minimax(currentBoard, 0, false);
      currentBoard[i] = null;
      if (val > bestVal){ bestVal = val; bestIdx = i; }
    }
  }

  // if bestIdx stayed -1 (empty board?), pick center or random
  if (bestIdx === -1){
    if (!currentBoard[4]) return 4;
    const empties = currentBoard.map((v,i)=> v?null:i).filter(Number.isFinite);
    return empties[Math.floor(Math.random()*empties.length)];
  }
  return bestIdx;
}

/* ---------- Helpers ---------- */
function updateStarsUI(){
  starsCountEl.textContent = stars;
  // small pulse animation
  starBadge.animate([{ transform:'scale(0.98)' }, { transform:'scale(1)' }], { duration:220, easing:'cubic-bezier(.2,.9,.2,1)' });
  localStorage.setItem(STORAGE_KEY, String(stars));
}

function renderBoard(){
  for (let i=0;i<9;i++){
    const el = cells[i];
    el.classList.remove('played','disabled');
    const mark = board[i];
    if (mark){
      el.classList.add('played','disabled');
      // set class of mark element
      const markEl = el.querySelector('.mark');
      markEl.classList.remove('x','o');
      markEl.classList.add(mark === 'X' ? 'x' : 'o');
    } else {
      el.classList.remove('played');
      el.classList.remove('disabled');
    }
  }
  moveCountEl.textContent = moveCount;
}

function checkGameEnd(b){
  const wins = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];
  for (const line of wins){
    const [a,b1,c] = line;
    if (b[a] && b[a] === b[b1] && b[a] === b[c]) return { winner: b[a], line };
  }
  if (b.every(Boolean)) return { winner: 'draw' };
  return null;
}

function highlightLine(line){
  const winLine = document.getElementById('winLine');
  // draw SVG line according to cells positions
  const rect = boardEl.getBoundingClientRect();
  const positions = cells.map(c => {
    const r = c.getBoundingClientRect();
    return { x: r.left + r.width/2 - rect.left, y: r.top + r.height/2 - rect.top };
  });
  const [a,b,c] = line;
  const x1 = positions[a].x, y1 = positions[a].y;
  const x2 = positions[c].x, y2 = positions[c].y;
  winLine.innerHTML = `
    <svg viewBox="0 0 ${rect.width} ${rect.height}" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="g" x1="0" x2="1">
          <stop offset="0" stop-color="#ffd54a"/>
          <stop offset="1" stop-color="#ff5c6c"/>
        </linearGradient>
      </defs>
      <line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="url(#g)" stroke-width="${Math.max(8, rect.width*0.03)}" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
  `;
  winLine.classList.add('show');
  setTimeout(()=> winLine.classList.remove('show'), 3000);
}

/* ---------- Game actions ---------- */
function startNewGame(firstIsPlayer=true){
  board = Array(9).fill(null);
  gameOver = false;
  moveHistory = [];
  moveCount = 0;
  isPlayerTurn = firstIsPlayer;
  resultBadge.textContent = 'Ø§Ù„Ù†ØªÙŠØ¬Ø©: -';
  resultBadge.className = 'result-badge draw';
  statusText.textContent = isPlayerTurn ? 'Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†' : 'Ø¯ÙˆØ± Ø§Ù„Ø±ÙˆØ¨ÙˆØª';
  renderBoard();
  if (!isPlayerTurn){
    setTimeout(() => aiMove(), 450);
  }
}

function makeMove(idx, mark){
  if (gameOver || board[idx]) return false;
  board[idx] = mark;
  moveHistory.push({ idx, mark });
  moveCount++;
  renderBoard();
  const end = checkGameEnd(board);
  if (end){
    gameOver = true;
    handleGameEnd(end);
  } else {
    isPlayerTurn = (mark !== playerMark);
    statusText.textContent = isPlayerTurn ? 'Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†' : 'Ø¯ÙˆØ± Ø§Ù„Ø±ÙˆØ¨ÙˆØª';
  }
  return true;
}

function aiMove(){
  if (gameOver) return;
  // intelligent move via Minimax
  const idx = bestMoveMinimax(board.slice(), aiMark);
  makeMove(idx, aiMark);
}

/* ---------- handle result & stars ---------- */
function handleGameEnd(end){
  if (end.winner === 'draw'){
    resultBadge.textContent = 'Ø§Ù„Ù†ØªÙŠØ¬Ø©: ØªØ¹Ø§Ø¯Ù„';
    resultBadge.className = 'result-badge draw';
    statusText.textContent = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© â€” ØªØ¹Ø§Ø¯Ù„';
    // send to bot possible
    notifyBot('draw');
  } else {
    const winner = end.winner;
    highlightLine(end.line);
    if (winner === playerMark){
      resultBadge.textContent = 'Ø§Ù„Ù†ØªÙŠØ¬Ø©: ÙÙˆØ²Ùƒ! +1 â­';
      resultBadge.className = 'result-badge win';
      statusText.textContent = 'Ø£Ù†Øª Ø§Ù„ÙØ§Ø¦Ø²!';
      stars += 1;
      updateStarsUI();
      fireConfetti();
      notifyBot('win');
    } else {
      resultBadge.textContent = 'Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø®Ø³Ø±Øª! -1';
      resultBadge.className = 'result-badge lose';
      statusText.textContent = 'ÙØ§Ø² Ø§Ù„Ø±ÙˆØ¨ÙˆØª';
      stars -= 1; // ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØµØ¨Ø­ Ø³Ø§Ù„Ø¨
      updateStarsUI();
      notifyBot('lose');
    }
  }
}

/* ---------- notify bot via Telegram WebApp (Ø¥Ø°Ø§ Ù…ØªÙˆÙØ±) ---------- */
function notifyBot(result){
  const payload = {
    event: 't3_result',
    result: result, // 'win' | 'lose' | 'draw'
    stars: stars,
    timestamp: Date.now()
  };
  // Ù„Ùˆ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆÙŠØ¨ Ø¢Ø¨
  if (tg && tg.sendData){
    try {
      tg.sendData(JSON.stringify(payload));
    } catch(e){
      console.warn('tg.sendData failed', e);
    }
  }
}

/* ---------- Undo (Ø¨Ø³ÙŠØ·) ---------- */
function undoLast(){
  if (moveHistory.length === 0 || gameOver) return;
  // Ù†Ø­Ø°Ù Ø¢Ø®Ø± Ø­Ø±ÙƒØ©ÙŠÙ† (Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ø¹Ø¨ Ø«Ù… Ø§Ù„Ø±ÙˆØ¨ÙˆØª Ù„Ø¹Ø¨)
  const last = moveHistory.pop();
  board[last.idx] = null;
  moveCount--;
  // Ù„Ùˆ Ø¢Ø®Ø± ÙƒØ§Ù† Ø§Ù„Ø±ÙˆØ¨ÙˆØª ÙˆÙ†Ø¨Ù‚Ù‰ Ø¨Ø­Ø§Ø¬Ø© Ù„Ø­Ø°Ù Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£ÙŠØ¶Ø§
  if (moveHistory.length > 0 && moveHistory[moveHistory.length-1].mark !== last.mark){
    const last2 = moveHistory.pop();
    board[last2.idx] = null;
    moveCount--;
  }
  gameOver = false;
  isPlayerTurn = true;
  statusText.textContent = 'ØªØ±Ø§Ø¬Ø¹ â€” Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†';
  renderBoard();
}

/* ---------- confetti effect ---------- */
const confCanvas = document.getElementById('confettiCanvas');
const ctx = confCanvas.getContext('2d');
let confettiActive = false;
function resizeCanvas(){ confCanvas.width = confCanvas.clientWidth; confCanvas.height = confCanvas.clientHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function fireConfetti(){
  if (confettiActive) return;
  confettiActive = true;
  const pieces = [];
  const W = confCanvas.width, H = confCanvas.height;
  for (let i=0;i<120;i++){
    pieces.push({
      x: Math.random()*W,
      y: -Math.random()*H*0.5,
      vx: (Math.random()-0.5)*4,
      vy: 2+Math.random()*6,
      r: 6+Math.random()*8,
      color: `hsl(${Math.random()*360}deg 70% 60%)`,
      rot: Math.random()*360,
      dr: (Math.random()-0.5)*6
    });
  }
  let t = 0;
  function frame(){
    ctx.clearRect(0,0,W,H);
    for (const p of pieces){
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.dr;
      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot*Math.PI/180);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r);
      ctx.restore();
    }
    t += 1;
    if (t < 160){
      requestAnimationFrame(frame);
    } else {
      ctx.clearRect(0,0,W,H);
      confettiActive = false;
    }
  }
  frame();
}

/* ---------- Ø£Ø­Ø¯Ø§Ø« DOM ---------- */
cells.forEach(c => {
  c.addEventListener('click', () => {
    const idx = Number(c.dataset.i);
    if (gameOver || board[idx] || !isPlayerTurn) return;
    makeMove(idx, playerMark);
    // Ø¨Ø¹Ø¯ Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ØŒ Ø¯Ø¹ Ø§Ù„Ø±ÙˆØ¨ÙˆØª ÙŠØªØ­Ø±Ùƒ Ø¨Ø¹Ø¯ ØªØ£Ø«ÙŠØ±
    if (!gameOver){
      setTimeout(()=> { aiMove(); }, 450);
    }
  });
});

newGameBtn.addEventListener('click', () => startNewGame(isPlayerTurn));
undoBtn.addEventListener('click', () => undoLast());
switchBtn.addEventListener('click', () => {
  // Ù†Ù‚Ù„Ø¨ Ø§Ù„Ø¨Ø§Ø¯Ø¦: Ø¥Ø°Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙŠØ¨Ø¯Ø£ØŒ Ù†Ø¨Ø¯Ù„Ù‡ ÙˆØ¬Ø¹Ù„ Ø§Ù„Ø±ÙˆØ¨ÙˆØª ÙŠØ¨Ø¯Ø£
  isPlayerTurn = !isPlayerTurn;
  playerMark = isPlayerTurn ? 'X' : 'O';
  aiMark = playerMark === 'X' ? 'O' : 'X';
  document.getElementById('playerTitle').textContent = `Ø£Ù†Øª â€” ${playerMark}`;
  switchBtn.textContent = isPlayerTurn ? 'ğŸ¤– Ø£Ù†Øª Ø£ÙˆÙ„' : 'ğŸ§  Ø§Ù„Ø±ÙˆØ¨ÙˆØª ÙŠØ¨Ø¯Ø£';
  startNewGame(isPlayerTurn);
});

resetStarsBtn.addEventListener('click', () => {
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ… Ø¥Ù„Ù‰ 0ØŸ')) return;
  stars = 0; updateStarsUI();
});

sendToBotBtn.addEventListener('click', () => {
  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©/Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ù„Ø¨ÙˆØª
  notifyBot('manual');
  alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±ØµÙŠØ¯/Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª (Ø¥Ø°Ø§ ÙƒÙ†Øª Ø¯Ø§Ø®Ù„ Telegram).');
});

/* ---------- init ---------- */
startNewGame(true);

/* ---------- ÙˆØ§Ø¬Ù‡Ø© ØµØºÙŠØ±Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙˆÙŠØ¨ Ø¢Ø¨ ---------- */
// Ù„Ùˆ Ø¯Ø§Ø®Ù„ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…: Ù†Ø¸Ù‡Ø± Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙƒÙ„ Ù†ØªÙŠØ¬Ø© (ØªÙ… ÙØ¹Ù„Ù‡ ÙÙŠ handleGameEnd)
if (!tg){
  // Ù…Ø­Ù„ÙŠØ§Ù‹: Ù†Ø¹Ø±Ø¶ ØªÙ„Ù…ÙŠØ­Ø§Øª
  console.log('ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù„ÙŠØ³ Ø¯Ø§Ø®Ù„ Telegram WebApp).');
}
</script>
</body>
  </html>
