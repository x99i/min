<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„Ø¹Ø¨Ø© Ø¥ÙƒØ³ Ø£Ùˆ Ø¶Ø¯ Ø§Ù„Ø±ÙˆØ¨ÙˆØª</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- Load Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Set global variables for use in the main script
    window.initializeApp = initializeApp;
    window.getAuth = getAuth;
    window.signInAnonymously = signInAnonymously;
    window.signInWithCustomToken = signInWithCustomToken;
    window.onAuthStateChanged = onAuthStateChanged;
    window.getFirestore = getFirestore;
    window.doc = doc;
    window.onSnapshot = onSnapshot;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.collection = collection;
    window.setPersistence = setPersistence;
    window.browserLocalPersistence = browserLocalPersistence;
  </script>

  <style>
    /* Tailwind Configuration */
    /* Dark Theme Setup for a gaming look */
    body {
      background-color: #121212; /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© */
      color: #e0e0e0;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* General Button Styling */
    .game-button {
      transition: all 0.2s ease;
      background-color: #212121; /* Ù„ÙˆÙ† Ø²Ø± Ø¯Ø§ÙƒÙ† */
      border: 2px solid #333;
      color: #00ff73; /* Ù„ÙˆÙ† Ù†Øµ Ø£Ø®Ø¶Ø± Ø³Ø§Ø·Ø¹ */
      box-shadow: 0 4px #00a04d; /* Ø¸Ù„ Ø³ÙÙ„ÙŠ Ù„Ù„Ø¹Ù…Ù‚ */
    }

    .game-button:hover {
      background-color: #333;
      box-shadow: 0 2px #00a04d;
      transform: translateY(2px);
    }
    
    /* Board Cell Styling */
    .cell {
      background-color: #1e1e1e; /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø®Ù„ÙŠØ© */
      border: 3px solid #333; /* Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ù„ÙŠØ© */
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 4rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }

    /* Custom X and O styles */
    .marker-X {
      color: #00ff73; /* X Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± */
      font-weight: 900;
      text-shadow: 0 0 10px rgba(0, 255, 115, 0.5);
    }
    
    .marker-O {
      color: #ff3d00; /* O Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± */
      font-weight: 900;
      text-shadow: 0 0 10px rgba(255, 61, 0, 0.5);
    }
    
    /* Modal/Overlay Styling */
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
    }

    /* Game Board Blur for post-game screen */
    .blur-game {
      filter: blur(5px);
      pointer-events: none;
      transition: filter 0.5s ease;
    }

  </style>
</head>
<body class="p-4">

  <!-- Main App Container -->
  <div id="app" class="w-full max-w-sm mx-auto bg-card-dark p-6 rounded-2xl shadow-2xl">
    
    <!-- Loading and Error Screen -->
    <div id="loading-screen" class="flex flex-col items-center justify-center h-80 text-center">
      <i class="ph ph-circle-notch animate-spin text-4xl text-gray-500"></i>
      <p class="mt-4 text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <!-- MAIN MENU SCREEN -->
    <div id="menu-screen" class="hidden text-center">
      <h1 class="text-3xl font-bold mb-8 text-white">Ø¥ÙƒØ³ Ø£Ùˆ Ø¶Ø¯ Ø§Ù„Ø±ÙˆØ¨ÙˆØª</h1>
      
      <div class="space-y-4">
        <button id="start-game-btn" class="game-button w-full px-6 py-4 rounded-xl text-lg font-bold">
          Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© <i class="ph ph-sword ml-2"></i>
        </button>
        <button id="account-btn" class="game-button w-full px-6 py-4 rounded-xl text-lg font-bold">
          Ø­Ø³Ø§Ø¨ÙŠ <i class="ph ph-user-circle ml-2"></i>
        </button>
      </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="hidden">
      <div id="game-status-bar" class="text-center mb-4 p-2 rounded-lg bg-[#2a2a2a]">
        <p class="text-lg font-semibold text-accent-green">
          <span id="turn-display">Ø¯ÙˆØ±Ùƒ (X)</span>
        </p>
      </div>
      
      <div id="game-board-container" class="relative">
        <!-- Game Board (The grid) -->
        <div id="game-board" class="grid grid-cols-3 aspect-square max-w-sm mx-auto p-2 bg-[#2a2a2a] rounded-lg">
          <!-- Cells will be generated by JS -->
        </div>

        <!-- Restart Overlay (Hidden by default) -->
        <div id="restart-overlay" class="hidden absolute inset-0 flex flex-col justify-center items-center modal-overlay rounded-lg">
          <p class="text-2xl font-bold mb-6">Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù†ØªÙ‡Øª!</p>
          <button id="restart-game-btn" class="game-button px-8 py-4 rounded-xl text-xl font-bold">
            Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
          </button>
        </div>
      </div>
    </div>

    <!-- ACCOUNT SCREEN -->
    <div id="account-screen" class="hidden">
      <h2 class="text-2xl font-bold mb-6 text-center text-white">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
      
      <div class="bg-[#2a2a2a] p-4 rounded-xl space-y-4">
        <!-- Stars Balance -->
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
          <span class="text-lg font-semibold">Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ…:</span>
          <span id="account-stars" class="text-2xl font-bold marker-X flex items-center">
            0 <i class="ph ph-star-fill text-xl mr-1"></i>
          </span>
        </div>

        <!-- Wins and Losses -->
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
          <span class="text-lg font-semibold">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ²:</span>
          <span id="account-wins" class="text-xl font-bold text-[#00ff73]">0</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
          <span class="text-lg font-semibold">Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø³Ø§Ø±Ø©:</span>
          <span id="account-losses" class="text-xl font-bold text-[#ff3d00]">0</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
          <span class="text-lg font-semibold">Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ø§Ø¯Ù„:</span>
          <span id="account-draws" class="text-xl font-bold text-gray-400">0</span>
        </div>

        <!-- Dates -->
        <div class="text-sm text-gray-400 pt-2 border-t border-gray-700 space-y-2">
          <p>ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ù„Ø¹Ø¨Ø©: <span id="account-first-game" class="font-mono">N/A</span></p>
          <p>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù„Ø¹Ø¨Ø©: <span id="account-last-game" class="font-mono">N/A</span></p>
        </div>
      </div>
      
      <button id="back-to-menu-btn" class="game-button w-full mt-6 px-6 py-3 rounded-xl text-lg font-bold">
        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      </button>
    </div>

  </div>

  <!-- RESULT MODAL (Hidden by default) -->
  <div id="result-modal" class="fixed inset-0 hidden modal-overlay justify-center items-center z-50">
    <div class="bg-[#1e1e1e] p-8 rounded-xl shadow-2xl text-center w-11/12 max-w-sm border-2 border-accent-green">
      <h3 id="modal-title" class="text-3xl font-extrabold mb-4"></h3>
      <p id="modal-message" class="text-lg mb-6 text-gray-300"></p>
      <button id="modal-ok-btn" class="game-button px-6 py-3 rounded-lg text-lg font-bold">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>


  <script type="module">
    // Firebase Setup Variables (MANDATORY)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // Global Firebase and Firestore references
    let db, auth, userId;
    let statsRef;

    // Game State
    let board = ['', '', '', '', '', '', '', '', ''];
    let currentPlayer = 'X'; // User starts first
    let isGameActive = false;
    let isGameOver = false;

    // User Data State
    let userStats = {
      stars: 0,
      wins: 0,
      losses: 0,
      draws: 0,
      firstGameDate: 'N/A',
      lastGameDate: 'N/A'
    };

    // DOM Elements
    const screens = {
      loading: document.getElementById('loading-screen'),
      menu: document.getElementById('menu-screen'),
      game: document.getElementById('game-screen'),
      account: document.getElementById('account-screen')
    };
    const boardEl = document.getElementById('game-board');
    const turnDisplay = document.getElementById('turn-display');
    const restartOverlay = document.getElementById('restart-overlay');
    const gameBoardContainer = document.getElementById('game-board-container');
    const resultModal = document.getElementById('result-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');

    // Utility to format date
    const formatDate = (timestamp) => {
      if (timestamp === 'N/A' || !timestamp) return 'N/A';
      try {
        const date = new Date(timestamp);
        return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      } catch (e) {
        return timestamp;
      }
    };

    // --- FIREBASE AND STATE MANAGEMENT ---

    async function initializeFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // Set persistence to browser local storage
        await setPersistence(auth, browserLocalPersistence);

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            statsRef = doc(db, `/artifacts/${appId}/users/${userId}/tictactoe/stats`);
            console.log("Firebase initialized. User ID:", userId);
            loadStats();
          } else {
            console.log("No user signed in. Signing in anonymously...");
            await (initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth));
          }
        });

      } catch (error) {
        console.error("Firebase Initialization Error:", error);
        showScreen('menu'); // Fallback to menu if Firebase fails
      }
    }

    function loadStats() {
      // Listen for real-time updates to user stats
      onSnapshot(statsRef, (docSnap) => {
        if (docSnap.exists()) {
          userStats = docSnap.data();
          console.log("Stats loaded:", userStats);
        } else {
          // If no data, set initial structure
          console.log("No stats found. Initializing...");
          userStats = {
            stars: 0,
            wins: 0,
            losses: 0,
            draws: 0,
            firstGameDate: 'N/A',
            lastGameDate: 'N/A'
          };
          // Do not write until the first game is played
        }
        updateAccountScreen();
        showScreen('menu'); // Show menu after loading stats
      }, (error) => {
        console.error("Firestore Snapshot Error:", error);
        showScreen('menu'); // Proceed to menu even with error
      });
    }

    async function updateStats(result) {
      const now = new Date().toISOString();
      const isNewUser = userStats.firstGameDate === 'N/A';
      
      let starsChange = 0;
      if (result === 'X') { // User Win
        starsChange = 1;
        userStats.wins++;
      } else if (result === 'O') { // Robot Win
        starsChange = -1;
        userStats.losses++;
      } else { // Draw
        userStats.draws++;
      }

      userStats.stars = (userStats.stars || 0) + starsChange;
      userStats.lastGameDate = now;
      if (isNewUser) {
        userStats.firstGameDate = now;
      }

      try {
        if (isNewUser) {
          await setDoc(statsRef, userStats);
          console.log("Initial Stats set for new user.");
        } else {
          await updateDoc(statsRef, userStats);
          console.log("Stats updated successfully.");
        }
        updateAccountScreen();
      } catch (e) {
        console.error("Error updating stats:", e);
      }
    }

    function updateAccountScreen() {
      document.getElementById('account-stars').innerHTML = `${userStats.stars} <i class="ph ph-star-fill text-xl mr-1"></i>`;
      // Set text color based on stars balance
      const starsEl = document.getElementById('account-stars');
      starsEl.classList.remove('marker-X', 'marker-O', 'text-gray-400');
      if (userStats.stars > 0) {
        starsEl.classList.add('marker-X');
      } else if (userStats.stars < 0) {
        starsEl.classList.add('marker-O');
      } else {
        starsEl.classList.add('text-gray-400');
      }
      
      document.getElementById('account-wins').textContent = userStats.wins;
      document.getElementById('account-losses').textContent = userStats.losses;
      document.getElementById('account-draws').textContent = userStats.draws;
      document.getElementById('account-first-game').textContent = formatDate(userStats.firstGameDate);
      document.getElementById('account-last-game').textContent = formatDate(userStats.lastGameDate);
    }

    function showScreen(screenName) {
      Object.values(screens).forEach(el => el.classList.add('hidden'));
      if (screens[screenName]) {
        screens[screenName].classList.remove('hidden');
      }
      // Reset game state when leaving game screen
      if (screenName !== 'game') {
        isGameActive = false;
        gameBoardContainer.classList.remove('blur-game');
      }
    }

    // --- GAME LOGIC ---

    const winningConditions = [
      [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
      [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
      [0, 4, 8], [2, 4, 6]            // Diagonals
    ];

    function checkWin(currentBoard) {
      for (let i = 0; i < winningConditions.length; i++) {
        const [a, b, c] = winningConditions[i];
        if (currentBoard[a] && currentBoard[a] === currentBoard[b] && currentBoard[a] === currentBoard[c]) {
          return currentBoard[a]; // Returns 'X' or 'O'
        }
      }
      if (!currentBoard.includes('')) {
        return 'Draw';
      }
      return null;
    }

    function handleMove(clickedCellIndex) {
      if (!isGameActive || board[clickedCellIndex] !== '' || isGameOver) {
        return;
      }

      // User Move (X)
      board[clickedCellIndex] = 'X';
      document.getElementById(`cell-${clickedCellIndex}`).innerHTML = `<span class="marker-X">X</span>`;
      
      let result = checkWin(board);
      if (result) {
        return gameEnd(result);
      }
      
      currentPlayer = 'O';
      turnDisplay.textContent = 'Ø¯ÙˆØ± Ø§Ù„Ø±ÙˆØ¨ÙˆØª (O)';
      isGameActive = false; // Pause for AI
      
      // Robot move after a short delay
      setTimeout(robotMove, 700);
    }

    // --- SMART AI (Minimax Algorithm) ---
    
    // Core Minimax function (simplified for Tic-Tac-Toe)
    function minimax(newBoard, player) {
      const availSpots = newBoard.map((val, i) => val === '' ? i : -1).filter(i => i !== -1);
      
      // Base cases
      if (checkWin(newBoard) === 'X') return { score: -10 };
      if (checkWin(newBoard) === 'O') return { score: 10 };
      if (availSpots.length === 0) return { score: 0 };

      const moves = [];

      for (let i = 0; i < availSpots.length; i++) {
        const move = {};
        const index = availSpots[i];
        move.index = index;
        newBoard[index] = player;

        if (player === 'O') {
          const result = minimax(newBoard, 'X');
          move.score = result.score;
        } else {
          const result = minimax(newBoard, 'O');
          move.score = result.score;
        }

        newBoard[index] = ''; // Reset the spot
        moves.push(move);
      }

      // Find the best move
      let bestMove;
      if (player === 'O') {
        let bestScore = -Infinity;
        for (let i = 0; i < moves.length; i++) {
          if (moves[i].score > bestScore) {
            bestScore = moves[i].score;
            bestMove = i;
          }
        }
      } else {
        let bestScore = Infinity;
        for (let i = 0; i < moves.length; i++) {
          if (moves[i].score < bestScore) {
            bestScore = moves[i].score;
            bestMove = i;
          }
        }
      }

      return moves[bestMove];
    }

    function robotMove() {
      const availSpots = board.map((val, i) => val === '' ? i : -1).filter(i => i !== -1);
      
      if (availSpots.length === 0) {
        return gameEnd('Draw');
      }

      // Use Minimax to find the best spot
      const bestSpot = minimax(board, 'O').index;

      // Robot Move (O)
      board[bestSpot] = 'O';
      document.getElementById(`cell-${bestSpot}`).innerHTML = `<span class="marker-O">O</span>`;

      let result = checkWin(board);
      if (result) {
        return gameEnd(result);
      }

      currentPlayer = 'X';
      turnDisplay.textContent = 'Ø¯ÙˆØ±Ùƒ (X)';
      isGameActive = true;
    }
    
    // --- GAME FLOW AND UI ---

    function startGame() {
      board = ['', '', '', '', '', '', '', '', ''];
      currentPlayer = 'X';
      isGameActive = true;
      isGameOver = false;
      showScreen('game');
      turnDisplay.textContent = 'Ø¯ÙˆØ±Ùƒ (X)';
      gameBoardContainer.classList.remove('blur-game');
      restartOverlay.classList.add('hidden');
      
      // Clear board visually
      for (let i = 0; i < 9; i++) {
        document.getElementById(`cell-${i}`).innerHTML = '';
      }
    }

    function gameEnd(winner) {
      isGameActive = false;
      isGameOver = true;
      let title, message;
      
      if (winner === 'X') {
        title = "ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ğŸ‰";
        message = "Ù„Ù‚Ø¯ ÙØ²Øª Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ¨ÙˆØª! Ø±ØµÙŠØ¯Ùƒ Ø²Ø§Ø¯ Ù†Ø¬Ù…Ø© ÙˆØ§Ø­Ø¯Ø©.";
        updateStats('X');
      } else if (winner === 'O') {
        title = "Ù„Ù„Ø£Ø³Ù! ğŸ˜";
        message = "Ù„Ù‚Ø¯ Ø®Ø³Ø±Øª Ø£Ù…Ø§Ù… Ø§Ù„Ø±ÙˆØ¨ÙˆØª. ØªÙ… Ø®ØµÙ… Ù†Ø¬Ù…Ø© Ù…Ù† Ø±ØµÙŠØ¯Ùƒ.";
        updateStats('O');
      } else {
        title = "ØªØ¹Ø§Ø¯Ù„ ğŸ¤";
        message = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ØªØ¹Ø§Ø¯Ù„. Ù„Ù… ÙŠØªØºÙŠØ± Ø±ØµÙŠØ¯Ùƒ.";
        updateStats('Draw');
      }

      // Show the result modal
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      resultModal.classList.remove('hidden');
    }
    
    function showRestartScreen() {
      gameBoardContainer.classList.add('blur-game');
      restartOverlay.classList.remove('hidden');
    }

    function generateBoard() {
      boardEl.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        cell.id = `cell-${i}`;
        cell.classList.add('cell', 'rounded-lg');
        cell.addEventListener('click', () => handleMove(i));
        boardEl.appendChild(cell);
      }
    }

    // --- EVENT LISTENERS ---
    
    document.getElementById('start-game-btn').addEventListener('click', startGame);
    document.getElementById('account-btn').addEventListener('click', () => showScreen('account'));
    document.getElementById('back-to-menu-btn').addEventListener('click', () => showScreen('menu'));
    document.getElementById('restart-game-btn').addEventListener('click', startGame);

    // Modal OK button logic
    document.getElementById('modal-ok-btn').addEventListener('click', () => {
      resultModal.classList.add('hidden');
      showRestartScreen();
    });

    // --- INITIALIZATION ---

    // 1. Generate the visual board structure
    generateBoard();

    // 2. Initialize Firebase and load user stats
    initializeFirebase();
    
    // Fallback if Telegram Web App environment is not detected (for local testing)
    if (typeof window.Telegram === 'undefined') {
        console.warn("Telegram Web App environment not detected. Running in standalone mode.");
        // Simulate loading end if not in Telegram
        // The menu will show once Firebase is done loading stats.
    } else {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
    }

  </script>
</body>
</html>

