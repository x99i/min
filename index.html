<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„Ø¹Ø¨Ø© Ø¥ÙƒØ³ Ø£Ùˆ Ù…Ø¹ Ø¹Ù„ÙŠ Ø¨Ø´Ø§Ø±</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- Load Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    window.initializeApp = initializeApp;
    window.getAuth = getAuth;
    window.signInAnonymously = signInAnonymously;
    window.onAuthStateChanged = onAuthStateChanged;
    window.getFirestore = getFirestore;
    window.doc = doc;
    window.onSnapshot = onSnapshot;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.setPersistence = setPersistence;
    window.browserLocalPersistence = browserLocalPersistence;
    window.signInWithCustomToken = signInWithCustomToken; // Ensure custom token sign-in is available
  </script>

  <style>
    /* Global Styles for Aesthetics and Responsiveness */
    body {
      color: #e0e0e0;
      font-family: 'Tahoma', 'Inter', sans-serif; 
      min-height: 10vh; /* Changed to 10vh for better mobile fit */
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      background-color: #000;
      position: relative;
    }

    /* --- VIDEO BACKGROUND & OVERLAY --- */
    #video-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -2; 
    }
    
    #video-background source {
        content: url("https://assets.mixkit.co/videos/preview/mixkit-nebula-and-planet-in-outer-space-40615-large.mp4");
    }

    #video-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5); 
      z-index: -1; 
    }

    /* Main App Card */
    #app {
        background-color: rgba(15, 15, 15, 0.95); 
        border: 1px solid #333;
        position: relative;
        z-index: 10;
        /* Ensure app card uses full screen height available */
        display: flex;
        flex-direction: column;
        min-height: 90vh; 
        justify-content: center; 
    }

    /* Game Button Styling (High Aesthetics) */
    .game-button {
      transition: all 0.2s ease;
      background-color: #2a2a2a; 
      border: 2px solid #00ff73;
      color: #00ff73; 
      box-shadow: 0 4px #00a04d; 
      font-weight: bold;
    }

    .game-button:hover {
      background-color: #333;
      box-shadow: 0 2px #00a04d;
      transform: translateY(2px);
    }
    
    /* Board Cell Styling */
    .cell {
      background-color: #1c1c1c; 
      border: none;
      box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.7), 
                  inset -2px -2px 5px rgba(60, 60, 60, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      aspect-ratio: 1 / 1; 
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease, transform 0.1s ease;
      border-radius: 15px; 
      overflow: hidden; 
      position: relative; 
    }

    .cell:hover {
        background-color: #252525;
    }

    /* Custom X and O styles (Vivid Colors) */
    .marker-X, .marker-O {
      font-size: 3rem; 
      line-height: 1; 
      font-weight: 900;
      user-select: none;
      /* Ù„Ø¶Ù…Ø§Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø­Ø¬Ù… Ø«Ø§Ø¨ØªÙ‹Ø§ ÙˆØ¹Ø¯Ù… ØªØ£Ø«Ø±Ù‡ Ø¨Ø§Ù„Ù€ line-height Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
      display: inline-block; 
      transform: translateY(2px); /* ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ù…Ø±ÙƒØ²Ø© Ø§Ù„Ø±Ù…Ø² Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ */
    }
    
    .marker-X {
      color: #00ff73; 
      text-shadow: 0 0 10px rgba(0, 255, 115, 0.7);
    }
    
    .marker-O {
      color: #ff4500; 
      text-shadow: 0 0 10px rgba(255, 69, 0, 0.7);
    }
    
    /* Result Toast Styling */
    #result-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 1.5rem 3rem;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.9);
      opacity: 0;
      transition: opacity 0.2s ease-in-out; 
      z-index: 9999;
      pointer-events: none;
      border: 2px solid;
    }

    /* Restart Overlay Styling - RE-ADDED */
    #restart-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.7); 
        border-radius: 12px;
        z-index: 20; 
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    /* Game Board Grid */
    #game-board {
        gap: 12px; 
        position: relative; 
        z-index: 10;
        padding: 10px;
        width: 100%; 
        max-width: 380px; 
    }
    
    /* WINNING LINE STYLES */
    #winning-line {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 15; 
    }
    .win-line {
        position: absolute;
        border-radius: 5px;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        box-shadow: 0 0 15px currentColor;
    }
    .win-line-active {
        opacity: 1;
        animation: neon-pulse 1s ease-in-out infinite alternate;
    }
    
    @keyframes neon-pulse {
        from { opacity: 0.6; }
        to { opacity: 1; }
    }
    
    /* --- FIX: TITLE WRAPPING ISSUE V3 (More Aggressive Fix) --- */
    .menu-title-fix {
        font-size: 2rem; /* Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ */
        line-height: 1.2;
    }
    /* ØªØµØºÙŠØ± Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªÙØ§Ù */
    @media (max-width: 350px) { 
        .menu-title-fix {
            font-size: 1.2rem; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ù„Ø¶Ù…Ø§Ù† Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ */
        }
    }

  </style>
</head>
<body class="p-4">

  <!-- --- VIDEO BACKGROUND --- -->
  <video autoplay muted loop id="video-background">
      <source src="https://assets.mixkit.co/videos/preview/mixkit-nebula-and-planet-in-outer-space-40615-large.mp4" type="video/mp4">
  </video>
  <div id="video-overlay"></div>
  <!-- ------------------------ -->

  <!-- Language Switcher (Top Left) -->
  <button id="lang-switch-btn" data-lang="ar" class="absolute top-4 left-4 bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full text-sm shadow-md transition-colors duration-200 z-20">
    <span id="lang-flag">ğŸ‡®ğŸ‡¶</span> <span id="lang-text">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
  </button>

  <!-- Main App Container -->
  <div id="app" class="w-full max-w-sm mx-auto p-6 rounded-2xl shadow-2xl relative">
    
    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="flex flex-col items-center justify-center h-80 text-center">
      <i class="ph ph-circle-notch animate-spin text-4xl text-gray-400"></i>
      <p class="mt-4 text-gray-400" data-ar="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…..." data-en="Connecting to the system..."></p>
    </div>

    <!-- MAIN MENU SCREEN -->
    <div id="menu-screen" class="hidden text-center">
      <!-- FIX: ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ ÙˆØ¶Ø¨Ø·Ù‡ Ù„Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªÙØ§Ù -->
      <h1 class="font-extrabold mb-10 text-white leading-tight menu-title-fix">
        <span data-ar="Ø§Ù„Ø¹Ø¨ X O Ù…Ø¹ Ø¹Ù„ÙŠ Ø¨Ø´Ø§Ø±" data-en="Play X O, With Ali Bashar" class="inline-block whitespace-nowrap">
          <span data-ar="Ø§Ù„Ø¹Ø¨ X O Ù…Ø¹" data-en="Play X O, With">Ø§Ù„Ø¹Ø¨ X O Ù…Ø¹</span> <span class="marker-X inline-block">Ø¹Ù„ÙŠ Ø¨Ø´Ø§Ø±</span>
        </span>
      </h1>
      
      <div class="flex flex-col space-y-4 menu-buttons">
        <button id="start-game-btn" class="game-button w-full px-6 py-4 rounded-xl text-lg font-bold">
          <span data-ar="Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©" data-en="Start New Game">Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</span> <i class="ph ph-sword ml-2"></i>
        </button>
        <button id="account-btn" class="game-button w-full px-6 py-4 rounded-xl text-lg font-bold">
          <span class="text-white" data-ar="Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª" data-en="Star Balance & Stats">Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span> <i class="ph ph-star-fill marker-X mr-2"></i>
        </button>
      </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="hidden relative">
      <div id="game-status-bar" class="text-center mb-4 p-2 rounded-xl bg-[#2a2a2a] border border-[#333] transition-all duration-500">
        <p class="text-lg font-semibold text-[#e0e0e0]">
          <span id="turn-display"></span>
        </p>
      </div>
      
      <div id="game-board-container" class="relative transition-all duration-500">
        <!-- Game Board -->
        <div id="game-board" class="grid grid-cols-3 aspect-square max-w-sm mx-auto transition-all duration-500">
          <!-- Winning Line Container -->
          <div id="winning-line" class="absolute inset-0"></div>
          <!-- Cells will be generated by JS -->
        </div>
        
        <!-- RESTART OVERLAY - RE-ADDED -->
        <div id="restart-overlay" class="hidden">
             <!-- The buttons will appear here -->
        </div>
      </div>
      
      <!-- GAME CONTROL BUTTONS - now only holds the End Game button when game is active -->
      <div id="game-control-buttons" class="mt-6 space-y-3 transition-all duration-500">
          <!-- 1. Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (End Game) -->
          <button id="end-game-btn" class="game-button w-full px-6 py-3 rounded-xl text-lg font-bold bg-gray-600 border-gray-500 text-white" style="box-shadow: 0 4px #444; border-color: #555;">
              <span data-ar="Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©" data-en="End Game and Return to Menu">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
          </button>
      </div>
      
    </div>

    <!-- ACCOUNT SCREEN -->
    <div id="account-screen" class="hidden">
      <h2 class="text-2xl font-bold mb-6 text-center text-white" data-ar="Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ…" data-en="Star Balance">Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ…</h2>
      
      <div class="bg-[#2a2a2a] p-4 rounded-xl space-y-4 border border-[#333]">
        <!-- Stars Balance -->
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg shadow-inner shadow-black/30">
          <span class="text-lg font-semibold" data-ar="Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:" data-en="Current Balance:">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</span>
          <span id="account-stars" class="text-2xl font-bold marker-X flex items-center">0 <i class="ph ph-star-fill text-2xl mr-1"></i></span>
        </div>

        <!-- Stats -->
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
          <span class="text-lg font-semibold" data-ar="Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ² (Ø¶Ø¯ Ø¹Ù„ÙŠ Ø¨Ø´Ø§Ø±):" data-en="Wins (vs Ali Bashar):">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ² (Ø¶Ø¯ Ø¹Ù„ÙŠ Ø¨Ø´Ø§Ø±):</span>
          <span id="account-wins" class="text-xl font-bold text-[#00ff73]">0</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
          <span class="text-lg font-semibold" data-ar="Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø³Ø§Ø±Ø©:" data-en="Losses:">Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø³Ø§Ø±Ø©:</span>
          <span id="account-losses" class="text-xl font-bold text-[#ff4500]">0</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
          <span class="text-lg font-semibold" data-ar="Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ø§Ø¯Ù„:" data-en="Draws:">Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ø§Ø¯Ù„:</span>
          <span id="account-draws" class="text-xl font-bold text-gray-400">0</span>
        </div>

        <!-- Dates -->
        <div class="text-sm text-gray-400 pt-4 border-t border-gray-700 space-y-2">
          <p><span data-ar="ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ù„Ø¹Ø¨Ø©:" data-en="First Game:">ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ù„Ø¹Ø¨Ø©:</span> <span id="account-first-game" class="font-mono">N/A</span></p>
          <p><span data-ar="ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù„Ø¹Ø¨Ø©:" data-en="Last Game:">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù„Ø¹Ø¨Ø©:</span> <span id="account-last-game" class="font-mono">N/A</span></p>
        </div>
      </div>
      
      <button id="back-to-menu-btn" class="game-button w-full mt-6 px-6 py-3 rounded-xl text-lg font-bold">
        <span data-ar="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" data-en="Back to Main Menu">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
      </button>
    </div>

  </div>

  <!-- RESULT TOAST (Floating Notification) -->
  <div id="result-toast" class="text-center" style="display: none;">
    <h3 id="toast-title" class="text-2xl font-bold mb-1"></h3>
    <p id="toast-message" class="text-lg text-gray-200"></p>
  </div>


  <script type="module">
    // --- Localization Data ---
    const i18n = {
        ar: {
            loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…...",
            title: "Ø§Ù„Ø¹Ø¨ X O Ù…Ø¹ Ø¹Ù„ÙŠ Ø¨Ø´Ø§Ø±", 
            start: "Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©",
            stats: "Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª",
            current_balance: "Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:",
            wins: "Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ² (Ø¶Ø¯ Ø¹Ù„ÙŠ Ø¨Ø´Ø§Ø±):",
            losses: "Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø³Ø§Ø±Ø©:",
            draws: "Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ø§Ø¯Ù„:",
            first_game: "ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ù„Ø¹Ø¨Ø©:",
            last_game: "ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù„Ø¹Ø¨Ø©:",
            back_to_menu: "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
            end_game_menu: "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©", // New, for the overlay button
            end_game: "Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©", // Main button text
            restart_game: "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©", 
            turn_you: "Ø¯ÙˆØ±Ùƒ (X)",
            turn_ali: "Ø¯ÙˆØ± Ø¹Ù„ÙŠ Ø¨Ø´Ø§Ø± (O)",
            win_title: "ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ÙØ²Øª!",
            win_message: "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© 1 Ù†Ø¬Ù…Ø© Ù„Ø±ØµÙŠØ¯Ùƒ.",
            lose_title: "Ø®Ø³Ø±Øª!",
            lose_message: "ØªÙ… Ø®ØµÙ… 1 Ù†Ø¬Ù…Ø© Ù…Ù† Ø±ØµÙŠØ¯Ùƒ.",
            draw_title: "ØªØ¹Ø§Ø¯Ù„",
            draw_message: "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ØªØ¹Ø§Ø¯Ù„.",
            star_balance: "Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ…"
        },
        en: {
            loading: "Connecting to the system...",
            title: "Play X O, With Ali Bashar", 
            start: "Start New Game",
            stats: "Star Balance & Stats",
            current_balance: "Current Balance:",
            wins: "Wins (vs Ali Bashar):",
            losses: "Losses:",
            draws: "Draws:",
            first_game: "First Game:",
            last_game: "Last Game:",
            back_to_menu: "Back to Main Menu",
            end_game_menu: "Back to Menu", // New, for the overlay button
            end_game: "End Game and Return to Menu", // Main button text
            restart_game: "Restart Game", 
            turn_you: "Your turn (X)",
            turn_ali: "Ali Bashar's turn (O)",
            win_title: "Congratulations! You Win!",
            win_message: "1 star added to your balance.",
            lose_title: "You Lost!",
            lose_message: "1 star deducted from your balance.",
            draw_title: "Draw",
            draw_message: "The game ended in a draw.",
            star_balance: "Star Balance"
        }
    };
    
    // Global Firebase and State Variables
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    let db, auth, userId;
    let statsRef;
    let currentLang = localStorage.getItem('appLang') || 'ar'; 

    // Game State
    let board = ['', '', '', '', ['', '', '', '', ''], '', '', ''];
    let currentPlayer = 'X'; // User starts first
    let isGameActive = false;
    let isGameOver = false;

    // User Data State
    let userStats = {
      stars: 0,
      wins: 0,
      losses: 0,
      draws: 0,
      firstGameDate: 'N/A',
      lastGameDate: 'N/A'
    };

    // DOM Elements
    const screens = {
      loading: document.getElementById('loading-screen'),
      menu: document.getElementById('menu-screen'),
      game: document.getElementById('game-screen'),
      account: document.getElementById('account-screen')
    };
    const boardEl = document.getElementById('game-board');
    const turnDisplay = document.getElementById('turn-display');
    const restartOverlay = document.getElementById('restart-overlay'); // RE-ADDED
    const gameBoardContainer = document.getElementById('game-board-container');
    const gameControlButtons = document.getElementById('game-control-buttons'); 
    const gameStatusBar = document.getElementById('game-status-bar'); 
    const resultToast = document.getElementById('result-toast');
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');
    const langSwitchBtn = document.getElementById('lang-switch-btn');
    const langFlagEl = document.getElementById('lang-flag');
    const langTextEl = document.getElementById('lang-text');
    let winningLineEl = document.getElementById('winning-line'); // Now a let, reassigned in generateBoard
    
    // Control Buttons
    const endGameBtn = document.getElementById('end-game-btn');


    // Colors for winning line
    const WIN_COLOR = '#00ff73'; // Neon Green for User (X)
    const LOSE_COLOR = '#ff4500'; // Orange Red for Ali (O)
    
    // Duration for result toast visibility (1500ms = 1.5 seconds)
    const TOAST_VISIBLE_DURATION_MS = 1500; 

    // --- Localization Functions ---

    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('appLang', lang);
        
        // Update flags and text in the button
        if (lang === 'ar') {
            document.documentElement.lang = 'ar';
            document.documentElement.dir = 'rtl';
            langFlagEl.textContent = 'ğŸ‡®ğŸ‡¶';
            langTextEl.textContent = 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
        } else {
            document.documentElement.lang = 'en';
            document.documentElement.dir = 'ltr';
            langFlagEl.textContent = 'ğŸ‡ºğŸ‡¸';
            langTextEl.textContent = 'USA';
        }

        // Update all data-lang elements
        document.querySelectorAll('[data-ar]').forEach(el => {
            const arText = el.getAttribute('data-ar');
            const enText = el.getAttribute('data-en');
            // Only update if text is present to avoid overwriting structural content
            if (arText && enText) {
                el.textContent = (lang === 'ar' ? arText : enText);
            }
        });
        
        // Update dynamic content (like turn display)
        updateTurnDisplay();
        updateAccountScreen();
        // Regenerate overlay content in case language changed while game over
        if (isGameOver && screens.game.classList.contains('hidden') === false) {
             showRestartOverlay();
        }
    }

    function toggleLanguage() {
        setLanguage(currentLang === 'ar' ? 'en' : 'ar');
    }

    function updateTurnDisplay() {
        if (currentPlayer === 'X') {
            turnDisplay.textContent = i18n[currentLang].turn_you;
        } else if (currentPlayer === 'O') {
            turnDisplay.textContent = i18n[currentLang].turn_ali;
        }
    }


    // Utility to format date
    const formatDate = (timestamp) => {
      if (timestamp === 'N/A' || !timestamp) return 'N/A';
      try {
        const date = new Date(timestamp);
        // Use English locale for consistent date format regardless of app language
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      } catch (e) {
        return timestamp;
      }
    };

    // --- FIREBASE AND STATE MANAGEMENT ---

    async function initializeFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        await setPersistence(auth, browserLocalPersistence);

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            statsRef = doc(db, `/artifacts/${appId}/users/${userId}/tictactoe/stats`);
            loadStats();
          } else {
            // Sign in anonymously if no token or user exists
            const customToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (customToken) {
              await signInWithCustomToken(auth, customToken);
            } else {
              await signInAnonymously(auth);
            }
          }
        });

      } catch (error) {
        console.error("Firebase Initialization Error:", error);
        showScreen('menu'); 
      }
    }

    function loadStats() {
      onSnapshot(statsRef, (docSnap) => {
        if (docSnap.exists()) {
          userStats = docSnap.data();
        } else {
          userStats = {
            stars: 0, wins: 0, losses: 0, draws: 0, firstGameDate: 'N/A', lastGameDate: 'N/A'
          };
        }
        updateAccountScreen();
        showScreen('menu'); 
      }, (error) => {
        console.error("Firestore Snapshot Error:", error);
        showScreen('menu'); 
      });
    }

    async function updateStats(result) {
      const now = new Date().toISOString();
      const isNewUser = userStats.firstGameDate === 'N/A';
      
      let starsChange = 0;
      if (result === 'X') { // User Win: +1 Star
        starsChange = 1;
        userStats.wins++;
      } else if (result === 'O') { // Ali Win: -1 Star
        starsChange = -1;
        userStats.losses++;
      } else { // Draw: 0 Change
        userStats.draws++;
      }

      userStats.stars = (userStats.stars || 0) + starsChange;
      userStats.lastGameDate = now;
      if (isNewUser) {
        userStats.firstGameDate = now;
      }

      try {
        if (isNewUser) {
          await setDoc(statsRef, userStats);
        } else {
          await updateDoc(statsRef, userStats);
        }
        updateAccountScreen();
      } catch (e) {
        console.error("Error updating stats:", e);
      }
    }

    function updateAccountScreen() {
      const starsEl = document.getElementById('account-stars');
      
      // Update star balance display
      starsEl.innerHTML = `${userStats.stars} <i class="ph ph-star-fill text-2xl ${currentLang === 'ar' ? 'mr-1' : 'ml-1'}"></i>`;
      
      // Update color based on balance
      starsEl.classList.remove('marker-X', 'marker-O', 'text-gray-400');
      if (userStats.stars > 0) {
        starsEl.classList.add('marker-X');
      } else if (userStats.stars < 0) {
        starsEl.classList.add('marker-O');
      } else {
        starsEl.classList.add('text-gray-400');
      }
      
      document.getElementById('account-wins').textContent = userStats.wins;
      document.getElementById('account-losses').textContent = userStats.losses;
      document.getElementById('account-draws').textContent = userStats.draws;
      document.getElementById('account-first-game').textContent = formatDate(userStats.firstGameDate);
      document.getElementById('account-last-game').textContent = formatDate(userStats.lastGameDate);
    }

    function showScreen(screenName) {
      Object.values(screens).forEach(el => el.classList.add('hidden'));
      if (screens[screenName]) {
        screens[screenName].classList.remove('hidden');
      }
      if (screenName !== 'game') {
        // Reset game state when leaving game screen
        isGameActive = false;
        isGameOver = false; 
        
        // Clear all game-end effects
        gameBoardContainer.classList.remove('blur-target');
        gameControlButtons.classList.remove('blur-target');
        gameStatusBar.classList.remove('blur-target');
        
        restartOverlay.classList.add('hidden'); // Ensure overlay is hidden
        restartOverlay.style.opacity = 0;
        clearWinningLine();
      }
      
      // Update direction for new screen
      if (currentLang === 'ar') {
        document.documentElement.dir = 'rtl';
      } else {
        document.documentElement.dir = 'ltr';
      }
    }

    // --- GAME LOGIC ---

    const winningConditions = [
      [0, 1, 2], [3, 4, 5], [6, 7, 8], 
      [0, 3, 6], [1, 4, 7], [2, 5, 8], 
      [0, 4, 8], [2, 4, 6]            
    ];

    function checkWin(currentBoard) {
      for (let i = 0; i < winningConditions.length; i++) {
        const [a, b, c] = winningConditions[i];
        if (currentBoard[a] && currentBoard[a] === currentBoard[b] && currentBoard[a] === currentBoard[c]) {
          return { winner: currentBoard[a], combo: winningConditions[i] }; 
        }
      }
      if (!currentBoard.includes('')) {
        return { winner: 'Draw', combo: null };
      }
      return { winner: null, combo: null };
    }

    function handleMove(clickedCellIndex) {
      if (!isGameActive || board[clickedCellIndex] !== '' || isGameOver) return;

      // User Move (X)
      board[clickedCellIndex] = 'X';
      document.getElementById(`cell-${clickedCellIndex}`).innerHTML = `<span class="marker-X">X</span>`;
      
      // *** FIX: Check win immediately after user move ***
      let { winner, combo } = checkWin(board);
      if (winner) return gameEnd(winner, combo); 
      
      currentPlayer = 'O';
      updateTurnDisplay();
      isGameActive = false; 
      
      // Ali's move after a short delay
      setTimeout(robotMove, 700);
    }

    // --- SMART AI (Minimax Algorithm) ---
    
    const scores = {
      X: -10, // Minimizer (User)
      O: 10,  // Maximizer (Ali Bashar)
      Draw: 0
    };

    function minimax(newBoard, player) {
      const { winner } = checkWin(newBoard);
      if (winner) {
        return { score: scores[winner] };
      }

      const availSpots = newBoard.map((val, i) => val === '' ? i : -1).filter(i => i !== -1);
      const moves = [];

      for (let i = 0; i < availSpots.length; i++) {
        const move = {};
        const index = availSpots[i];
        move.index = index;
        newBoard[index] = player;

        if (player === 'O') { // Ali (Maximizer)
          const score = minimax(newBoard, 'X').score;
          move.score = score;
        } else { // User (Minimizer)
          const score = minimax(newBoard, 'O').score;
          move.score = score;
        }

        newBoard[index] = ''; // Reset the spot
        moves.push(move);
      }

      let bestMove = 0;
      if (player === 'O') {
        let bestScore = -Infinity;
        for (let i = 0; i < moves.length; i++) {
          if (moves[i].score > bestScore) {
            bestScore = moves[i].score;
            bestMove = i;
          }
        }
      } else {
        let bestScore = Infinity;
        for (let i = 0; i < moves.length; i++) {
          if (moves[i].score < bestScore) {
            bestScore = moves[i].score;
            bestMove = i;
          }
        }
      }

      return moves[bestMove];
    }

    function robotMove() {
      const availSpots = board.map((val, i) => val === '' ? i : -1).filter(i => i !== -1);
      
      if (availSpots.length === 0) return gameEnd('Draw', null);

      // Simple AI fallback for the first move if center is taken (to speed up game)
      let bestSpot = -1;
      if (availSpots.length === 8 && board[4] === 'X') {
          const corners = [0, 2, 6, 8].filter(i => board[i] === '');
          bestSpot = corners[Math.floor(Math.random() * corners.length)];
      }
      
      if (bestSpot === -1) {
        // Use Minimax for other moves
        bestSpot = minimax(board, 'O').index;
      }

      // Ali Move (O)
      board[bestSpot] = 'O';
      document.getElementById(`cell-${bestSpot}`).innerHTML = `<span class="marker-O">O</span>`;

      let { winner, combo } = checkWin(board);
      if (winner) return gameEnd(winner, combo); 

      currentPlayer = 'X';
      updateTurnDisplay();
      isGameActive = true;
    }
    
    // --- WINNING LINE DRAWING LOGIC ---

    function drawWinningLine(combo, winner) {
      const color = winner === 'X' ? WIN_COLOR : LOSE_COLOR;
      
      clearWinningLine();
      
      const boardRect = boardEl.getBoundingClientRect();

      const centers = combo.map(i => {
        const cell = document.getElementById(`cell-${i}`);
        const rect = cell.getBoundingClientRect();
        return {
          x: rect.left + rect.width / 2 - boardRect.left,
          y: rect.top + rect.height / 2 - boardRect.top
        };
      });

      const start = centers[0];
      const end = centers[2];

      const dx = end.x - start.x;
      const dy = end.y - start.y;
      const length = Math.sqrt(dx * dx + dy * dy) + 20; 
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;

      const line = document.createElement('div');
      line.classList.add('win-line', 'win-line-active');
      line.style.cssText = `
        background-color: ${color};
        transform: rotate(${angle}deg);
        width: ${length}px;
        height: 10px;
        left: ${start.x}px;
        top: ${start.y}px;
        transform-origin: 0% 0%;
      `;
      winningLineEl.appendChild(line);
      
      winningLineEl.style.color = color;
    }
    
    function clearWinningLine() {
        if (winningLineEl) {
            winningLineEl.innerHTML = '';
            winningLineEl.style.color = '';
        }
    }

    // Function to show the restart/menu buttons after the toast disappears
    function showRestartOverlay() {
        // Build the buttons inside the overlay
        restartOverlay.innerHTML = `
            <div class="flex flex-col space-y-4 p-8 w-full max-w-xs">
                <button id="restart-game-btn" class="game-button w-full px-6 py-3 rounded-xl text-lg font-bold">
                    <span data-ar="${i18n[currentLang].restart_game}" data-en="${i18n.en.restart_game}">${i18n[currentLang].restart_game}</span>
                </button>
                <button id="return-to-menu-btn-overlay" class="game-button w-full px-6 py-3 rounded-xl text-lg font-bold bg-gray-600 border-gray-500 text-white" style="box-shadow: 0 4px #444; border-color: #555;">
                    <span data-ar="${i18n[currentLang].end_game_menu}" data-en="${i18n.en.end_game_menu}">${i18n[currentLang].end_game_menu}</span>
                </button>
            </div>
        `;
        
        // Attach listeners to the newly created buttons
        document.getElementById('restart-game-btn').addEventListener('click', startGame);
        document.getElementById('return-to-menu-btn-overlay').addEventListener('click', () => showScreen('menu'));
        
        // Show the overlay
        restartOverlay.classList.remove('hidden');
        // Fade in
        setTimeout(() => {
            restartOverlay.style.opacity = 1;
        }, 50); 
    }


    // --- GAME END FLOW ---

    function gameEnd(winner, combo) {
      isGameActive = false;
      isGameOver = true;
      let title, message, bgColor, borderColor;
      
      if (combo) {
        drawWinningLine(combo, winner);
      }
      
      if (winner === 'X') {
        title = i18n[currentLang].win_title;
        message = i18n[currentLang].win_message;
        bgColor = '#006400'; 
        borderColor = WIN_COLOR; 
        updateStats('X');
      } else if (winner === 'O') {
        title = i18n[currentLang].lose_title;
        message = i18n[currentLang].lose_message;
        bgColor = '#8b0000'; 
        borderColor = LOSE_COLOR; 
        updateStats('O');
      } else { // Draw
        title = i18n[currentLang].draw_title;
        message = i18n[currentLang].draw_message;
        bgColor = '#333333'; 
        borderColor = '#e0e0e0';
        updateStats('Draw');
      }
      
      // 1. Prepare and Show the result Toast
      toastTitle.textContent = title;
      toastMessage.textContent = message;
      resultToast.style.backgroundColor = bgColor;
      resultToast.style.borderColor = borderColor;
      resultToast.style.display = 'block'; 
      
      // Delay before starting the smooth fade and blur
      setTimeout(() => {
        // Fade in (0.2s)
        resultToast.style.opacity = 1;
        // Start smooth blur on the game elements
        gameBoardContainer.classList.add('blur-target');
        gameControlButtons.classList.add('blur-target'); // Blur/Disable End Game button
        gameStatusBar.classList.add('blur-target'); // Blur the turn display
      }, 50); 

      // 2. Hide toast and show restart overlay after the specified duration
      setTimeout(() => {
        // Fade out
        resultToast.style.opacity = 0;
        
        // After fade out transition (0.2s), fully hide the toast and show the restart overlay
        setTimeout(() => {
            resultToast.style.display = 'none';
            showRestartOverlay(); // SHOW RESTART BUTTONS IN OVERLAY
        }, 200); 
        
      }, 50 + TOAST_VISIBLE_DURATION_MS); // Total time visible + initial delay
    }
    
    // --- INITIALIZATION ---

    function startGame() {
      board = ['', '', '', '', ['', '', '', '', ''], '', '', ''];
      currentPlayer = 'X';
      isGameActive = true;
      isGameOver = false;
      showScreen('game');
      updateTurnDisplay(); // Set initial turn text
      
      // Clear all game-end effects 
      gameBoardContainer.classList.remove('blur-target');
      gameControlButtons.classList.remove('blur-target');
      gameStatusBar.classList.remove('blur-target');
      restartOverlay.classList.add('hidden'); // Ensure overlay is hidden
      restartOverlay.style.opacity = 0;
      clearWinningLine(); 
      
      // Clear board visually
      for (let i = 0; i < 9; i++) {
        document.getElementById(`cell-${i}`).innerHTML = '';
      }
    }
    
    // Function to handle ending game and returning to menu (from the main button)
    function handleGameEnd(event) {
        event.preventDefault(); 
        showScreen('menu'); // Return to the main menu screen
    }

    function generateBoard() {
      boardEl.innerHTML = ''; // Clear existing content
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        cell.id = `cell-${i}`;
        cell.classList.add('cell');
        cell.addEventListener('click', () => handleMove(i));
        boardEl.appendChild(cell);
      }
      // Re-add and re-assign winningLineEl
      const lineContainer = document.createElement('div');
      lineContainer.id = 'winning-line';
      lineContainer.classList.add('absolute', 'inset-0');
      boardEl.appendChild(lineContainer);
      winningLineEl = document.getElementById('winning-line');
    }
    

    // --- EVENT LISTENERS ---
    
    document.getElementById('start-game-btn').addEventListener('click', startGame);
    document.getElementById('account-btn').addEventListener('click', () => showScreen('account'));
    document.getElementById('back-to-menu-btn').addEventListener('click', () => showScreen('menu'));
    
    // End Game listener
    endGameBtn.addEventListener('click', handleGameEnd);

    langSwitchBtn.addEventListener('click', toggleLanguage);

    // 1. Generate the visual board structure
    generateBoard();

    // 2. Initialize Language (must run before Firebase tries to update text)
    setLanguage(currentLang);

    // 3. Initialize Firebase and load user stats
    initializeFirebase();
    
    if (typeof window.Telegram === 'undefined') {
        console.warn("Telegram Web App environment not detected.");
    } else {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
    }

  </script>
</body>
</html>

