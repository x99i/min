<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جرب حظك - شحن رسمي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* الخط الأساسي وتأثير الإضاءة المحيطة - يستخدم خطوط iOS افتراضياً */
        :root {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background: linear-gradient(135deg, #1f2937, #000000, #1f2937);
        }
        /* تصميم بكرة السلوت (Reel) ثلاثية الأبعاد */
        .slot-container { 
            perspective: 500px; 
            height: 120px; 
            width: 100%; 
            overflow: hidden; 
            border-radius: 12px; 
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1), inset 0 0 10px rgba(0, 0, 0, 0.9); 
        }
        .slot-reel { 
            transform-style: preserve-3d; 
            /* تم تقليل مدة الانتقال للسماح للحركة بالبدء */
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            position: relative; 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .slot-item { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 120px; 
            font-size: 3.5rem; 
            color: #fcd34d; 
            width: 100%; 
            background-color: #0d1117; 
            border-bottom: 1px solid #374151; 
            box-sizing: border-box; 
        }
        /* حركة الدوران السريعة (Spinning Animation) */
        @keyframes fast-spin { 
            0% { transform: translateY(0); }
            100% { transform: translateY(-80%); } 
        }
        .spinning { 
            animation: fast-spin 0.1s linear infinite; 
        }
        /* نمط زر الفر (Spin) */
        .btn-spin { 
            background: linear-gradient(145deg, #ef4444, #b91c1c); 
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6); 
            transition: all 0.2s ease; 
        }
        .btn-spin:hover { 
            transform: translateY(-3px) scale(1.02); 
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.8); 
        }
        .btn-spin:disabled { 
            background: #4b5563; 
            box-shadow: none; 
            cursor: not-allowed; 
            transform: none; 
        }
        /* رسالة الإشعار (Toast) */
        #toast-notification { 
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; 
            opacity: 0; 
            transform: translateY(100%); 
            z-index: 1000; 
        }
        .toast-visible { 
            opacity: 1 !important; 
            transform: translateY(0) !important; 
        }
        .game-area-glow { 
            box-shadow: 0 0 50px rgba(253, 224, 71, 0.2), 0 0 100px rgba(253, 224, 71, 0.1); 
        }
        #charge-modal { 
            opacity: 0; 
            transition: opacity 0.3s ease; 
        }
        #modal-content { 
            transform: scale(0.9); 
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-md bg-gray-900 p-8 rounded-3xl shadow-2xl border-4 border-yellow-500 game-area-glow">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-black text-white">جرب حظك! 🍀</h1>
             <button id="star-balance-button" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-extrabold py-2 px-4 rounded-full shadow-lg transition" onclick="toggleChargeModal(true)">
                الرصيد: <span id="star-balance">0</span> ⭐
            </button>
        </div>
       
        <p class="text-gray-400 text-center mb-6">🎰 فَر بـ 1 نجمة وافوز بـ 25 نجمة</p>

        <div class="flex justify-between items-center bg-gray-800 p-4 rounded-xl mb-6 shadow-inner border border-gray-700">
            <div>
                <span class="text-sm font-light text-gray-400 block">معرف المستخدم (شاركه مع البوت):</span>
                <span id="user-id-display" class="text-xs font-mono text-blue-400 block mt-1 break-all">...</span>
            </div>
            <div>
                <span class="text-sm font-light text-gray-400 block">أفضل فوز:</span>
                <span id="high-score" class="text-xl font-bold text-red-400 block mt-1">0 ⭐</span>
            </div>
        </div>
        
        <div class="flex justify-around space-x-3 mb-8">
            <div class="slot-container w-1/3"><div id="reel-1" class="slot-reel"></div></div>
            <div class="slot-container w-1/3"><div id="reel-2" class="slot-reel"></div></div>
            <div class="slot-container w-1/3"><div id="reel-3" class="slot-reel"></div></div>
        </div>

        <div id="message-area" class="text-center text-xl font-bold h-8 flex items-center justify-center mb-6">
            <span class="text-gray-300">جاري الاتصال...</span>
        </div>

        <button id="spin-button" class="w-full py-4 text-white text-2xl font-extrabold rounded-2xl uppercase btn-spin" onclick="spinSlot()" disabled>
            جاري تهيئة اللعبة...
        </button>
        
        <div class="mt-6">
            <h3 class="text-lg font-semibold text-gray-300 mb-2 border-b border-gray-700 pb-1">سجل اللعب الأخير</h3>
            <ul id="log-list" class="text-sm text-gray-400 space-y-1 h-20 overflow-y-auto">
                <li class="text-center italic">لا يوجد سجل بعد...</li>
            </ul>
        </div>

    </div>

    <div id="charge-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 backdrop-blur-sm hidden items-center justify-center z-50 p-4" style="opacity: 0;">
        <div class="bg-gray-800 p-8 rounded-3xl w-full max-w-lg shadow-2xl border-4 border-green-500 transition-transform duration-300" id="modal-content">
            <h2 class="text-3xl font-bold text-green-400 text-center mb-5">💸 خيارات شحن النجوم 💸</h2>
            <p class="text-gray-300 text-center mb-6">
                انقر على الكمية، سيتم نقلك إلى رابط الدفع. بعد الدفع، **يجب** إبلاغ البوت بمعرف المستخدم الخاص بك: 
                <span id="modal-user-id" class="text-blue-300 font-mono break-all text-sm block mt-2">...</span>
            </p>
            
            <div id="charge-options-container" class="grid grid-cols-3 gap-4">
                </div>
            
            <button class="w-full mt-6 py-3 bg-gray-700 text-gray-300 rounded-xl hover:bg-gray-600 transition" onclick="toggleChargeModal(false)">
                إغلاق النافذة
            </button>
        </div>
    </div>

    <div id="toast-notification" class="fixed bottom-4 right-4 sm:bottom-8 sm:right-8 z-50 p-4 bg-gray-900 text-white text-base font-medium rounded-xl shadow-2xl transition duration-500 opacity-0 transform translate-y-full">
        </div>

    <script type="module">
        // ------------------------------------------
        // 1. إعدادات Firebase
        // ------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // متغيرات Firebase الإلزامية في بيئة Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // مسار بيانات المستخدم في Firestore
        let DB_PATH = '';
        const DB_COLLECTION = 'game_data';
        const DB_DOCUMENT = 'slot_machine';

        let db = null;
        let auth = null;
        let currentUserId = null;
        let isAuthReady = false;
        
        // ------------------------------------------
        // 2. حالة اللعبة والروابط الرسمية
        // ------------------------------------------
        let starBalance = 0;
        let highScore = 0;
        let playCount = 0; // *** متغير جديد لعدد المشاركات ***
        const spinCost = 1;
        const winAmount = 25;
        // تم تحديث الرموز إلى إيموجيات آيفون (الأكثر شيوعاً)
        const symbols = ['🍎', '💰', '💎', '🔔', '🍀', '🍒', '7️⃣'];
        const winSymbol = '7️⃣';

        const starLinks = [
            { amount: 5, link: 'https://t.me/$RxpsOzzsKEggFAAAroXTcLJE0us' },
            { amount: 10, link: 'https://t.me/$xhKz4jzsKEgiFAAA7-bW0jENam0' },
            { amount: 15, link: 'https://t.me/$8MLAUjzsKEgkFAAAmvIl7afDebE' },
            { amount: 25, link: 'https://t.me/$OGkpxTzsKEgmFAAAJjI6la2LS0w' },
            { amount: 50, link: 'https://t.me/$4vbK7DzsKEgoFAAA1nL9QpnQ3gM' },
            { amount: 75, link: 'https://t.me/$P1qaxTzsKEgqFAAAUhLMFkIZBkc' },
            { amount: 100, link: 'https://t.me/$HSElFDzsKEgsFAAAgCp11iTuimg' },
            { amount: 115, link: 'https://t.me/$0rQkXDzsKEguFAAA3tsBKRFKGEI' },
            { amount: 130, link: 'https://t.me/$_U1fezzsKEgwFAAAzmp7Z0tlFAw' },
            { amount: 150, link: 'https://t.me/$6dYohjzsKEgyFAAAWyc5eGWn3zM' },
        ];


        // ------------------------------------------
        // 3. العناصر الرئيسية في DOM
        // ------------------------------------------
        const balanceElement = document.getElementById('star-balance');
        const spinButton = document.getElementById('spin-button');
        const messageArea = document.getElementById('message-area');
        const reels = [
            document.getElementById('reel-1'),
            document.getElementById('reel-2'),
            document.getElementById('reel-3')
        ];
        const chargeModal = document.getElementById('charge-modal');
        const modalContent = document.getElementById('modal-content');
        const toastElement = document.getElementById('toast-notification');
        const logList = document.getElementById('log-list');
        const highScoreElement = document.getElementById('high-score');
        const userIdDisplay = document.getElementById('user-id-display');
        const modalUserId = document.getElementById('modal-user-id');
        const chargeOptionsContainer = document.getElementById('charge-options-container');

        
        // ------------------------------------------
        // 4. وظائف Firestore
        // ------------------------------------------

        function setupDbPath(userId) {
            // المسار: /artifacts/{appId}/users/{userId}/game_data/slot_machine
            DB_PATH = `artifacts/${appId}/users/${userId}/${DB_COLLECTION}/${DB_DOCUMENT}`;
            return DB_PATH;
        }

        async function fetchInitialData() {
            if (!isAuthReady || !currentUserId) return;

            const userDocRef = doc(db, setupDbPath(currentUserId));
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                starBalance = data.balance || 0;
                highScore = data.highScore || 0;
                playCount = data.playCount || 0; // *** قراءة عدد المشاركات ***
            } else {
                await setDoc(userDocRef, { balance: 0, highScore: 0, playCount: 0, created: new Date().toISOString() });
                starBalance = 0;
                highScore = 0;
                playCount = 0; // *** تهيئة عدد المشاركات ***
            }

            updateUI('تم تحميل البيانات بنجاح.');
            setupRealtimeListener(); 
            spinButton.disabled = starBalance < spinCost;
            spinButton.textContent = starBalance < spinCost ? 'الرصيد 0! إضغط للشحن' : 'إبدأ الآن بـ 1 ⭐';
            messageArea.innerHTML = '<span class="text-gray-300">جاهز للعب!</span>';
        }

        function setupRealtimeListener() {
            if (!isAuthReady || !currentUserId) return;

            const userDocRef = doc(db, setupDbPath(currentUserId));
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const oldBalance = starBalance;
                    const data = docSnap.data();
                    starBalance = data.balance || 0;
                    highScore = data.highScore || 0;
                    playCount = data.playCount || 0; // *** تحديث عدد المشاركات في الوقت الحقيقي ***
                    
                    if (starBalance > oldBalance && oldBalance !== 0) {
                         const increase = starBalance - oldBalance;
                         if (increase > 0) {
                            showToast(`💰 تم الشحن بنجاح! +${increase} ⭐`, 'success');
                            messageArea.innerHTML = `<span class="text-green-400 font-bold">شحن مكتمل! +${increase} ⭐</span>`;
                         }
                    }

                    updateUI();
                }
            });
        }

        async function updateBalanceInDb(newBalance, newHighScore, newPlayCount) { // *** تحديث الدالة لقبول عدد المشاركات ***
            if (!isAuthReady || !currentUserId) return;
            const userDocRef = doc(db, setupDbPath(currentUserId));
            try {
                await setDoc(userDocRef, { 
                    balance: newBalance,
                    highScore: newHighScore,
                    playCount: newPlayCount, // *** حفظ عدد المشاركات الجديد ***
                }, { merge: true });
            } catch (error) {
                console.error("خطأ في تحديث Firestore:", error);
                showToast("خطأ في حفظ البيانات. تأكد من اتصالك.", 'error');
            }
        }
        
        // ------------------------------------------
        // 5. وظائف اللعبة
        // ------------------------------------------

        function updateUI(logMessage = null) {
            balanceElement.textContent = `${starBalance.toLocaleString()}`;
            highScoreElement.textContent = `${highScore.toLocaleString()} ⭐`;
            userIdDisplay.textContent = currentUserId || 'جاري التحميل...';
            modalUserId.textContent = currentUserId || '...';
            
            // تحديث زر الدوران بناءً على الرصيد
            if (isAuthReady) {
                 spinButton.disabled = starBalance < spinCost;
                 if (starBalance < spinCost) {
                    spinButton.textContent = 'الرصيد 0! إضغط للشحن';
                 } else if (spinButton.textContent.includes('جاري تحليل حظك') === false) {
                     spinButton.textContent = 'إبدأ الآن بـ 1 ⭐';
                 }
            }

            // تحديث سجل الأرباح
            if (logMessage) {
                const li = document.createElement('li');
                li.innerHTML = `<span class="text-sm text-gray-500">${new Date().toLocaleTimeString()}</span>: ${logMessage}`;
                logList.prepend(li);
                if (logList.lastElementChild && logList.lastElementChild.classList.contains('italic')) {
                    logList.removeChild(logList.lastElementChild);
                }
                while (logList.children.length > 5) {
                    logList.removeChild(logList.lastElementChild);
                }
            }
        }

        function showToast(message, type = 'info') {
            toastElement.innerHTML = `<span class="text-sm">${message}</span>`;
            toastElement.classList.remove('bg-gray-900', 'bg-red-500', 'bg-green-500');

            let bgColor = 'bg-gray-900';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';

            toastElement.classList.add(bgColor, 'toast-visible', 'opacity-100', 'translate-y-0');
            
            setTimeout(() => {
                toastElement.classList.remove('opacity-100', 'translate-y-0');
            }, 3000); 
        }

        function toggleChargeModal(show) {
            if (show) {
                chargeModal.classList.remove('hidden');
                setTimeout(() => {
                    chargeModal.style.opacity = '1';
                    modalContent.style.transform = 'scale(1)';
                }, 10);
            } else {
                chargeModal.style.opacity = '0';
                modalContent.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    chargeModal.classList.add('hidden');
                }, 300);
            }
        }

        function setupReels() {
            reels.forEach(reel => {
                reel.innerHTML = '';
                for(let i = 0; i < 30; i++) {
                    const item = document.createElement('div');
                    item.className = 'slot-item';
                    item.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                    reel.appendChild(item);
                }
            });
        }

        function populateChargeOptions() {
            chargeOptionsContainer.innerHTML = '';
            starLinks.forEach(item => {
                const button = document.createElement('a');
                const amountFormatted = item.amount.toLocaleString();
                button.className = 'charge-option bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-extrabold text-xl transition shadow-lg text-center block';
                button.href = item.link;
                button.target = '_blank'; // يفتح الرابط في علامة تبويب جديدة
                button.textContent = `${amountFormatted} ⭐`;
                
                button.addEventListener('click', () => {
                    showToast(`✅ تم فتح رابط ${amountFormatted} ⭐. انتظر تأكيد البوت.`);
                    toggleChargeModal(false);
                });

                chargeOptionsContainer.appendChild(button);
            });
        }

        // *** دالة تحديد الرمز الفائز بناءً على الاحتمالات ***
        function getWinSymbol(winProbability, guarantee777) {
            const random = Math.random();
            // نسبة فوز عشوائية ثلاثية (10 لـ 777, 30 لباقي الرموز)
            const tripleWinChance = 0.1; 
            
            if (guarantee777) {
                 // إذا كانت النسبة 80%، نضمن الـ 777
                return [winSymbol, winSymbol, winSymbol];
            } else if (random < winProbability) {
                // حدث الفوز!
                if (Math.random() < tripleWinChance) {
                     // فوز بجائزة كبرى (777) بنسبة 10% من نسبة الفوز الإجمالية
                    return [winSymbol, winSymbol, winSymbol];
                } else {
                    // فوز بثلاثة رموز متطابقة عشوائية أخرى
                    const randomWinSymbol = symbols[Math.floor(Math.random() * (symbols.length - 1))]; // نستثني 777
                    return [randomWinSymbol, randomWinSymbol, randomWinSymbol];
                }
            } else {
                // حدث الخسارة: رموز عشوائية مختلفة
                let results = [];
                for (let i = 0; i < 3; i++) {
                     // نضمن أن لا تكون الثلاثة متطابقة في حالة الخسارة
                     let symbol = symbols[Math.floor(Math.random() * symbols.length)];
                     // محاولة ضمان عدم التكرار الثلاثي في حالة الخسارة
                     if (i === 2 && results[0] === results[1] && results[0] === symbol) {
                         symbol = symbols[(symbols.indexOf(symbol) + 1) % symbols.length];
                     }
                     results.push(symbol);
                }
                return results;
            }
        }
        
        async function spinSlot() {
            if (starBalance < spinCost) {
                toggleChargeModal(true);
                return;
            }

            // 1. حساب نسبة الفوز
            let winProbability = 0;
            let guarantee777 = false;

            if (playCount <= 1) { // أول مرة
                winProbability = 0.8; // 80%
                guarantee777 = true; // لضمان ظهور 777 لأول مرة
            } else if (playCount >= 2 && playCount <= 4) { // 3 مشاركات (بالضبط 2 و 3 و 4)
                winProbability = 0.5; // 50%
            } else if (playCount >= 5) { // فوق 5 مشاركات
                // تخمين بين 90% و 35%
                winProbability = Math.random() < 0.5 ? 0.9 : 0.35; 
            }
            
            // 2. تحديد النتيجة النهائية
            const finalSymbols = getWinSymbol(winProbability, guarantee777);
            
            // 3. خصم التكلفة وتحديث عداد المشاركات
            starBalance -= spinCost;
            playCount += 1; // *** زيادة عداد المشاركات ***
            // لا ننتظر هنا، نرسل التحديث ثم نواصل الحركة لسرعة الاستجابة
            updateBalanceInDb(starBalance, highScore, playCount); 
            updateUI(`خصم: ${spinCost} ⭐ للّعب`);

            spinButton.disabled = true;
            spinButton.textContent = 'جاري تحليل حظك...';
            messageArea.innerHTML = '<span class="text-yellow-400 font-bold">جاري الفَر... 🎰</span>';

            const finalStopTimes = [];

            reels.forEach((reel, index) => {
                const resultSymbol = finalSymbols[index];
                // تأخير التوقف متزايد قليلا
                const stopTime = 2500 + (index * 700) + Math.random() * 300; 
                finalStopTimes.push(stopTime);

                // *** الإصلاح هنا: إعادة تعيين Transition وتطبيق حركة الدوران السريع ***
                reel.style.transition = 'none'; 
                reel.style.transform = `translateY(0)`; 
                reel.classList.add('spinning');
                
                // تحديد موعد التوقف
                setTimeout(() => {
                    reel.classList.remove('spinning');
                    
                    // تفعيل الانتقال السلس للحركة النهائية (2 ثانية)
                    reel.style.transition = 'transform 2s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    
                    // حساب الإزاحة (نحتاج إلى تحريكه مسافة كبيرة عشوائية + الموقع الفائز)
                    const symbolsCountForDisplay = 30;
                    const finalIndex = symbolsCountForDisplay - 2; 
                    
                    // نضمن أن الرمز الفائز هو الذي يظهر في المنتصف
                    reel.children[finalIndex].textContent = resultSymbol;
                    
                    // تحريك Reel إلى موضع النهاية
                    const finalPosition = finalIndex * 120 + 3 * 120; // إضافة 3 مرات ارتفاع البكرة لتأثير الدوران
                    reel.style.transform = `translateY(-${finalPosition}px)`;
                }, stopTime);
            });

            // التحقق من النتيجة بعد توقف البكرة الأخيرة
            const longestStop = Math.max(...finalStopTimes);
            setTimeout(() => {
                checkWin(finalSymbols);
            }, longestStop + 500); 
        }

        async function checkWin(results) {
            spinButton.disabled = false;
            spinButton.textContent = 'إبدأ الآن بـ 1 ⭐';
            
            let win = 0;
            const isTriple = results[0] === results[1] && results[1] === results[2];
            const isTriple7 = isTriple && results[0] === winSymbol;

            if (isTriple7) {
                win = winAmount;
                starBalance += win;
                messageArea.innerHTML = `<span class="text-3xl font-black text-yellow-300 animate-pulse">💰 فوز MEGA! +${win} ⭐</span>`;
                showToast(`🎉 مبروك! فزت بالجائزة الكبرى: ${win} نجمة!`, 'success');
                updateUI(`فوز كبير: +${win} ⭐`);
            } else if (isTriple) {
                win = 10; 
                starBalance += win;
                messageArea.innerHTML = `<span class="text-2xl font-bold text-lime-400">✨ فوز ثلاثي! +${win} ⭐</span>`;
                showToast(`🏆 فوز صغير! تمت إضافة ${win} نجمة.`, 'success');
                updateUI(`فوز صغير: +${win} ⭐`);
            } else {
                messageArea.innerHTML = '<span class="text-red-500 font-bold">😔 لم يحالفك الحظ. جرب ثانية!</span>';
                showToast('لم تفز هذه المرة. حظ أوفر!');
                updateUI(`خسارة: -${spinCost} ⭐`);
            }
            
            if (starBalance > highScore) {
                highScore = starBalance;
            }
            // تحديث الرصيد وأعلى نتيجة في Firestore بعد انتهاء الجولة
            await updateBalanceInDb(starBalance, highScore, playCount);
        }

        // ------------------------------------------
        // 6. تهيئة Firebase وتوقيع الدخول
        // ------------------------------------------
        async function initFirebase() {
            try {
                setLogLevel('debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        fetchInitialData();
                    } else {
                        console.error("لم يتم تسجيل الدخول بنجاح.");
                        messageArea.innerHTML = '<span class="text-red-400">فشل في الاتصال بالخادم.</span>';
                    }
                });

            } catch (error) {
                console.error("خطأ في تهيئة Firebase:", error);
                messageArea.innerHTML = '<span class="text-red-400">فشل في الاتصال بالخادم.</span>';
            }
        }


        // 7. تهيئة اللعبة عند التحميل
        window.onload = () => {
            initFirebase();
            setupReels();
            populateChargeOptions();
        };
        
        // إتاحة الدالة للاستخدام العالمي (مهمة لزر Spin في HTML)
        window.spinSlot = spinSlot;
        window.toggleChargeModal = toggleChargeModal;
    </script>
</body>
</html>
