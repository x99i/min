<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لعبة إكس أو مع علي بشار</title>
  
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load Phosphor Icons (أيقونات جميلة) -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  
  <style>
    /* ------------------------------------- */
    /* 1. Global & Background Styles         */
    /* ------------------------------------- */
    body {
      color: #e0e0e0;
      font-family: 'Tahoma', 'Inter', sans-serif; 
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      background-color: #000;
      position: relative;
      overflow-x: hidden; /* لمنع ظهور شريط التمرير الأفقي */
    }

    /* فيديو الخلفية والطبقة الشفافة */
    #video-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -2; 
    }
    
    #video-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.65); /* زيادة التعتيم لتركيز أفضل */
      z-index: -1; 
    }

    /* ------------------------------------- */
    /* 2. Main App Card & Responsiveness     */
    /* ------------------------------------- */
    #app {
        background-color: rgba(15, 15, 15, 0.98); 
        border: 1px solid #333;
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        min-height: 90vh; 
        max-height: 100vh;
        justify-content: space-between; /* لتحسين التوزيع العمودي */
        width: 100%;
        max-width: 400px;
        padding-bottom: 2rem; /* مسافة سفلية للأمان */
    }

    /* Title Fix for Arabic Wrapping */
    .menu-title-fix {
        font-size: 2rem;
        line-height: 1.2;
    }
    @media (max-width: 350px) { 
        .menu-title-fix {
            font-size: 1.5rem;
        }
    }

    /* ------------------------------------- */
    /* 3. Game Element Styles                */
    /* ------------------------------------- */
    .game-button {
      transition: all 0.2s cubic-bezier(0.2, 0.8, 0.5, 1); /* Curved transition */
      background-color: #2a2a2a; 
      border: 2px solid #00ff73;
      color: #00ff73; 
      box-shadow: 0 5px #00a04d; /* ظل أعمق */
      font-weight: bold;
    }

    .game-button:hover {
      background-color: #333;
      box-shadow: 0 2px #00a04d;
      transform: translateY(3px);
    }
    .game-button:active {
        box-shadow: none;
        transform: translateY(5px);
    }
    
    /* Board Cell Styling */
    .cell {
      background-color: #1c1c1c; 
      border: none;
      box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.8), 
                  inset -2px -2px 5px rgba(60, 60, 60, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      aspect-ratio: 1 / 1; 
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease, transform 0.1s ease;
      border-radius: 15px; 
      overflow: hidden; 
      position: relative; 
    }

    .cell:not(.disabled):hover {
        background-color: #252525;
    }
    .cell.disabled {
        cursor: default;
    }

    /* Custom X and O styles */
    .marker-X, .marker-O {
      font-size: 3.5rem; /* حجم أكبر */
      line-height: 1; 
      font-weight: 900;
      user-select: none;
      display: inline-block; 
      transform: translateY(0); 
    }
    
    .marker-X {
      color: #00ff73; 
      text-shadow: 0 0 15px rgba(0, 255, 115, 0.9);
    }
    
    .marker-O {
      color: #ff4500; 
      text-shadow: 0 0 15px rgba(255, 69, 0, 0.9);
    }
    
    /* ------------------------------------- */
    /* 4. Game Over & Line Styles            */
    /* ------------------------------------- */
    
    /* Blur Effect for Game End */
    .blur-target {
        filter: blur(4px) grayscale(50%);
        pointer-events: none;
        user-select: none;
        opacity: 0.5;
        transition: all 0.5s ease;
    }

    /* Result Toast Styling */
    #result-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 1.5rem 3rem;
      border-radius: 12px;
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.9);
      opacity: 0;
      transition: opacity 0.3s ease-in-out; 
      z-index: 9999;
      pointer-events: none;
      border: 3px solid;
    }

    /* Restart Overlay Styling */
    #restart-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.85); 
        border-radius: 12px;
        z-index: 20; 
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    /* Winning Line */
    #winning-line {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 15; 
    }
    .win-line {
        position: absolute;
        border-radius: 5px;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        box-shadow: 0 0 15px currentColor;
    }
    .win-line-active {
        opacity: 1;
        animation: neon-pulse 1s ease-in-out infinite alternate;
    }
    
    @keyframes neon-pulse {
        from { opacity: 0.8; }
        to { opacity: 1; }
    }
  </style>
</head>
<body class="p-4">

  <!-- --- VIDEO BACKGROUND --- -->
  <video autoplay muted loop id="video-background">
      <source src="https://assets.mixkit.co/videos/preview/mixkit-nebula-and-planet-in-outer-space-40615-large.mp4" type="video/mp4">
  </video>
  <div id="video-overlay"></div>
  <!-- ------------------------ -->

  <!-- Language Switcher -->
  <button id="lang-switch-btn" data-lang="ar" class="absolute top-4 left-4 bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full text-sm shadow-md transition-colors duration-200 z-20">
    <span id="lang-flag">🇮🇶</span> <span id="lang-text">العربية</span>
  </button>

  <!-- Main App Container -->
  <div id="app" class="w-full max-w-sm mx-auto p-6 rounded-2xl shadow-2xl relative">
    
    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="flex flex-col items-center justify-center h-80 text-center">
      <i class="ph ph-circle-notch animate-spin text-4xl text-gray-400"></i>
      <p class="mt-4 text-gray-400" data-ar="جاري الاتصال بالنظام..." data-en="Connecting to the system..."></p>
    </div>

    <!-- MAIN MENU SCREEN -->
    <div id="menu-screen" class="hidden text-center flex flex-col justify-center h-full">
        <div>
            <!-- Header -->
            <h1 class="font-extrabold mb-10 text-white leading-tight menu-title-fix">
                <span data-ar="العب X O مع علي بشار" data-en="Play X O, With Ali Bashar" class="inline-block whitespace-nowrap">
                  <span data-ar="العب X O مع" data-en="Play X O, With">العب X O مع</span> <span class="marker-X inline-block">علي بشار</span>
                </span>
            </h1>
          
            <!-- Menu Buttons -->
            <div class="flex flex-col space-y-4 menu-buttons">
                <button id="start-game-btn" class="game-button w-full px-6 py-4 rounded-xl text-lg font-bold">
                    <span data-ar="بدء لعبة جديدة" data-en="Start New Game">بدء لعبة جديدة</span> <i class="ph ph-sword ml-2"></i>
                </button>
                <button id="account-btn" class="game-button w-full px-6 py-4 rounded-xl text-lg font-bold">
                    <span class="text-white" data-ar="رصيد النجوم والإحصائيات" data-en="Star Balance & Stats">رصيد النجوم والإحصائيات</span> <i class="ph ph-star-fill marker-X mr-2"></i>
                </button>
                
                <!-- NEW: Leaderboard Button -->
                <button id="leaderboard-btn" class="game-button w-full px-6 py-4 rounded-xl text-lg font-bold">
                    <span class="text-white" data-ar="لوحة المتصدرين" data-en="Leaderboard">لوحة المتصدرين</span> <i class="ph ph-medal-fill marker-O mr-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="hidden relative flex-grow flex flex-col justify-center items-center">
      <div id="game-status-bar" class="text-center mb-4 p-2 rounded-xl bg-[#2a2a2a] border border-[#333] transition-all duration-500 w-full">
        <p class="text-lg font-semibold text-[#e0e0e0]">
          <span id="turn-display"></span>
        </p>
      </div>
      
      <div id="game-board-container" class="relative transition-all duration-500 w-full max-w-[380px] mx-auto">
        <!-- Game Board -->
        <div id="game-board" class="grid grid-cols-3 aspect-square mx-auto transition-all duration-500">
          <!-- Winning Line Container -->
          <div id="winning-line" class="absolute inset-0"></div>
          <!-- Cells will be generated by JS -->
        </div>
        
        <!-- RESTART OVERLAY -->
        <div id="restart-overlay" class="hidden">
             <!-- The buttons will appear here -->
        </div>
      </div>
      
      <!-- GAME CONTROL BUTTONS -->
      <div id="game-control-buttons" class="mt-6 space-y-3 transition-all duration-500 w-full max-w-[380px]">
          <!-- زر إنهاء اللعبة (End Game) -->
          <button id="end-game-btn" class="game-button w-full px-6 py-3 rounded-xl text-lg font-bold bg-gray-600 border-gray-500 text-white" style="box-shadow: 0 4px #444; border-color: #555;">
              <span data-ar="إنهاء اللعبة والعودة للقائمة" data-en="End Game and Return to Menu">إنهاء اللعبة والعودة للقائمة</span>
          </button>
      </div>
    </div>

    <!-- ACCOUNT SCREEN -->
    <div id="account-screen" class="hidden flex-grow flex flex-col justify-between">
      <div>
        <h2 class="text-2xl font-bold mb-6 text-center text-white" data-ar="رصيد النجوم" data-en="Star Balance">رصيد النجوم</h2>
        
        <div class="bg-[#2a2a2a] p-4 rounded-xl space-y-4 border border-[#333]">
          <!-- Stars Balance -->
          <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg shadow-inner shadow-black/30">
            <span class="text-lg font-semibold" data-ar="رصيدك الحالي:" data-en="Current Balance:">رصيدك الحالي:</span>
            <span id="account-stars" class="text-2xl font-bold marker-X flex items-center">0 <i class="ph ph-star-fill text-2xl mr-1"></i></span>
          </div>

          <!-- Stats -->
          <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
            <span class="text-lg font-semibold" data-ar="عدد الفوز (ضد علي بشار):" data-en="Wins (vs Ali Bashar):">عدد الفوز (ضد علي بشار):</span>
            <span id="account-wins" class="text-xl font-bold text-[#00ff73]">0</span>
          </div>
          <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
            <span class="text-lg font-semibold" data-ar="عدد الخسارة:" data-en="Losses:">عدد الخسارة:</span>
            <span id="account-losses" class="text-xl font-bold text-[#ff4500]">0</span>
          </div>
          <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
            <span class="text-lg font-semibold" data-ar="عدد التعادل:" data-en="Draws:">عدد التعادل:</span>
            <span id="account-draws" class="text-xl font-bold text-gray-400">0</span>
          </div>

          <!-- Dates -->
          <div class="text-sm text-gray-400 pt-4 border-t border-gray-700 space-y-2">
            <p><span data-ar="تاريخ أول لعبة:" data-en="First Game:">تاريخ أول لعبة:</span> <span id="account-first-game" class="font-mono">N/A</span></p>
            <p><span data-ar="تاريخ آخر لعبة:" data-en="Last Game:">تاريخ آخر لعبة:</span> <span id="account-last-game" class="font-mono">N/A</span></p>
          </div>
        </div>
      </div>
      
      <button id="back-to-menu-btn" class="game-button w-full mt-6 px-6 py-3 rounded-xl text-lg font-bold">
        <span data-ar="العودة للقائمة الرئيسية" data-en="Back to Main Menu">العودة للقائمة الرئيسية</span>
      </button>
    </div>
    
    <!-- LEADERBOARD SCREEN (NEW) -->
    <div id="leaderboard-screen" class="hidden flex-grow flex flex-col justify-between">
        <div>
            <h2 class="text-2xl font-bold mb-6 text-center text-white" data-ar="لوحة المتصدرين" data-en="Leaderboard">لوحة المتصدرين</h2>
            <div id="leaderboard-list" class="bg-[#2a2a2a] p-4 rounded-xl border border-[#333] space-y-3">
                 <!-- Leaderboard items will be injected here -->
                <p class="text-gray-400 text-center" data-ar="جاري تحميل المتصدرين..." data-en="Loading Leaderboard..."></p>
            </div>
            
            <div class="mt-4 text-center text-sm text-gray-400">
                <span data-ar="نقاطك في هذه اللوحة تعتمد على رصيد نجومك." data-en="Your ranking is based on your star balance.">نقاطك في هذه اللوحة تعتمد على رصيد نجومك.</span>
            </div>
        </div>
        <button id="back-to-menu-leaderboard-btn" class="game-button w-full mt-6 px-6 py-3 rounded-xl text-lg font-bold">
            <span data-ar="العودة للقائمة الرئيسية" data-en="Back to Main Menu">العودة للقائمة الرئيسية</span>
        </button>
    </div>

  </div>

  <!-- RESULT TOAST (Floating Notification) -->
  <div id="result-toast" class="text-center" style="display: none;">
    <h3 id="toast-title" class="text-2xl font-bold mb-1"></h3>
    <p id="toast-message" class="text-lg text-gray-200"></p>
  </div>


  <script type="module">
    // -------------------------------------
    // 1. Localization Data
    // -------------------------------------
    const i18n = {
        ar: {
            loading: "جاري الاتصال بالنظام...",
            title: "العب X O مع علي بشار", 
            start: "بدء لعبة جديدة",
            stats: "رصيد النجوم والإحصائيات",
            leaderboard: "لوحة المتصدرين",
            current_balance: "رصيدك الحالي:",
            wins: "عدد الفوز (ضد علي بشار):",
            losses: "عدد الخسارة:",
            draws: "عدد التعادل:",
            first_game: "تاريخ أول لعبة:",
            last_game: "تاريخ آخر لعبة:",
            back_to_menu: "العودة للقائمة الرئيسية",
            end_game_menu: "العودة للقائمة", 
            end_game: "إنهاء اللعبة والعودة للقائمة", 
            restart_game: "إعادة اللعبة", 
            turn_you: "دورك (X)",
            turn_ali: "دور علي بشار (O)",
            win_title: "تهانينا! فزت!",
            win_message: "تمت إضافة 1 نجمة لرصيدك.",
            lose_title: "خسرت!",
            lose_message: "تم خصم 1 نجمة من رصيدك.",
            draw_title: "تعادل",
            draw_message: "انتهت اللعبة بالتعادل.",
            star_balance: "رصيد النجوم",
            user_id: "معرف المستخدم:",
            loading_leaderboard: "جاري تحميل المتصدرين...",
            ranking_based: "نقاطك في هذه اللوحة تعتمد على رصيد نجومك.",
            your_rank: "ترتيبك:"
        },
        en: {
            loading: "Connecting to the system...",
            title: "Play X O, With Ali Bashar", 
            start: "Start New Game",
            stats: "Star Balance & Stats",
            leaderboard: "Leaderboard",
            current_balance: "Current Balance:",
            wins: "Wins (vs Ali Bashar):",
            losses: "Losses:",
            draws: "Draws:",
            first_game: "First Game:",
            last_game: "Last Game:",
            back_to_menu: "Back to Main Menu",
            end_game_menu: "Back to Menu", 
            end_game: "End Game and Return to Menu", 
            restart_game: "Restart Game", 
            turn_you: "Your turn (X)",
            turn_ali: "Ali Bashar's turn (O)",
            win_title: "Congratulations! You Win!",
            win_message: "1 star added to your balance.",
            lose_title: "You Lost!",
            lose_message: "1 star deducted from your balance.",
            draw_title: "Draw",
            draw_message: "The game ended in a draw.",
            star_balance: "Star Balance",
            user_id: "User ID:",
            loading_leaderboard: "Loading Leaderboard...",
            ranking_based: "Your ranking is based on your star balance.",
            your_rank: "Your Rank:"
        }
    };
    
    // -------------------------------------
    // 2. Global Constants & Initialization
    // -------------------------------------
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    
    // Firebase Imports (Global Access after import)
    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, onSnapshot, setDoc, updateDoc, setPersistence, browserLocalPersistence, signInWithCustomToken, collection, query, getDocs } = window;
    
    // DOM Elements (Centralized access)
    const DOM = {
        screens: {
            loading: document.getElementById('loading-screen'),
            menu: document.getElementById('menu-screen'),
            game: document.getElementById('game-screen'),
            account: document.getElementById('account-screen'),
            leaderboard: document.getElementById('leaderboard-screen')
        },
        board: document.getElementById('game-board'),
        turnDisplay: document.getElementById('turn-display'),
        restartOverlay: document.getElementById('restart-overlay'),
        gameBoardContainer: document.getElementById('game-board-container'),
        gameControlButtons: document.getElementById('game-control-buttons'),
        gameStatusBar: document.getElementById('game-status-bar'),
        resultToast: document.getElementById('result-toast'),
        toastTitle: document.getElementById('toast-title'),
        toastMessage: document.getElementById('toast-message'),
        langSwitchBtn: document.getElementById('lang-switch-btn'),
        langFlagEl: document.getElementById('lang-flag'),
        langTextEl: document.getElementById('lang-text'),
        winningLineEl: document.getElementById('winning-line'), 
        leaderboardList: document.getElementById('leaderboard-list'),

        // Control Buttons
        endGameBtn: document.getElementById('end-game-btn'),
        startGameBtn: document.getElementById('start-game-btn'),
        accountBtn: document.getElementById('account-btn'),
        backToMenuBtn: document.getElementById('back-to-menu-btn'),
        leaderboardBtn: document.getElementById('leaderboard-btn'),
        backToMenuLeaderboardBtn: document.getElementById('back-to-menu-leaderboard-btn'),
    };
    
    const WIN_COLOR = '#00ff73'; 
    const LOSE_COLOR = '#ff4500'; 
    const TOAST_VISIBLE_DURATION_MS = 1500; 

    // -------------------------------------
    // 3. Application State (Centralized)
    // -------------------------------------
    class AppState {
        constructor() {
            this.db = null;
            this.auth = null;
            this.userId = null;
            this.statsRef = null; // Doc reference for user stats
            this.leaderboardRef = null; // Collection reference for public stats
            this.currentLang = localStorage.getItem('appLang') || 'ar'; 
            this.userStats = { stars: 0, wins: 0, losses: 0, draws: 0, firstGameDate: 'N/A', lastGameDate: 'N/A' };
        }
    }
    const state = new AppState();
    
    // -------------------------------------
    // 4. Game State Logic (Separated)
    // -------------------------------------
    class GameLogic {
        constructor() {
            this.board = Array(9).fill(''); // 3x3 board array
            this.currentPlayer = 'X'; // X is User, O is Ali Bashar (AI)
            this.isGameActive = false;
            this.isGameOver = false;
            this.winningConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], 
                [0, 3, 6], [1, 4, 7], [2, 5, 8], 
                [0, 4, 8], [2, 4, 6]            
            ];
            this.scores = { X: -10, O: 10, Draw: 0 };
        }

        resetGame() {
            this.board = Array(9).fill('');
            this.currentPlayer = 'X';
            this.isGameActive = true;
            this.isGameOver = false;
        }

        checkWin(currentBoard) {
            for (const combo of this.winningConditions) {
                const [a, b, c] = combo;
                if (currentBoard[a] && currentBoard[a] === currentBoard[b] && currentBoard[a] === currentBoard[c]) {
                    return { winner: currentBoard[a], combo: combo }; 
                }
            }
            if (!currentBoard.includes('')) {
                return { winner: 'Draw', combo: null };
            }
            return { winner: null, combo: null };
        }
        
        // Minimax AI
        minimax(newBoard, player) {
            const { winner } = this.checkWin(newBoard);
            if (winner) {
                return { score: this.scores[winner] };
            }

            const availSpots = newBoard.map((val, i) => val === '' ? i : -1).filter(i => i !== -1);
            const moves = [];

            for (let i = 0; i < availSpots.length; i++) {
                const move = {};
                const index = availSpots[i];
                move.index = index;
                newBoard[index] = player;

                const score = this.minimax(newBoard, player === 'O' ? 'X' : 'O').score;
                move.score = score;

                newBoard[index] = ''; // Reset the spot
                moves.push(move);
            }

            let bestMove = 0;
            if (player === 'O') { // Maximizer
                let bestScore = -Infinity;
                for (let i = 0; i < moves.length; i++) {
                    if (moves[i].score > bestScore) {
                        bestScore = moves[i].score;
                        bestMove = i;
                    }
                }
            } else { // Minimizer
                let bestScore = Infinity;
                for (let i = 0; i < moves.length; i++) {
                    if (moves[i].score < bestScore) {
                        bestScore = moves[i].score;
                        bestMove = i;
                    }
                }
            }

            return moves[bestMove];
        }
        
        getRobotMoveIndex() {
            const availSpots = this.board.map((val, i) => val === '' ? i : -1).filter(i => i !== -1);
            
            if (availSpots.length === 0) return -1; 
            
            // Simple AI fallback for initial moves to speed up Minimax
            if (availSpots.length >= 8) {
                if (this.board[4] === '') return 4; // Take center first
                
                const corners = [0, 2, 6, 8].filter(i => this.board[i] === '');
                if (corners.length > 0) return corners[Math.floor(Math.random() * corners.length)];
            }

            // Use Minimax for critical moves
            return this.minimax(this.board, 'O').index;
        }

    }
    const game = new GameLogic();
    
    // -------------------------------------
    // 5. Data Manager (Firebase & Stats)
    // -------------------------------------
    class DataManager {
        
        formatDate(timestamp) {
            if (timestamp === 'N/A' || !timestamp) return 'N/A';
            try {
                const date = new Date(timestamp);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return timestamp;
            }
        }
        
        async initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                state.db = getFirestore(app);
                state.auth = getAuth(app);
                
                await setPersistence(state.auth, browserLocalPersistence);

                onAuthStateChanged(state.auth, async (user) => {
                    if (user) {
                        state.userId = user.uid;
                        // Private user stats doc
                        state.statsRef = doc(state.db, `/artifacts/${appId}/users/${state.userId}/tictactoe/stats`);
                        // Public leaderboard collection
                        state.leaderboardRef = collection(state.db, `/artifacts/${appId}/public/data/leaderboard`);
                        
                        this.loadStats();
                        UIManager.showScreen('menu');
                    } else {
                        const customToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (customToken) {
                            await signInWithCustomToken(state.auth, customToken);
                        } else {
                            // If running outside Canvas, sign in anonymously (creates a new user)
                            await signInAnonymously(state.auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                UIManager.showScreen('menu'); 
            }
        }

        loadStats() {
            onSnapshot(state.statsRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.userStats = docSnap.data();
                } else {
                    state.userStats = {
                        stars: 0, wins: 0, losses: 0, draws: 0, firstGameDate: 'N/A', lastGameDate: 'N/A', userId: state.userId
                    };
                }
                UIManager.updateAccountScreen();
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                // Continue application flow even on error
            });
        }
        
        async getLeaderboard() {
            try {
                // Get top 10 players based on stars (No orderBy() used to prevent index issues, sort locally)
                const q = query(state.leaderboardRef);
                const querySnapshot = await getDocs(q);
                
                let leaderboardData = [];
                querySnapshot.forEach((doc) => {
                    leaderboardData.push(doc.data());
                });
                
                // 1. Sort locally by stars (descending)
                leaderboardData.sort((a, b) => b.stars - a.stars);
                
                // 2. Take top 10
                leaderboardData = leaderboardData.slice(0, 10);
                
                return leaderboardData;
            } catch (e) {
                console.error("Error fetching leaderboard:", e);
                return [];
            }
        }

        async updateStats(result) {
            const now = new Date().toISOString();
            const isNewUser = state.userStats.firstGameDate === 'N/A';
            
            let starsChange = 0;
            if (result === 'X') { // User Win: +1 Star
                starsChange = 1;
                state.userStats.wins++;
            } else if (result === 'O') { // Ali Win: -1 Star
                starsChange = -1;
                state.userStats.losses++;
            } else { // Draw: 0 Change
                state.userStats.draws++;
            }

            state.userStats.stars = (state.userStats.stars || 0) + starsChange;
            state.userStats.lastGameDate = now;
            
            if (isNewUser) {
                state.userStats.firstGameDate = now;
                state.userStats.userId = state.userId; // Store user ID for public ranking
            }

            try {
                // 1. Update Private Stats
                await setDoc(state.statsRef, state.userStats, { merge: true });
                
                // 2. Update Public Leaderboard (Document ID is the user's UID for easy lookup)
                const publicStatsRef = doc(state.leaderboardRef, state.userId);
                await setDoc(publicStatsRef, {
                    userId: state.userId, 
                    stars: state.userStats.stars,
                    lastPlayed: now,
                    // Note: We don't store PII like name/username here, just the ID and score.
                }, { merge: true });
                
                UIManager.updateAccountScreen();
            } catch (e) {
                console.error("Error updating stats:", e);
            }
        }
    }
    const dataManager = new DataManager();


    // -------------------------------------
    // 6. UI Manager (Rendering & Events)
    // -------------------------------------
    class UIManager {
        
        constructor() {
            this.setupInitialState();
            this.setupEventListeners();
        }
        
        setupInitialState() {
            // Set initial language
            this.setLanguage(state.currentLang);
            // Generate board structure
            this.generateBoard();
        }

        setupEventListeners() {
            // Main Menu Handlers
            DOM.startGameBtn.addEventListener('click', () => {
                game.resetGame();
                UIManager.startGameUI();
            });
            DOM.accountBtn.addEventListener('click', () => UIManager.showScreen('account'));
            DOM.leaderboardBtn.addEventListener('click', () => UIManager.loadAndShowLeaderboard());
            
            // Navigation Handlers
            DOM.backToMenuBtn.addEventListener('click', () => UIManager.showScreen('menu'));
            DOM.backToMenuLeaderboardBtn.addEventListener('click', () => UIManager.showScreen('menu'));
            DOM.endGameBtn.addEventListener('click', () => UIManager.showScreen('menu'));

            // Language Switcher
            DOM.langSwitchBtn.addEventListener('click', this.toggleLanguage.bind(this));
        }

        setLanguage(lang) {
            state.currentLang = lang;
            localStorage.setItem('appLang', lang);
            
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            DOM.langFlagEl.textContent = lang === 'ar' ? '🇮🇶' : '🇺🇸';
            DOM.langTextEl.textContent = lang === 'ar' ? 'العربية' : 'USA';

            document.querySelectorAll('[data-ar]').forEach(el => {
                const text = i18n[lang][el.dataset.ar] || (lang === 'ar' ? el.getAttribute('data-ar') : el.getAttribute('data-en'));
                if (text) {
                    el.textContent = text;
                }
            });
            
            this.updateTurnDisplay();
            this.updateAccountScreen();
        }

        toggleLanguage() {
            this.setLanguage(state.currentLang === 'ar' ? 'en' : 'ar');
        }

        showScreen(screenName) {
            Object.values(DOM.screens).forEach(el => el.classList.add('hidden'));
            if (DOM.screens[screenName]) {
                DOM.screens[screenName].classList.remove('hidden');
            }
            if (screenName !== 'game') {
                this.resetGameEffects();
            }
        }
        
        startGameUI() {
            this.showScreen('game');
            this.updateTurnDisplay();
            this.resetGameEffects();
            // Clear board visually
            for (let i = 0; i < 9; i++) {
                const cell = document.getElementById(`cell-${i}`);
                if (cell) {
                    cell.innerHTML = '';
                    cell.classList.remove('disabled'); // Ensure all cells are enabled
                }
            }
        }
        
        resetGameEffects() {
            // Remove all game-end effects and overlays
            game.isGameActive = false;
            game.isGameOver = false; 
            DOM.gameBoardContainer.classList.remove('blur-target');
            DOM.gameControlButtons.classList.remove('blur-target');
            DOM.gameStatusBar.classList.remove('blur-target');
            DOM.restartOverlay.classList.add('hidden');
            DOM.restartOverlay.style.opacity = 0;
            this.clearWinningLine();
        }

        updateTurnDisplay() {
            if (game.currentPlayer === 'X') {
                DOM.turnDisplay.textContent = i18n[state.currentLang].turn_you;
            } else if (game.currentPlayer === 'O') {
                DOM.turnDisplay.textContent = i18n[state.currentLang].turn_ali;
            }
            // Add a small pulse effect to the turn display on change
            DOM.gameStatusBar.style.transform = 'scale(1.05)';
            setTimeout(() => {
                DOM.gameStatusBar.style.transform = 'scale(1.0)';
            }, 100);
        }

        updateAccountScreen() {
            const starsEl = document.getElementById('account-stars');
            
            starsEl.innerHTML = `${state.userStats.stars} <i class="ph ph-star-fill text-2xl ${state.currentLang === 'ar' ? 'mr-1' : 'ml-1'}"></i>`;
            
            starsEl.classList.remove('marker-X', 'marker-O', 'text-gray-400');
            if (state.userStats.stars > 0) {
                starsEl.classList.add('marker-X');
            } else if (state.userStats.stars < 0) {
                starsEl.classList.add('marker-O');
            } else {
                starsEl.classList.add('text-gray-400');
            }
            
            document.getElementById('account-wins').textContent = state.userStats.wins;
            document.getElementById('account-losses').textContent = state.userStats.losses;
            document.getElementById('account-draws').textContent = state.userStats.draws;
            document.getElementById('account-first-game').textContent = dataManager.formatDate(state.userStats.firstGameDate);
            document.getElementById('account-last-game').textContent = dataManager.formatDate(state.userStats.lastGameDate);
            
            // Add user ID to the account screen for debugging/sharing
            const accountScreenEl = DOM.screens.account;
            if (!document.getElementById('user-id-display')) {
                const userIdEl = document.createElement('p');
                userIdEl.id = 'user-id-display';
                userIdEl.className = 'text-xs text-gray-500 mt-4 text-center break-all';
                userIdEl.textContent = `${i18n[state.currentLang].user_id} ${state.userId || '...'}`;
                accountScreenEl.querySelector('div:first-child').appendChild(userIdEl);
            } else {
                document.getElementById('user-id-display').textContent = `${i18n[state.currentLang].user_id} ${state.userId || '...'}`;
            }
        }
        
        async loadAndShowLeaderboard() {
            this.showScreen('leaderboard');
            DOM.leaderboardList.innerHTML = `<p class="text-gray-400 text-center">${i18n[state.currentLang].loading_leaderboard}</p>`;
            
            const leaderboard = await dataManager.getLeaderboard();
            
            // Clear loading text
            DOM.leaderboardList.innerHTML = '';
            
            if (leaderboard.length === 0) {
                 DOM.leaderboardList.innerHTML = `<p class="text-gray-400 text-center">${i18n[state.currentLang].loading_leaderboard.replace('جاري تحميل', 'لا توجد')}</p>`;
                return;
            }

            let rankHTML = '';
            let userRankFound = false;
            
            leaderboard.forEach((player, index) => {
                const rank = index + 1;
                const isCurrentUser = player.userId === state.userId;
                
                if (isCurrentUser) {
                    userRankFound = true;
                }
                
                const rankColor = rank === 1 ? 'text-yellow-400' : rank === 2 ? 'text-gray-400' : rank === 3 ? 'text-amber-600' : 'text-gray-300';
                const bgColor = isCurrentUser ? 'bg-indigo-900/50 border-indigo-400' : 'bg-[#333] border-[#333]';
                
                // Truncate User ID for display (Only show the full ID in the Account screen)
                const displayId = player.userId.substring(0, 8) + '...';

                rankHTML += `
                    <div class="flex justify-between items-center p-3 rounded-lg border ${bgColor} transition-all duration-300">
                        <div class="flex items-center space-x-3 ${state.currentLang === 'ar' ? 'space-x-reverse' : ''}">
                            <span class="text-xl font-extrabold ${rankColor}">${rank}.</span>
                            <span class="text-base font-semibold text-white break-all">${isCurrentUser ? (i18n[state.currentLang].your_rank) : displayId}</span>
                        </div>
                        <span class="text-xl font-bold flex items-center ${player.stars >= 0 ? 'marker-X' : 'marker-O'}">
                            ${player.stars} <i class="ph ph-star-fill text-xl ${state.currentLang === 'ar' ? 'mr-1' : 'ml-1'}"></i>
                        </span>
                    </div>
                `;
            });
            
            DOM.leaderboardList.innerHTML = rankHTML;
            
            // If the current user is not in the top 10, show their current rank below the list (requires another query, but we will simplify)
            // To keep the code under the single-file mandate and Firestore limits, we will assume the user sees their own stats separately.
        }

        // --- Winning Line UI ---

        generateBoard() {
            DOM.board.innerHTML = ''; 
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.id = `cell-${i}`;
                cell.classList.add('cell');
                cell.addEventListener('click', () => GameController.handleUserMove(i));
                DOM.board.appendChild(cell);
            }
            
            // Re-add winningLineEl container 
            const lineContainer = document.createElement('div');
            lineContainer.id = 'winning-line';
            lineContainer.classList.add('absolute', 'inset-0');
            DOM.board.appendChild(lineContainer);
            DOM.winningLineEl = document.getElementById('winning-line');
        }

        drawWinningLine(combo, winner) {
            const color = winner === 'X' ? WIN_COLOR : LOSE_COLOR;
            this.clearWinningLine();
            
            const boardRect = DOM.board.getBoundingClientRect();

            const centers = combo.map(i => {
                const cell = document.getElementById(`cell-${i}`);
                const rect = cell.getBoundingClientRect();
                return {
                    x: rect.left + rect.width / 2 - boardRect.left,
                    y: rect.top + rect.height / 2 - boardRect.top
                };
            });

            const start = centers[0];
            const end = centers[2];

            const dx = end.x - start.x;
            const dy = end.y - start.y;
            const length = Math.sqrt(dx * dx + dy * dy) + 20; 
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;

            const line = document.createElement('div');
            line.classList.add('win-line', 'win-line-active');
            line.style.cssText = `
                background-color: ${color};
                transform: rotate(${angle}deg);
                width: ${length}px;
                height: 10px;
                left: ${start.x}px;
                top: ${start.y}px;
                transform-origin: 0% 0%;
            `;
            DOM.winningLineEl.appendChild(line);
            DOM.winningLineEl.style.color = color;
        }
        
        clearWinningLine() {
            if (DOM.winningLineEl) {
                DOM.winningLineEl.innerHTML = '';
                DOM.winningLineEl.style.color = '';
            }
        }
        
        // --- Game End UI Flow ---

        showToast(title, message, bgColor, borderColor) {
            DOM.toastTitle.textContent = title;
            DOM.toastMessage.textContent = message;
            DOM.resultToast.style.backgroundColor = bgColor;
            DOM.resultToast.style.borderColor = borderColor;
            DOM.resultToast.style.display = 'block'; 
            
            // Fade in and apply blur effect
            setTimeout(() => {
                DOM.resultToast.style.opacity = 1;
                DOM.gameBoardContainer.classList.add('blur-target');
                DOM.gameControlButtons.classList.add('blur-target'); 
                DOM.gameStatusBar.classList.add('blur-target'); 
                // Disable all cells to prevent further input during game-over
                document.querySelectorAll('.cell').forEach(cell => cell.classList.add('disabled'));
            }, 50); 

            // Hide toast and show restart overlay
            setTimeout(() => {
                DOM.resultToast.style.opacity = 0;
                
                setTimeout(() => {
                    DOM.resultToast.style.display = 'none';
                    this.showRestartOverlay(); 
                }, 300); // Wait for fade-out
                
            }, 50 + TOAST_VISIBLE_DURATION_MS);
        }

        showRestartOverlay() {
            // Build the buttons inside the overlay
            DOM.restartOverlay.innerHTML = `
                <div class="flex flex-col space-y-4 p-8 w-full max-w-xs">
                    <button id="restart-game-btn" class="game-button w-full px-6 py-3 rounded-xl text-lg font-bold">
                        <span data-ar="${i18n[state.currentLang].restart_game}" data-en="${i18n.en.restart_game}">${i18n[state.currentLang].restart_game}</span>
                    </button>
                    <button id="return-to-menu-btn-overlay" class="game-button w-full px-6 py-3 rounded-xl text-lg font-bold bg-gray-600 border-gray-500 text-white" style="box-shadow: 0 4px #444; border-color: #555;">
                        <span data-ar="${i18n[state.currentLang].end_game_menu}" data-en="${i18n.en.end_game_menu}">${i18n[state.currentLang].end_game_menu}</span>
                    </button>
                </div>
            `;
            
            // Attach listeners to the newly created buttons
            document.getElementById('restart-game-btn').addEventListener('click', () => {
                game.resetGame();
                this.startGameUI();
            });
            document.getElementById('return-to-menu-btn-overlay').addEventListener('click', () => this.showScreen('menu'));
            
            // Show the overlay and fade in
            DOM.restartOverlay.classList.remove('hidden');
            setTimeout(() => {
                DOM.restartOverlay.style.opacity = 1;
            }, 50); 
        }
    }
    const UIManager = new UIManager();
    

    // -------------------------------------
    // 7. Main Game Controller (Handles Flow)
    // -------------------------------------
    class GameController {

        static async handleUserMove(clickedCellIndex) {
            if (!game.isGameActive || game.board[clickedCellIndex] !== '' || game.isGameOver) return;

            // 1. User Move (X)
            game.board[clickedCellIndex] = 'X';
            document.getElementById(`cell-${clickedCellIndex}`).innerHTML = `<span class="marker-X">X</span>`;
            document.getElementById(`cell-${clickedCellIndex}`).classList.add('disabled'); // Disable clicked cell

            let { winner, combo } = game.checkWin(game.board);
            if (winner) return this.gameEnd(winner, combo); 
            
            game.currentPlayer = 'O';
            UIManager.updateTurnDisplay();
            game.isGameActive = false; 
            
            // 2. Ali's move after a short delay
            await new Promise(resolve => setTimeout(resolve, 700)); // Pause for realism
            this.handleRobotMove();
        }

        static async handleRobotMove() {
            if (game.isGameOver) return;
            
            const bestSpot = game.getRobotMoveIndex();
            
            if (bestSpot === -1) return this.gameEnd('Draw', null); // Should be checked by checkWin, but as safety

            // 1. Ali Move (O)
            game.board[bestSpot] = 'O';
            document.getElementById(`cell-${bestSpot}`).innerHTML = `<span class="marker-O">O</span>`;
            document.getElementById(`cell-${bestSpot}`).classList.add('disabled'); 

            // 2. Check for win
            let { winner, combo } = game.checkWin(game.board);
            if (winner) return this.gameEnd(winner, combo); 

            // 3. Continue Game
            game.currentPlayer = 'X';
            UIManager.updateTurnDisplay();
            game.isGameActive = true;
        }

        static gameEnd(winner, combo) {
            game.isGameActive = false;
            game.isGameOver = true;
            let title, message, bgColor, borderColor;
            
            if (combo) {
                UIManager.drawWinningLine(combo, winner);
            }
            
            if (winner === 'X') {
                title = i18n[state.currentLang].win_title;
                message = i18n[state.currentLang].win_message;
                bgColor = '#006400'; 
                borderColor = WIN_COLOR; 
                dataManager.updateStats('X');
            } else if (winner === 'O') {
                title = i18n[state.currentLang].lose_title;
                message = i18n[state.currentLang].lose_message;
                bgColor = '#8b0000'; 
                borderColor = LOSE_COLOR; 
                dataManager.updateStats('O');
            } else { // Draw
                title = i18n[state.currentLang].draw_title;
                message = i18n[state.currentLang].draw_message;
                bgColor = '#333333'; 
                borderColor = '#e0e0e0';
                dataManager.updateStats('Draw');
            }
            
            // Show result toast and start the overlay flow
            UIManager.showToast(title, message, bgColor, borderColor);
        }
    }

    // -------------------------------------
    // 8. Application Startup
    // -------------------------------------
    
    // Start Firebase connection and load state
    dataManager.initialize();
    
    // Telegram Web App Initialization (Optional but Recommended for better integration)
    if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        console.log("Telegram Web App initialized.");
    } else {
        console.warn("Telegram Web App environment not detected.");
    }

  </script>
</body>
</html>

